<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ClaimPilot – Claim Evaluation Memorandum</title>
  <style>
    :root{
      --fg:#111827; --muted:#6b7280; --border:#e5e7eb; --bg:#ffffff;
      --chip:#f3f4f6; --ok:#065f46; --warn:#92400e; --bad:#991b1b;
      --okbg:#ecfdf5; --warnbg:#fffbeb; --badbg:#fef2f2;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{ margin:0; padding:24px; font-family:var(--sans); color:var(--fg); background:var(--bg); }
    .page{ max-width:900px; margin:0 auto; }
    .topbar{ display:flex; justify-content:space-between; align-items:flex-start; gap:16px; padding-bottom:16px; border-bottom:1px solid var(--border); }
    .brand{ font-weight:700; letter-spacing:0.2px; }
    .subtitle{ margin-top:4px; color:var(--muted); font-size:14px; }
    .meta{ text-align:right; font-size:12px; color:var(--muted); line-height:1.4; }
    .meta code{ font-family:var(--mono); color:var(--fg); }
    h1{ font-size:20px; margin:18px 0 6px 0; }
    h2{ font-size:14px; margin:18px 0 8px 0; text-transform:uppercase; letter-spacing:0.06em; color:var(--muted); }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .card{ border:1px solid var(--border); border-radius:12px; padding:14px; }
    .row{ display:flex; justify-content:space-between; gap:12px; padding:8px 0; border-bottom:1px dashed var(--border); }
    .row:last-child{ border-bottom:none; }
    .label{ color:var(--muted); font-size:12px; }
    .value{ font-size:13px; font-weight:600; text-align:right; }
    .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .chip{ background:var(--chip); padding:4px 8px; border-radius:999px; font-size:12px; font-family:var(--mono); }
    .status{ border-radius:12px; padding:12px; border:1px solid var(--border); }
    .status.ok{ background:var(--okbg); border-color:#a7f3d0; }
    .status.warn{ background:var(--warnbg); border-color:#fcd34d; }
    .status.bad{ background:var(--badbg); border-color:#fecaca; }
    .status .headline{ font-weight:800; font-size:14px; }
    .status .desc{ margin-top:4px; font-size:13px; color:var(--muted); }
    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th, td{ text-align:left; padding:10px 8px; border-bottom:1px solid var(--border); vertical-align:top; }
    th{ font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:0.06em; }
    .pill{ display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; font-weight:700; }
    .pill.na{ background:#f3f4f6; color:#374151; }
    .pill.req{ background:#fffbeb; color:var(--warn); border:1px solid #fcd34d; }
    .pill.trig{ background:#fef2f2; color:var(--bad); border:1px solid #fecaca; }
    .mono{ font-family:var(--mono); }
    .small{ font-size:12px; color:var(--muted); }
    .foot{ margin-top:16px; padding-top:12px; border-top:1px solid var(--border); color:var(--muted); font-size:12px; line-height:1.5; }
    .kv{ display:grid; grid-template-columns: 170px 1fr; gap:6px 12px; }
    .kv div:nth-child(odd){ color:var(--muted); }
    .kv div:nth-child(even){ font-weight:600; }
    .evidence{ margin-top:10px; border-left:3px solid #fcd34d; padding-left:10px; }
    .citation{ margin-top:8px; padding:10px; background:#f9fafb; border:1px solid var(--border); border-radius:10px; }
    .citation .ref{ font-family:var(--mono); font-size:12px; }
    .citation .excerpt{ margin-top:6px; font-size:13px; color:#111827; }
    .break{ break-inside:avoid; page-break-inside:avoid; }
    @media print {
      body { padding: 12px; }
      .page { max-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="topbar">
      <div>
        <div class="brand">ClaimPilot</div>
        <div class="subtitle">Claim Evaluation Memorandum — Deterministic Policy Engine (Zero LLM)</div>
      </div>
      <div class="meta">
        <div><span class="label">Request ID</span> <code class="mono">{{ request_id }}</code></div>
        <div><span class="label">Evaluated At</span> <code class="mono">{{ evaluated_at }}</code></div>
        <div><span class="label">Engine Version</span> <code class="mono">{{ engine_version }}</code></div>
      </div>
    </div>

    <h1>{{ memo_title }}</h1>

    <div class="grid2">
      <div class="card break">
        <h2>Claim Facts</h2>
        <div class="kv">
          {% for item in claim_facts %}
            <div class="mono">{{ item.key }}</div><div>{{ item.value }}</div>
          {% endfor %}
        </div>
      </div>

      <div class="break">
        <h2>Recommendation</h2>
        {% if decision_status == "approve" %}
          <div class="status ok">
            <div class="headline">APPROVE{% if decision_note %} — {{ decision_note }}{% endif %}</div>
            <div class="desc">{{ decision_explainer }}</div>
          </div>
        {% elif decision_status == "deny" %}
          <div class="status bad">
            <div class="headline">DENY{% if decision_note %} — {{ decision_note }}{% endif %}</div>
            <div class="desc">{{ decision_explainer }}</div>
          </div>
        {% else %}
          <div class="status warn">
            <div class="headline">REQUEST INFO{% if decision_note %} — {{ decision_note }}{% endif %}</div>
            <div class="desc">{{ decision_explainer }}</div>
          </div>
        {% endif %}

        {% if exclusions_requiring_evidence and exclusions_requiring_evidence|length > 0 %}
          <div class="evidence">
            <div class="label">Additional evidence required for:</div>
            <div class="chips">
              {% for ex in exclusions_requiring_evidence %}
                <span class="chip">{{ ex.code }}</span>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="card break" style="margin-top:12px;">
      <h2>Exclusions Evaluated</h2>
      <table>
        <thead>
          <tr>
            <th style="width:140px;">Code</th>
            <th>Description</th>
            <th style="width:180px;">Result</th>
          </tr>
        </thead>
        <tbody>
          {% for ex in exclusions_evaluated %}
          <tr>
            <td class="mono">{{ ex.code }}</td>
            <td>{{ ex.name }}</td>
            <td>
              {% if ex.status == "not_applicable" %}
                <span class="pill na">NOT APPLICABLE</span>
              {% elif ex.status == "requires_evidence" %}
                <span class="pill req">NEEDS EVIDENCE</span>
              {% else %}
                <span class="pill trig">TRIGGERED</span>
              {% endif %}
              {% if ex.reason %}<div class="small" style="margin-top:6px;">{{ ex.reason }}</div>{% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      {% if evidence_requests and evidence_requests|length > 0 %}
        <h2>Evidence Requests</h2>
        <div class="small">Standardized evidence requests to resolve indeterminate exclusions.</div>
        <table style="margin-top:8px;">
          <thead>
            <tr>
              <th style="width:140px;">Exclusion</th>
              <th>Evidence to Confirm / Rule Out</th>
            </tr>
          </thead>
          <tbody>
            {% for er in evidence_requests %}
            <tr>
              <td class="mono">{{ er.exclusion_code }}</td>
              <td>
                {% if er.to_confirm and er.to_confirm|length > 0 %}
                  <div><strong>To confirm:</strong></div>
                  <ul style="margin:6px 0 10px 18px;">
                    {% for x in er.to_confirm %}<li>{{ x }}</li>{% endfor %}
                  </ul>
                {% endif %}
                {% if er.to_rule_out and er.to_rule_out|length > 0 %}
                  <div><strong>To rule out:</strong></div>
                  <ul style="margin:6px 0 0 18px;">
                    {% for x in er.to_rule_out %}<li>{{ x }}</li>{% endfor %}
                  </ul>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </div>

    <div class="card break" style="margin-top:12px;">
      <h2>Reasoning Chain</h2>
      <table>
        <thead>
          <tr>
            <th style="width:80px;">Step</th>
            <th>Explanation</th>
            <th style="width:180px;">Outcome</th>
          </tr>
        </thead>
        <tbody>
          {% for step in reasoning_steps %}
          <tr>
            <td class="mono">{{ step.step_id }}</td>
            <td>{{ step.description }}</td>
            <td class="mono">{{ step.outcome }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if authority_citations and authority_citations|length > 0 %}
    <div class="card break" style="margin-top:12px;">
      <h2>Policy Citations</h2>
      <div class="small">Cited policy wording excerpts (hash-verified).</div>
      {% for c in authority_citations %}
        <div class="citation break">
          <div class="ref">
            <strong>{{ c.section_ref }}</strong>
            &nbsp;|&nbsp; <span class="mono">{{ c.authority_ref_id }}</span>
            &nbsp;|&nbsp; Excerpt Hash: <span class="mono">{{ c.excerpt_hash }}</span>
          </div>
          {% if c.excerpt %}
            <div class="excerpt">{{ c.excerpt }}</div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
    {% endif %}

    <div class="card break" style="margin-top:12px;">
      <h2>Policy Provenance</h2>
      <div class="kv">
        <div>Policy Pack ID</div><div class="mono">{{ policy_pack_id }}</div>
        <div>Policy Pack Version</div><div class="mono">{{ policy_pack_version }}</div>
        <div>Policy Pack Hash (SHA-256)</div><div class="mono">{{ policy_pack_hash }}</div>
        {% if verification %}
          <div>Verification</div><div><strong>{{ "VALID" if verification.valid else "INVALID" }}</strong> — {{ verification.reason }}</div>
        {% endif %}
      </div>
      <div class="small" style="margin-top:8px;">
        This memorandum is deterministic and reproducible. Re-evaluating with identical inputs produces identical outputs.
      </div>
    </div>

    <div class="foot">
      <div><strong>Determinism & Auditability:</strong> ClaimPilot is a deterministic rule engine (Zero LLM). Decisions are traceable to policy wording and verifiable via cryptographic hashes.</div>
      <div style="margin-top:6px;"><strong>Verification:</strong> This recommendation can be verified using the <span class="mono">/verify</span> endpoint with the recommendation's provenance fields.</div>
    </div>
  </div>
</body>
</html>
