<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ClaimPilot – Claim Evaluation Memorandum</title>
  <style>
    :root{
      --fg:#111827; --muted:#6b7280; --border:#e5e7eb; --bg:#ffffff;
      --chip:#f3f4f6; --ok:#065f46; --warn:#92400e; --bad:#991b1b;
      --okbg:#ecfdf5; --warnbg:#fffbeb; --badbg:#fef2f2;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{ margin:0; padding:24px; font-family:var(--sans); color:var(--fg); background:var(--bg); font-size:14px; line-height:1.5; }
    .page{ max-width:900px; margin:0 auto; }
    .header{ text-align:center; padding-bottom:20px; border-bottom:2px solid var(--fg); margin-bottom:24px; }
    .header h1{ font-size:22px; margin:0 0 4px 0; font-weight:700; }
    .header .subtitle{ color:var(--muted); font-size:13px; font-style:italic; }
    h2{ font-size:15px; margin:28px 0 14px 0; padding-bottom:6px; border-bottom:1px solid var(--border); font-weight:700; }
    h2 .num{ color:var(--muted); font-weight:600; margin-right:8px; }
    h3{ font-size:13px; margin:16px 0 8px 0; font-weight:600; }
    .card{ border:1px solid var(--border); border-radius:8px; padding:16px; margin-bottom:16px; }
    .kv{ display:grid; grid-template-columns: 180px 1fr; gap:6px 16px; font-size:13px; }
    .kv .label{ color:var(--muted); }
    .kv .value{ font-weight:600; }
    .kv .value.mono{ font-family:var(--mono); font-size:12px; }
    table{ width:100%; border-collapse:collapse; font-size:12px; margin:12px 0; }
    th, td{ text-align:left; padding:8px 10px; border:1px solid var(--border); vertical-align:top; }
    th{ background:#f9fafb; font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.05em; font-weight:600; }
    .status{ border-radius:8px; padding:16px; margin:12px 0; }
    .status.ok{ background:var(--okbg); border:1px solid #a7f3d0; }
    .status.warn{ background:var(--warnbg); border:1px solid #fcd34d; }
    .status.bad{ background:var(--badbg); border:1px solid #fecaca; }
    .status h3{ margin:0 0 8px 0; font-size:16px; font-weight:700; }
    .status p{ margin:0; font-size:13px; color:var(--fg); }
    .status ul{ margin:8px 0 0 0; padding-left:20px; font-size:13px; }
    .status li{ margin:4px 0; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:600; }
    .pill.na{ background:#f3f4f6; color:#374151; }
    .pill.req{ background:#fffbeb; color:var(--warn); }
    .pill.trig{ background:#fef2f2; color:var(--bad); }
    .pill.pass{ background:#ecfdf5; color:var(--ok); }
    .mono{ font-family:var(--mono); }
    .small{ font-size:11px; color:var(--muted); }
    .note{ font-size:12px; color:var(--muted); font-style:italic; margin:8px 0; }
    .provenance{ background:#f9fafb; border:1px solid var(--border); border-radius:8px; padding:16px; }
    .provenance .hash{ word-break:break-all; font-size:11px; }
    .statement{ background:#f0f9ff; border:1px solid #bae6fd; border-radius:8px; padding:16px; margin:16px 0; font-size:13px; }
    .statement ul{ margin:8px 0 0 0; padding-left:20px; }
    .statement li{ margin:4px 0; }
    .info-required{ background:#fffbeb; border:1px solid #fcd34d; border-radius:8px; padding:16px; margin:12px 0; }
    .info-required h4{ margin:0 0 8px 0; font-size:13px; color:var(--warn); font-weight:600; }
    .info-required ul{ margin:0; padding-left:20px; font-size:13px; }
    .info-required li{ margin:4px 0; }
    .foot{ margin-top:24px; padding-top:16px; border-top:2px solid var(--fg); color:var(--muted); font-size:11px; text-align:center; }
    .break{ break-inside:avoid; page-break-inside:avoid; }
    hr.section-end{ border:none; border-top:1px solid var(--border); margin:20px 0; }
    @media print {
      body { padding: 12px; font-size:12px; }
      .page { max-width: 100%; }
      .status, .provenance, .statement, .info-required { break-inside: avoid; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="header">
      <h1>Claim Evaluation Memorandum</h1>
      <div class="subtitle">Deterministic Insurance Policy Engine (Zero-LLM Core)</div>
    </div>

    <!-- Section 1: Administrative Details -->
    <h2><span class="num">1.</span>Administrative Details</h2>
    <div class="card break">
      <div class="kv">
        <div class="label">Request ID</div>
        <div class="value mono">{{ request_id }}</div>
        <div class="label">Claim ID</div>
        <div class="value mono">{{ claim_id }}</div>
        <div class="label">Line of Business</div>
        <div class="value">{{ line_of_business or 'Insurance' }}</div>
        <div class="label">Jurisdiction</div>
        <div class="value mono">{{ jurisdiction or 'CA-ON' }}</div>
        <div class="label">Policy ID</div>
        <div class="value mono">{{ policy_pack_id }}</div>
        <div class="label">Policy Version</div>
        <div class="value mono">{{ policy_pack_version }}</div>
        <div class="label">Evaluated At (UTC)</div>
        <div class="value mono">{{ evaluated_at }}</div>
        <div class="label">Engine Version</div>
        <div class="value mono">{{ engine_version }}</div>
        <div class="label">Decision Status</div>
        <div class="value">{{ decision_status_label or 'provisional' }}</div>
        <div class="label">Certainty Level</div>
        <div class="value">{{ certainty_level }}</div>
      </div>
    </div>
    <hr class="section-end">

    <!-- Section 2: Claim Facts -->
    <h2><span class="num">2.</span>Claim Facts (Structured Inputs)</h2>
    <p class="note">All facts were supplied via structured systems and validated input controls. No free-text interpretation was used.</p>
    <table class="break">
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        {% for fact in claim_facts %}
        <tr>
          <td>{{ fact.field }}</td>
          <td class="mono">{{ fact.value }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <hr class="section-end">

    <!-- Section 3: Coverage Evaluation Summary -->
    <h2><span class="num">3.</span>Coverage Evaluation Summary</h2>
    <p style="font-size:13px; color:var(--muted); margin-bottom:12px;"><strong>Current Recommendation:</strong></p>
    {% if decision_status == "approve" %}
      <div class="status ok break">
        <h3>PAY</h3>
        <p><strong>Decision Rationale:</strong></p>
        <ul>
          <li>Coverage evaluation completed under the active policy pack</li>
          <li>No exclusions triggered based on the supplied facts</li>
          {% if decision_note %}<li>{{ decision_note }}</li>{% endif %}
        </ul>
      </div>
    {% elif decision_status == "deny" %}
      <div class="status bad break">
        <h3>DENY</h3>
        <p><strong>Decision Rationale:</strong></p>
        <ul>
          <li>Coverage evaluation completed under the active policy pack</li>
          <li>{{ decision_explainer }}</li>
          {% if exclusions_triggered and exclusions_triggered|length > 0 %}
            {% for ex in exclusions_triggered %}
              <li>Exclusion <strong>{{ ex.code }}</strong> triggered: {{ ex.name }}</li>
            {% endfor %}
          {% endif %}
        </ul>
      </div>
    {% elif decision_status == "escalate" or decision_status == "review" %}
      <div class="status warn break">
        <h3>ESCALATE</h3>
        <p><strong>Decision Rationale:</strong></p>
        <ul>
          <li>Coverage evaluation completed under the active policy pack</li>
          <li>One or more internal review or escalation conditions were triggered</li>
          <li>{{ decision_explainer }}</li>
          <li>No final coverage determination issued at this stage</li>
        </ul>
      </div>
    {% else %}
      <div class="status warn break">
        <h3>REQUEST ADDITIONAL INFORMATION</h3>
        <p><strong>Decision Rationale:</strong></p>
        <ul>
          <li>Coverage evaluation completed under the active policy pack</li>
          <li>One or more exclusions require additional evidence for determination</li>
          <li>No final coverage determination issued at this stage</li>
        </ul>
      </div>
    {% endif %}
    <hr class="section-end">

    <!-- Section 4: Exclusions & Conditions Evaluated -->
    <h2><span class="num">4.</span>Exclusions & Conditions Evaluated</h2>
    <table class="break">
      <thead>
        <tr>
          <th style="width:100px;">Code</th>
          <th>Description</th>
          <th style="width:140px;">Result</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        {% for ex in exclusions_evaluated %}
        <tr>
          <td class="mono">{{ ex.code }}</td>
          <td>{{ ex.name or ex.description }}</td>
          <td>
            {% if ex.status == "triggered" or ex.evaluation_result == "TRIGGERED" %}
              <span class="pill trig">TRIGGERED</span>
            {% elif ex.status == "requires_evidence" %}
              <span class="pill req">PENDING</span>
            {% else %}
              <span class="pill pass">NOT TRIGGERED</span>
            {% endif %}
          </td>
          <td class="small">{{ ex.notes or '' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <p class="note">"NOT TRIGGERED" indicates the condition was evaluated and did not apply based on the current facts.</p>
    <hr class="section-end">

    <!-- Section 5: Reasoning Chain -->
    <h2><span class="num">5.</span>Reasoning Chain (Deterministic)</h2>
    <table class="break">
      <thead>
        <tr>
          <th style="width:50px;">Step</th>
          <th>Evaluation Action</th>
          <th style="width:100px;">Outcome</th>
        </tr>
      </thead>
      <tbody>
        {% for step in reasoning_steps %}
        <tr>
          <td class="mono">{{ step.step_id or step.step }}</td>
          <td>{{ step.action }}</td>
          <td>
            {% if step.outcome == "PASS" or step.outcome == "PASSED" %}
              <span class="pill pass">PASS</span>
            {% elif step.outcome == "WARN" %}
              <span class="pill req">WARN</span>
            {% elif step.outcome == "FAIL" %}
              <span class="pill trig">FAIL</span>
            {% else %}
              <span class="pill na">{{ step.outcome }}</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <hr class="section-end">

    <!-- Section 6: Precedent Analysis -->
    {% if precedent_matches and precedent_matches|length > 0 %}
    <h2><span class="num">6.</span>Precedent Analysis (Historical Consistency Check)</h2>
    <p class="note">Historical precedents were queried using privacy-preserving fingerprints derived from exclusion-relevant facts only.</p>

    {% if precedent_summary %}
    <h3>Precedent Summary</h3>
    <div class="card break">
      <ul style="margin:0; padding-left:20px; font-size:13px;">
        <li><strong>Similar cases found:</strong> {{ precedent_summary.total_similar }}</li>
        <li><strong>Top similarity score:</strong> {{ (precedent_summary.top_similarity * 100)|round|int }}%</li>
        <li><strong>Outcome distribution:</strong>
          <ul style="margin:4px 0 0 0;">
            <li>PAY: {{ precedent_heat_map.pay_count if precedent_heat_map else 0 }}</li>
            <li>DENY: {{ precedent_heat_map.deny_count if precedent_heat_map else 0 }}</li>
          </ul>
        </li>
        {% if precedent_heat_map %}
        <li><strong>Challenge / Appeal activity:</strong>
          <ul style="margin:4px 0 0 0;">
            <li>{{ precedent_heat_map.appeal_pct }}% challenged</li>
            <li>{{ precedent_heat_map.overturn_pct }}% overturned</li>
          </ul>
        </li>
        {% endif %}
      </ul>
      <div style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border); font-size:12px;">
        <strong>Precedent Confidence:</strong> {{ precedent_summary.confidence_level }} ({{ precedent_summary.precedent_confidence }})
        &nbsp;|&nbsp;
        <strong>Decision Support:</strong> {{ precedent_summary.decision_support }}
      </div>
    </div>

    {% if precedent_summary.caution_message %}
    <div class="status warn break">
      <h3 style="font-size:13px; margin:0 0 4px 0;">⚠ Precedent Risk Notice</h3>
      <p>{{ precedent_summary.caution_message }}</p>
    </div>
    {% endif %}
    {% endif %}
    <hr class="section-end">

    <!-- Section 7: Similar Cases -->
    <h2><span class="num">7.</span>Similar Cases (Anonymized)</h2>
    <table class="break">
      <thead>
        <tr>
          <th>Precedent ID</th>
          <th>Date</th>
          <th style="width:80px;">Similarity</th>
          <th style="width:70px;">Outcome</th>
          <th>Decision Level</th>
          <th>Review / Appeal</th>
        </tr>
      </thead>
      <tbody>
        {% for match in precedent_matches[:6] %}
        <tr{% if match.appeal_outcome == "Overturned" %} style="background:#fef2f2;"{% endif %}>
          <td class="mono">{{ match.case_id }}</td>
          <td class="mono">{{ match.case_date }}</td>
          <td>{{ (match.similarity * 100)|round|int }}%</td>
          <td>
            {% if match.outcome == "DENY" %}
              <span class="pill trig" style="font-size:10px;">DENY</span>
            {% else %}
              <span class="pill pass" style="font-size:10px;">PAY</span>
            {% endif %}
            {% if match.appeal_outcome == "Overturned" %}
              <span style="font-size:9px; color:var(--warn);">⚠</span>
            {% endif %}
          </td>
          <td class="small">{{ match.decision_level }}</td>
          <td class="small">{{ match.appeal_outcome if match.appealed else '—' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if precedent_matches[0].matched_anchors %}
    <div style="margin-top:12px; padding:12px; background:#f9fafb; border-radius:6px; font-size:12px;">
      <strong>Match Basis (Top Match):</strong>
      <div style="margin-top:8px;">
        <strong style="color:#0369a1;">Primary:</strong>
        {% for anchor in precedent_matches[0].matched_anchors[:2] %}
          <code class="mono" style="background:#e0f2fe; color:#0369a1; padding:2px 6px; border-radius:3px; margin-left:4px; font-size:10px;">{{ anchor }}</code>
        {% endfor %}
      </div>
      {% if precedent_matches[0].matched_anchors|length > 2 %}
      <div style="margin-top:6px;">
        <strong style="color:#6b7280;">Secondary:</strong>
        {% for anchor in precedent_matches[0].matched_anchors[2:] %}
          <code class="mono" style="background:#f3f4f6; color:#374151; padding:2px 6px; border-radius:3px; margin-left:4px; font-size:10px;">{{ anchor }}</code>
        {% endfor %}
      </div>
      {% endif %}
      {% if precedent_matches[0].key_differences %}
      <div style="margin-top:8px; padding-top:8px; border-top:1px solid #e5e7eb;">
        <strong style="color:#92400e;">Key Differences:</strong>
        {% for diff in precedent_matches[0].key_differences %}
          <code class="mono" style="background:#fef3c7; color:#92400e; padding:2px 6px; border-radius:3px; margin-left:4px; font-size:10px;">{{ diff }}</code>
        {% endfor %}
      </div>
      {% endif %}
    </div>
    {% endif %}
    <hr class="section-end">
    {% endif %}

    <!-- Section 8: Information Required (if applicable) -->
    {% if decision_status == "request_info" or (unresolved_exclusions and unresolved_exclusions|length > 0) or (evidence_requests and evidence_requests|length > 0) %}
    <h2><span class="num">{% if precedent_matches and precedent_matches|length > 0 %}8{% else %}6{% endif %}.</span>Information Required</h2>
    <div class="info-required break">
      <h4>To resolve the outstanding review condition(s), the following information is required:</h4>
      <ul>
        {% if evidence_requests %}
          {% for er in evidence_requests %}
            <li>{{ er.exclusion_name }}: {{ er.purpose or 'Documentation required' }}</li>
          {% endfor %}
        {% elif unresolved_exclusions %}
          {% for ex in unresolved_exclusions %}
            <li>{{ ex.name }}: Evidence to confirm or rule out applicability</li>
          {% endfor %}
        {% else %}
          <li>Additional documentation as specified by claims handler</li>
        {% endif %}
      </ul>
      <p class="small" style="margin-top:12px;">No final denial has been issued at this stage.</p>
    </div>
    <hr class="section-end">
    {% endif %}

    <!-- Section 9: Policy Provenance & Integrity -->
    <h2><span class="num">{% if precedent_matches and precedent_matches|length > 0 %}9{% else %}7{% endif %}.</span>Policy Provenance & Integrity</h2>
    <div class="provenance break">
      <div class="kv">
        <div class="label">Policy Pack ID</div>
        <div class="value mono">{{ policy_pack_id }}</div>
        <div class="label">Policy Pack Version</div>
        <div class="value mono">{{ policy_pack_version }}</div>
        <div class="label">Policy Pack Hash</div>
        <div class="value mono hash">{{ policy_pack_hash }}</div>
        <div class="label">Hash Scheme</div>
        <div class="value mono">SHA-256 (RFC 8785 Canonical JSON)</div>
      </div>
      <p class="small" style="margin-top:12px;">
        This recommendation is cryptographically bound to the exact policy wording evaluated at decision time.
      </p>
    </div>
    <hr class="section-end">

    <!-- Section 10: Determinism & Auditability Statement -->
    <h2><span class="num">{% if precedent_matches and precedent_matches|length > 0 %}10{% else %}8{% endif %}.</span>Determinism & Auditability Statement</h2>
    <div class="statement break">
      <p style="margin:0 0 12px 0;">This claim evaluation was produced by a <strong>deterministic rules-based insurance engine</strong>.</p>
      <ul>
        <li>No probabilistic or generative AI was used in coverage determination</li>
        <li>Re-evaluation using identical inputs and the same policy pack will produce <strong>identical results</strong></li>
        <li>All evaluations are reproducible and independently verifiable</li>
      </ul>
      <p style="margin:12px 0 0 0; font-size:12px; color:var(--muted);">
        Verification may be performed using the recorded provenance fields and the <code class="mono">/verify</code> endpoint.
      </p>
    </div>

    <!-- Footer -->
    <div class="foot">
      <strong>End of Memorandum</strong><br>
      <span style="margin-top:8px; display:inline-block;">ClaimPilot — Deterministic • Reproducible • Auditable</span><br>
      Generated {{ evaluated_at }}
    </div>
  </div>
</body>
</html>
