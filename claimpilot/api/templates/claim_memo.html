<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ClaimPilot – Claim Evaluation Memorandum</title>
  <style>
    :root{
      --fg:#111827; --muted:#6b7280; --border:#e5e7eb; --bg:#ffffff;
      --chip:#f3f4f6; --ok:#065f46; --warn:#92400e; --bad:#991b1b;
      --okbg:#ecfdf5; --warnbg:#fffbeb; --badbg:#fef2f2;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{ margin:0; padding:24px; font-family:var(--sans); color:var(--fg); background:var(--bg); }
    .page{ max-width:900px; margin:0 auto; }
    .header{ text-align:center; padding-bottom:20px; border-bottom:2px solid var(--fg); margin-bottom:24px; }
    .header h1{ font-size:24px; margin:0 0 4px 0; }
    .header .subtitle{ color:var(--muted); font-size:14px; }
    h2{ font-size:16px; margin:24px 0 12px 0; padding-bottom:6px; border-bottom:1px solid var(--border); }
    h3{ font-size:14px; margin:16px 0 8px 0; }
    .card{ border:1px solid var(--border); border-radius:8px; padding:16px; margin-bottom:16px; }
    .kv{ display:grid; grid-template-columns: 180px 1fr; gap:8px 16px; font-size:14px; }
    .kv .label{ color:var(--muted); }
    .kv .value{ font-weight:600; }
    .kv .value.mono{ font-family:var(--mono); font-size:13px; }
    table{ width:100%; border-collapse:collapse; font-size:13px; margin:12px 0; }
    th, td{ text-align:left; padding:10px 12px; border:1px solid var(--border); vertical-align:top; }
    th{ background:#f9fafb; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:0.05em; font-weight:600; }
    .status{ border-radius:8px; padding:16px; margin:12px 0; }
    .status.ok{ background:var(--okbg); border:1px solid #a7f3d0; }
    .status.warn{ background:var(--warnbg); border:1px solid #fcd34d; }
    .status.bad{ background:var(--badbg); border:1px solid #fecaca; }
    .status h3{ margin:0 0 8px 0; font-size:15px; }
    .status p{ margin:0; font-size:14px; color:var(--fg); }
    .status ul{ margin:8px 0 0 0; padding-left:20px; }
    .status li{ margin:4px 0; }
    .pill{ display:inline-block; padding:3px 10px; border-radius:999px; font-size:12px; font-weight:600; }
    .pill.na{ background:#f3f4f6; color:#374151; }
    .pill.req{ background:#fffbeb; color:var(--warn); }
    .pill.trig{ background:#fef2f2; color:var(--bad); }
    .pill.pass{ background:#ecfdf5; color:var(--ok); }
    .mono{ font-family:var(--mono); }
    .small{ font-size:12px; color:var(--muted); }
    .evidence-block{ background:#fffbeb; border:1px solid #fcd34d; border-radius:8px; padding:16px; margin:12px 0; }
    .evidence-block h4{ margin:0 0 8px 0; font-size:14px; color:var(--warn); }
    .evidence-block .purpose{ font-style:italic; color:var(--muted); margin-bottom:12px; font-size:13px; }
    .evidence-block h5{ margin:12px 0 6px 0; font-size:13px; font-weight:600; }
    .evidence-block ul{ margin:0; padding-left:20px; font-size:13px; }
    .evidence-block li{ margin:4px 0; }
    .provenance{ background:#f9fafb; border:1px solid var(--border); border-radius:8px; padding:16px; }
    .provenance .hash{ word-break:break-all; font-size:12px; }
    .statement{ background:#f0f9ff; border:1px solid #bae6fd; border-radius:8px; padding:16px; margin:16px 0; font-size:14px; }
    .compliance{ background:#fefce8; border:1px solid #fde047; border-radius:8px; padding:16px; margin:16px 0; font-size:14px; }
    .foot{ margin-top:24px; padding-top:16px; border-top:1px solid var(--border); color:var(--muted); font-size:12px; text-align:center; }
    .break{ break-inside:avoid; page-break-inside:avoid; }
    @media print {
      body { padding: 12px; }
      .page { max-width: 100%; }
      .status, .evidence-block, .provenance, .statement, .compliance { break-inside: avoid; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="header">
      <h1>Claim Evaluation Memorandum</h1>
      <div class="subtitle">Deterministic Policy Engine (Zero LLM)</div>
    </div>

    <h2>Administrative Details</h2>
    <div class="card break">
      <div class="kv">
        <div class="label">Request ID</div>
        <div class="value mono">{{ request_id }}</div>
        <div class="label">Claim ID</div>
        <div class="value mono">{{ claim_id }}</div>
        <div class="label">Policy ID</div>
        <div class="value mono">{{ policy_pack_id }}</div>
        <div class="label">Policy Version</div>
        <div class="value mono">{{ policy_pack_version }}</div>
        <div class="label">Evaluated At</div>
        <div class="value mono">{{ evaluated_at }}</div>
        <div class="label">Engine Version</div>
        <div class="value mono">{{ engine_version }}</div>
        <div class="label">Certainty Level</div>
        <div class="value">{{ certainty_level }}</div>
      </div>
    </div>

    <h2>Claim Facts</h2>
    <table class="break">
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        {% for fact in claim_facts %}
        <tr>
          <td>{{ fact.field }}</td>
          <td class="mono">{{ fact.value }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <h2>Recommendation</h2>
    {% if decision_status == "approve" %}
      <div class="status ok break">
        <h3>APPROVE{% if decision_note %} — {{ decision_note }}{% endif %}</h3>
        <p>{{ decision_explainer }}</p>
      </div>
    {% elif decision_status == "deny" %}
      <div class="status bad break">
        <h3>DENY{% if decision_note %} — {{ decision_note }}{% endif %}</h3>
        <p>{{ decision_explainer }}</p>
        {% if exclusions_triggered and exclusions_triggered|length > 0 %}
          <p style="margin-top:12px;"><strong>Exclusions triggered:</strong></p>
          <ul>
            {% for ex in exclusions_triggered %}
              <li><strong>{{ ex.code }}</strong> — {{ ex.name }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
    {% else %}
      <div class="status warn break">
        <h3>REQUEST ADDITIONAL INFORMATION</h3>
        <p>{{ decision_explainer }}</p>
        {% if unresolved_exclusions and unresolved_exclusions|length > 0 %}
          <p style="margin-top:12px;"><strong>Unresolved exclusions requiring additional evidence:</strong></p>
          <ul>
            {% for ex in unresolved_exclusions %}
              <li><strong>{{ ex.code }}</strong> — {{ ex.name }}</li>
            {% endfor %}
          </ul>
        {% endif %}
        <p class="small" style="margin-top:12px;">No denial has been issued at this stage.</p>
      </div>
    {% endif %}

    <h2>Exclusions Evaluated</h2>
    <table class="break">
      <thead>
        <tr>
          <th style="width:80px;">Code</th>
          <th>Description</th>
          <th style="width:180px;">Evaluation Result</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        {% for ex in exclusions_evaluated %}
        <tr>
          <td class="mono">{{ ex.code }}</td>
          <td>{{ ex.name }}</td>
          <td>
            {% if ex.status == "not_applicable" %}
              <span class="pill na">Not Applicable</span>
            {% elif ex.status == "requires_evidence" %}
              <span class="pill req">Additional Evidence Required</span>
            {% else %}
              <span class="pill trig">Triggered</span>
            {% endif %}
          </td>
          <td class="small">{{ ex.notes or '' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if evidence_requests and evidence_requests|length > 0 %}
    <h2>Evidence Requests</h2>
    <p class="small">The following standardized evidence is required to resolve indeterminate exclusions.</p>

    {% for er in evidence_requests %}
    <div class="evidence-block break">
      <h4>Exclusion {{ er.exclusion_code }} — {{ er.exclusion_name }}</h4>
      <div class="purpose">{{ er.purpose }}</div>

      {% if er.to_confirm and er.to_confirm|length > 0 %}
      <h5>Evidence to Confirm Applicability</h5>
      <ul>
        {% for item in er.to_confirm %}
          <li>{{ item }}</li>
        {% endfor %}
      </ul>
      {% endif %}

      {% if er.to_rule_out and er.to_rule_out|length > 0 %}
      <h5>Evidence to Rule Out Applicability</h5>
      <ul>
        {% for item in er.to_rule_out %}
          <li>{{ item }}</li>
        {% endfor %}
      </ul>
      {% endif %}
    </div>
    {% endfor %}
    {% endif %}

    <h2>Reasoning Chain</h2>
    <table class="break">
      <thead>
        <tr>
          <th style="width:60px;">Step</th>
          <th>Evaluation Action</th>
          <th style="width:140px;">Outcome</th>
        </tr>
      </thead>
      <tbody>
        {% for step in reasoning_steps %}
        <tr>
          <td class="mono">{{ step.step_id }}</td>
          <td>{{ step.action }}</td>
          <td>
            {% if step.outcome == "PASSED" %}
              <span class="pill pass">Passed</span>
            {% elif step.outcome == "INDETERMINATE" %}
              <span class="pill req">Indeterminate</span>
            {% elif step.outcome == "NOT_APPLICABLE" %}
              <span class="pill na">Not Applicable</span>
            {% else %}
              <span class="pill trig">{{ step.outcome }}</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if precedent_matches and precedent_matches|length > 0 %}
    <h2>Precedent Analysis</h2>

    {% if precedent_summary %}
    <div class="card break" style="background:#f0f9ff; border-color:#bae6fd;">
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px;">
        <div>
          <strong style="font-size:14px;">{{ precedent_summary.total_similar }} Similar Cases Found</strong>
          <p class="small" style="margin:4px 0 0 0;">
            Exclusion: <code class="mono">{{ precedent_summary.exclusion_code or 'N/A' }}</code> |
            Top Match: {{ (precedent_summary.top_similarity * 100)|round|int }}% similarity
          </p>
        </div>
        <div style="text-align:right;">
          {% if precedent_summary.consistent_outcome %}
          <span class="pill pass" style="font-size:11px;">Consistent Outcomes</span>
          {% else %}
          <span class="pill req" style="font-size:11px;">Mixed Outcomes</span>
          {% endif %}
          <div style="margin-top:6px; font-size:11px; color:var(--muted);">
            Confidence: <strong>{{ precedent_summary.confidence_level }}</strong> ({{ precedent_summary.precedent_confidence }})
          </div>
        </div>
      </div>
      <div style="margin-top:12px; padding-top:12px; border-top:1px solid #bae6fd; font-size:13px;">
        <strong>Decision Support:</strong> {{ precedent_summary.decision_support }}
      </div>
    </div>

    {% if precedent_summary.caution_message %}
    <div class="status warn break" style="margin-top:12px;">
      <h3 style="margin:0 0 4px 0; font-size:13px;">⚠ Precedent Risk</h3>
      <p style="margin:0; font-size:13px;">{{ precedent_summary.caution_message }}</p>
    </div>
    {% endif %}
    {% endif %}

    {% if precedent_heat_map %}
    <h3>Outcome Distribution (Heat Map)</h3>
    <div class="card break">
      <div style="display:flex; gap:24px; flex-wrap:wrap;">
        <!-- Outcome bar -->
        <div style="flex:1; min-width:200px;">
          <div style="margin-bottom:8px; font-size:13px; font-weight:600;">Decision Outcomes</div>
          <div style="display:flex; height:24px; border-radius:4px; overflow:hidden; border:1px solid var(--border);">
            <div style="width:{{ precedent_heat_map.deny_pct }}%; background:#fecaca; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:600; color:#991b1b;">
              {% if precedent_heat_map.deny_pct > 15 %}DENY {{ precedent_heat_map.deny_pct }}%{% endif %}
            </div>
            <div style="width:{{ precedent_heat_map.pay_pct }}%; background:#a7f3d0; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:600; color:#065f46;">
              {% if precedent_heat_map.pay_pct > 15 %}PAY {{ precedent_heat_map.pay_pct }}%{% endif %}
            </div>
          </div>
          <div style="display:flex; justify-content:space-between; margin-top:6px; font-size:11px; color:var(--muted);">
            <span>{{ precedent_heat_map.deny_count }} denials</span>
            <span>{{ precedent_heat_map.pay_count }} approvals</span>
          </div>
        </div>
        <!-- Appeal stats -->
        <div style="min-width:160px;">
          <div style="margin-bottom:8px; font-size:13px; font-weight:600;">Appeal Activity</div>
          <div style="font-size:24px; font-weight:700; color:var(--fg);">{{ precedent_heat_map.appeal_pct }}%</div>
          <div style="font-size:12px; color:var(--muted);">appealed ({{ precedent_heat_map.appeal_count }} cases)</div>
          {% if precedent_heat_map.appeal_count > 0 %}
          <div style="margin-top:8px; font-size:12px;">
            <span style="color:var(--bad);">{{ precedent_heat_map.overturn_pct }}% overturned</span>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    <h3>Similar Cases</h3>
    <table class="break">
      <thead>
        <tr>
          <th>Case ID</th>
          <th>Date</th>
          <th style="width:90px;">Similarity</th>
          <th style="width:90px;">Outcome</th>
          <th>Level</th>
          <th>Challenge</th>
        </tr>
      </thead>
      <tbody>
        {% for match in precedent_matches[:6] %}
        <tr{% if match.appeal_outcome == "Overturned" %} style="background:#fef2f2;"{% endif %}>
          <td class="mono">{{ match.case_id }}</td>
          <td class="mono">{{ match.case_date }}</td>
          <td>
            <div style="display:flex; align-items:center; gap:6px;">
              <div style="flex:1; height:6px; background:#e5e7eb; border-radius:3px; overflow:hidden;">
                <div style="width:{{ (match.similarity * 100)|round|int }}%; height:100%; background:{% if match.similarity >= 0.9 %}#10b981{% elif match.similarity >= 0.8 %}#f59e0b{% else %}#6b7280{% endif %};"></div>
              </div>
              <span style="font-size:11px; font-weight:600;">{{ (match.similarity * 100)|round|int }}%</span>
            </div>
          </td>
          <td>
            {% if match.outcome == "DENY" %}
              <span class="pill trig" style="font-size:10px;">DENY</span>
            {% else %}
              <span class="pill pass" style="font-size:10px;">PAY</span>
            {% endif %}
            {% if match.appeal_outcome == "Overturned" %}
              <span class="pill req" style="font-size:9px; margin-left:2px;">⚠ Overturned</span>
            {% endif %}
          </td>
          <td class="small">{{ match.decision_level }}</td>
          <td class="small">
            {% if match.appealed %}
              {{ match.appeal_outcome }}
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
        {% if match.matched_anchors %}
        <tr style="background:#f9fafb;">
          <td colspan="6" style="padding:6px 12px; font-size:11px; border-top:none;">
            <span style="color:var(--muted);">Match factors:</span>
            {% for anchor in match.matched_anchors %}
              <code style="background:#e0f2fe; color:#0369a1; padding:1px 4px; border-radius:3px; margin-left:4px; font-size:10px;">{{ anchor }}</code>
            {% endfor %}
            {% if match.key_differences %}
              <span style="color:var(--muted); margin-left:8px;">| Differs:</span>
              {% for diff in match.key_differences %}
                <code style="background:#fef3c7; color:#92400e; padding:1px 4px; border-radius:3px; margin-left:4px; font-size:10px;">{{ diff }}</code>
              {% endfor %}
            {% endif %}
          </td>
        </tr>
        {% endif %}
        {% if match.overturn_reason %}
        <tr style="background:#fef2f2;">
          <td colspan="6" style="padding:6px 12px; font-size:11px; border-top:none; color:var(--bad);">
            <strong>Overturn reason:</strong> {{ match.overturn_reason }}
          </td>
        </tr>
        {% endif %}
        {% endfor %}
      </tbody>
    </table>
    <p class="small" style="margin-top:8px;">
      Precedent matching uses privacy-preserving fingerprints. Case IDs are anonymized references. Challenge activity includes internal disputes, ombudsman cases, and litigation.
    </p>
    {% endif %}

    <h2>Policy Provenance</h2>
    <div class="provenance break">
      <div class="kv">
        <div class="label">Policy Pack ID</div>
        <div class="value mono">{{ policy_pack_id }}</div>
        <div class="label">Policy Pack Version</div>
        <div class="value mono">{{ policy_pack_version }}</div>
        <div class="label">Hash Scheme</div>
        <div class="value mono">{{ policy_pack_hash_scheme or 'sha256:rfc8785' }}</div>
        <div class="label">Policy Pack Hash</div>
        <div class="value mono hash">{{ policy_pack_hash }}</div>
      </div>
      <p class="small" style="margin-top:12px;">
        This recommendation is cryptographically bound to the exact policy wording evaluated at decision time.
      </p>
    </div>

    <div class="statement break">
      <strong>Determinism & Auditability Statement</strong><br><br>
      This claim evaluation was produced by a deterministic rule engine.
      Re-evaluation using identical inputs and the same policy pack will produce identical results.<br><br>
      The recommendation may be independently verified using the <code class="mono">/verify</code> endpoint and the recorded provenance fields.
    </div>

    {% if decision_status == "request_info" %}
    <div class="compliance break">
      <strong>Compliance Note</strong><br><br>
      No coverage denial has been issued.
      Outstanding exclusions are explicitly identified and require documentary resolution prior to final disposition.
    </div>
    {% endif %}

    <div class="foot">
      <strong>ClaimPilot</strong> — Deterministic • Reproducible • Auditable<br>
      Generated {{ evaluated_at }}
    </div>
  </div>
</body>
</html>
