<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DecisionGraph - AML/KYC Decision Report</title>
  <style>
    :root{
      --fg:#111827; --muted:#374151; --border:#d1d5db; --bg:#ffffff;
      --chip:#f3f4f6; --ok:#065f46; --warn:#92400e; --bad:#991b1b;
      --okbg:#ecfdf5; --warnbg:#fffbeb; --badbg:#fef2f2;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{ margin:0; padding:24px; font-family:var(--sans); color:var(--fg); background:var(--bg); }
    .page{ max-width:900px; margin:0 auto; }
    .header{ text-align:center; padding-bottom:20px; border-bottom:2px solid var(--fg); margin-bottom:24px; }
    .header h1{ font-size:24px; margin:0 0 4px 0; }
    .header .subtitle{ color:var(--muted); font-size:14px; }
    h2{ font-size:16px; margin:24px 0 12px 0; padding-bottom:6px; border-bottom:1px solid var(--border); }
    h3{ font-size:14px; margin:16px 0 8px 0; }
    .card{ border:1px solid var(--border); border-radius:8px; padding:16px; margin-bottom:16px; }
    .kv{ display:grid; grid-template-columns: 180px 1fr; gap:8px 16px; font-size:14px; }
    .kv .label{ color:var(--muted); }
    .kv .value{ font-weight:600; overflow-wrap:break-word; word-wrap:break-word; }
    .kv .value.mono{ font-family:var(--mono); font-size:13px; }
    table{ width:100%; border-collapse:collapse; font-size:13px; margin:12px 0; }
    th, td{ text-align:left; padding:10px 12px; border:1px solid var(--border); vertical-align:top; overflow-wrap:break-word; word-wrap:break-word; }
    th{ background:#f9fafb; font-size:12px; color:#1f2937; text-transform:uppercase; letter-spacing:0.05em; font-weight:600; }
    .status{ border-radius:8px; padding:16px; margin:12px 0; }
    .status.ok{ background:var(--okbg); border:1px solid #a7f3d0; }
    .status.warn{ background:var(--warnbg); border:1px solid #fcd34d; }
    .status.bad{ background:var(--badbg); border:1px solid #fecaca; }
    .status h3{ margin:0 0 8px 0; font-size:15px; }
    .status p{ margin:0; font-size:14px; color:var(--fg); }
    .status ul{ margin:8px 0 0 0; padding-left:20px; }
    .status li{ margin:4px 0; }
    .pill{ display:inline-block; padding:3px 10px; border-radius:999px; font-size:12px; font-weight:600; }
    .pill.na{ background:#f3f4f6; color:#374151; }
    .pill.req{ background:#fffbeb; color:var(--warn); }
    .pill.trig{ background:#fef2f2; color:var(--bad); }
    .pill.pass{ background:#ecfdf5; color:var(--ok); }
    .mono{ font-family:var(--mono); }
    .small{ font-size:13px; color:var(--muted); }
    .gate-block{ background:#f9fafb; border:1px solid var(--border); border-radius:8px; padding:16px; margin:12px 0; }
    .gate-block h4{ margin:0 0 12px 0; font-size:14px; display:flex; align-items:center; gap:8px; }
    .gate-section{ display:flex; align-items:flex-start; gap:8px; padding:8px 0; border-bottom:1px solid var(--border); }
    .gate-section:last-child{ border-bottom:none; }
    .gate-section .section-name{ font-weight:600; font-size:13px; }
    .gate-section .section-reason{ font-size:13px; color:var(--muted); margin-top:2px; }
    .provenance{ background:#f9fafb; border:1px solid var(--border); border-radius:8px; padding:16px; }
    .provenance .hash{ word-break:break-all; font-size:13px; color:#111827; }
    .statement{ background:#f0f9ff; border:1px solid #bae6fd; border-radius:8px; padding:16px; margin:16px 0; font-size:14px; }
    .regulatory{ background:#fefce8; border:1px solid #fde047; border-radius:8px; padding:16px; margin:16px 0; font-size:14px; }
    .foot{ margin-top:24px; padding-top:16px; border-top:1px solid var(--border); color:#374151; font-size:13px; text-align:center; }
    .break{ break-inside:avoid; page-break-inside:avoid; }
    .bar{ height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
    .bar > span{ display:block; height:100%; background:#1f2937; }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:700; background:#ecfdf5; color:#065f46; }
    .schema-panel{ border:1px solid var(--border); border-radius:8px; padding:12px; background:#f9fafb; font-size:12px; margin:16px 0; }
    .schema-panel ul{ margin:8px 0 0 18px; padding:0; }
    .schema-panel li{ margin:2px 0; }
    /* Precedent match cards */
    .match-grid{ display:grid; gap:12px; margin:12px 0; }
    .match-card{ border:1px solid var(--border); border-radius:8px; padding:16px; break-inside:avoid; }
    .match-card.below-threshold{ opacity:0.85; border-style:dashed; }
    .match-card.below-threshold::after{ content:'Below threshold ‚Äî nearest neighbor'; display:block; text-align:center; font-size:12px; color:#4b5563; margin-top:8px; font-style:italic; }
    .match-card-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .match-card-header .match-id{ font-family:var(--mono); font-size:13px; font-weight:600; }
    .match-card-header .match-sim{ font-size:20px; font-weight:700; }
    .match-meta{ display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; font-size:12px; }
    .match-meta .meta-chip{ background:var(--chip); padding:3px 10px; border-radius:999px; }
    .match-meta .meta-chip.supporting{ background:#ecfdf5; color:#065f46; }
    .match-meta .meta-chip.contrary{ background:#fef2f2; color:#991b1b; }
    .match-meta .meta-chip.neutral{ background:#fffbeb; color:#92400e; }
    .sim-bars{ display:grid; grid-template-columns:100px 1fr 40px; gap:4px 8px; align-items:center; font-size:12px; }
    .sim-bars .sim-label{ color:#1f2937; text-align:right; }
    .sim-bars .sim-track{ height:8px; background:#f3f4f6; border-radius:999px; overflow:hidden; position:relative; }
    .sim-bars .sim-fill{ height:100%; border-radius:999px; min-width:2px; }
    .sim-bars .sim-fill.high{ background:#059669; }
    .sim-bars .sim-fill.med{ background:#d97706; }
    .sim-bars .sim-fill.low{ background:#e5e7eb; }
    .sim-bars .sim-pct{ font-weight:600; font-size:11px; }
    .sim-bars .sim-pct.zero{ color:#cbd5e1; }
    .match-codes{ font-family:var(--mono); font-size:12px; color:#374151; margin-top:8px; }
    /* Decision Integrity & Governance Alerts */
    .integrity-alert{ border:2px solid #dc2626; border-radius:8px; padding:16px 20px; margin:16px 0; background:#fef2f2; }
    .integrity-alert.critical{ border-color:#dc2626; background:#fef2f2; }
    .integrity-alert.warning{ border-color:#d97706; background:#fffbeb; }
    .integrity-alert.info{ border-color:#2563eb; background:#eff6ff; }
    .integrity-alert .alert-header{ display:flex; align-items:center; gap:8px; font-weight:700; font-size:14px; margin-bottom:8px; }
    .integrity-alert .alert-header.critical{ color:#dc2626; }
    .integrity-alert .alert-header.warning{ color:#92400e; }
    .integrity-alert .alert-header.info{ color:#1e40af; }
    .integrity-alert .alert-body{ font-size:13px; line-height:1.6; color:#1f2937; }
    .integrity-alert .alert-detail{ font-size:13px; color:#1f2937; margin-top:8px; font-family:var(--mono); }
    .integrity-alert .override-badge{ display:inline-block; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:700; background:#dc2626; color:#fff; margin-left:8px; }
    /* Export toolbar */
    .export-bar{ position:sticky; top:0; z-index:100; background:#fff; border-bottom:1px solid var(--border); padding:10px 0; margin-bottom:16px; display:flex; align-items:center; gap:10px; justify-content:flex-end; }
    .export-bar .brand{ margin-right:auto; font-weight:700; font-size:14px; color:var(--fg); }
    .btn-export{ display:inline-flex; align-items:center; gap:6px; padding:8px 16px; border-radius:6px; font-size:13px; font-weight:600; cursor:pointer; border:1px solid var(--border); background:#fff; color:var(--fg); transition:background .15s; }
    .btn-export:hover{ background:#f3f4f6; }
    .btn-export.primary{ background:#1f2937; color:#fff; border-color:#1f2937; }
    .btn-export.primary:hover{ background:#374151; }
    @media print {
      body { padding: 12px; }
      .page { max-width: 100%; }
      .export-bar { display: none !important; }
      .status, .gate-block, .provenance, .statement, .regulatory, .card, .match-card { break-inside: avoid; }
      h2 { break-after: avoid; }
      @page {
        size: A4;
        margin: 18mm 15mm 20mm 15mm;
        @bottom-center { content: "DecisionGraph ‚Äî Page " counter(page) " of " counter(pages); font-size: 9px; color: #cbd5e1; }
        @bottom-right { content: "Policy: {{ policy_hash[:12] if policy_hash else 'N/A' }}..."; font-size: 8px; color: #cbd5e1; font-family: monospace; }
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="export-bar">
      <span class="brand">DecisionGraph Report</span>
      <button class="btn-export" onclick="window.print()" title="Print or save as PDF via browser print dialog">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
        Export PDF
      </button>
      <a class="btn-export primary" href="/report/{{ decision_id }}/export-html" download="decision-report-{{ decision_id_short }}-{{ timestamp[:10] if timestamp else 'unknown' }}.html" title="Download self-contained HTML report file">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
        Export HTML
      </a>
    </div>

    <div class="header">
      <h1>AML/KYC Investigation Report</h1>
      <div class="subtitle">Deterministic Regulatory Decision Engine</div>
    </div>

    <div class="schema-panel break">
      <div><strong>{{ report_schema_version }}</strong></div>
      <div class="small">Engine: {{ engine_version }} ¬∑ Policy: {{ policy_version }}</div>
      <div class="small">Change control: Report schema version v1 (frozen)</div>
      <ul>
        {% for section in report_sections %}
          <li>{{ section }}</li>
        {% endfor %}
      </ul>
    </div>

    {% if decision_integrity_alert %}
    <div class="integrity-alert {% if decision_integrity_alert.severity == 'WARNING' %}warning{% elif decision_integrity_alert.severity == 'INFO' %}info{% endif %} break">
      <div class="alert-header {% if decision_integrity_alert.severity == 'CRITICAL' %}critical{% elif decision_integrity_alert.severity == 'WARNING' %}warning{% else %}info{% endif %}">
        ‚ö† Decision Integrity Alert
        {% if decision_integrity_alert.type == 'CLASSIFIER_OVERRIDE' %}<span class="override-badge">OVERRIDE APPLIED</span>{% endif %}
        {% if decision_integrity_alert.type == 'CLASSIFICATION_DISPOSITION_CONFLICT' %}<span class="override-badge">COMPLIANCE REVIEW REQUIRED</span>{% endif %}
      </div>
      <div class="alert-body">{{ decision_integrity_alert.message }}</div>
      {% if decision_integrity_alert.original_verdict %}
      <div class="alert-detail">
        Original verdict: {{ decision_integrity_alert.original_verdict }} ‚Üí Classifier outcome: {{ decision_integrity_alert.classifier_outcome }}
      </div>
      {% endif %}
    </div>
    {% endif %}

    {% if precedent_deviation_alert %}
    <div class="integrity-alert {% if precedent_deviation_alert.severity == 'CRITICAL' %}critical{% elif precedent_deviation_alert.severity == 'WARNING' %}warning{% elif precedent_deviation_alert.severity == 'INFO' %}info{% endif %} break">
      <div class="alert-header {% if precedent_deviation_alert.severity == 'CRITICAL' %}critical{% elif precedent_deviation_alert.severity == 'WARNING' %}warning{% else %}info{% endif %}">
        {% if precedent_deviation_alert.reporting_deviation %}
        üö® Precedent Deviation ‚Äî Defensibility Alert
        {% elif precedent_deviation_alert.disposition_deviation %}
        üìä Precedent Deviation ‚Äî Consistency Warning
        {% else %}
        üìä Precedent Deviation Signal
        {% endif %}
      </div>
      <div class="alert-body">{{ precedent_deviation_alert.message }}</div>
      {% if precedent_deviation_alert.disposition_deviation %}
      <div class="alert-detail">
        Disposition: {{ precedent_deviation_alert.disposition_deviation.case_disposition }} vs majority {{ precedent_deviation_alert.disposition_deviation.majority_disposition }} ({{ precedent_deviation_alert.disposition_deviation.majority_pct }}% of {{ precedent_deviation_alert.disposition_deviation.comparable_count }} comparable)
      </div>
      {% endif %}
      {% if precedent_deviation_alert.reporting_deviation %}
      <div class="alert-detail" style="color:#c62828; font-weight:600;">
        Reporting: {{ precedent_deviation_alert.reporting_deviation.case_reporting }} contradicts {{ precedent_deviation_alert.reporting_deviation.more_severe_pct }}% historical {{ precedent_deviation_alert.reporting_deviation.dominant_precedent_reporting }} filing rate
      </div>
      {% endif %}
      {% if precedent_deviation_alert.supporting is defined %}
      <div class="alert-detail">
        Supporting: {{ precedent_deviation_alert.supporting }} ¬∑ Contrary: {{ precedent_deviation_alert.contrary }} ¬∑ Evaluated: {{ precedent_deviation_alert.evaluated_disposition | default('N/A') }}
      </div>
      {% endif %}
      {% if precedent_deviation_alert.engine_note %}
      <div class="alert-detail" style="font-style:italic; margin-top:4px;">
        {{ precedent_deviation_alert.engine_note }}
      </div>
      {% endif %}
    </div>
    {% endif %}

    <h2>Administrative Details</h2>
    <div class="card break">
      <div class="kv">
        <div class="label">Decision ID</div>
        <div class="value mono">{{ decision_id_short }}...</div>
        <div class="label">Case ID</div>
        <div class="value mono">{{ case_id }}</div>
        <div class="label">Timestamp</div>
        <div class="value mono">{{ timestamp }}</div>
        <div class="label">Jurisdiction</div>
        <div class="value">{{ jurisdiction }}</div>
        <div class="label">Engine Version</div>
        <div class="value mono">{{ engine_version }}</div>
        <div class="label">Policy Version</div>
        <div class="value mono">{{ policy_version }}</div>
        <div class="label">Report Schema</div>
        <div class="value mono">{{ report_schema_version }}</div>
      </div>
    </div>

    <h2>Investigation Outcome Summary</h2>

    <!-- Disposition Ladder: governed is always the headline -->
    <div class="card break" style="border-left:4px solid {% if governed_disposition == 'STR_REQUIRED' %}#dc2626{% elif governed_disposition == 'NO_REPORT' %}#059669{% else %}#d97706{% endif %};">
      <div class="kv">
        <div class="label">Final Disposition</div>
        <div class="value" style="font-size:16px;">{{ governed_disposition | replace('_', ' ') }}</div>
        <div class="label">&nbsp;</div>
        <div class="value small" style="color:var(--muted);">
          {% if classification_outcome and governed_disposition != classification_outcome | replace('_REQUIRED', '_REQUIRED') %}
            {% if classification_outcome == 'STR_REQUIRED' and governed_disposition != 'STR_REQUIRED' %}
              Classifier recommends {{ classification_outcome | replace('_', ' ') }}. Governed: {{ governed_disposition | replace('_', ' ') }} per gate evaluation. Conflict deferred to compliance officer.
            {% elif classification_outcome == 'NO_REPORT' and governed_disposition != 'NO_REPORT' %}
              Classifier recommends {{ classification_outcome | replace('_', ' ') }}. Governed: {{ governed_disposition | replace('_', ' ') }} per governance correction.
            {% else %}
              Classifier Sovereign{% if suspicion_count == 0 %} ¬∑ Tier 1 = 0{% endif %}
            {% endif %}
          {% else %}
            Classifier Sovereign{% if suspicion_count == 0 %} ¬∑ Tier 1 = 0{% endif %}
          {% endif %}
        </div>
        <div class="label">Engine Output (Rules)</div>
        <div class="value mono" style="{% if engine_disposition != governed_disposition %}color:var(--muted); text-decoration:line-through;{% endif %}">{{ engine_disposition | replace('_', ' ') }}{% if engine_verdict and engine_verdict|lower != 'n/a' %} ‚Äî {{ engine_verdict }}{% endif %}</div>
        {% if verdict != engine_verdict %}
        <div class="label">Governed Verdict</div>
        <div class="value" style="font-size:15px; color:{% if verdict == 'PENDING_REVIEW' %}var(--warn){% elif verdict == 'STR_REQUIRED' %}var(--bad){% else %}var(--ok){% endif %}; font-weight:700;">{{ verdict | replace('_', ' ') }}</div>
        {% endif %}
      </div>
      {% if engine_disposition != governed_disposition %}
      <p class="small" style="margin-top:10px; font-style:italic; color:var(--muted);">
        Engine output differs from governed disposition. Governance correction applied ‚Äî governed outcome is authoritative.
        This correction prevents false escalation and preserves STR threshold integrity.
      </p>
      {% endif %}
    </div>

    <div class="card break">
      <div class="kv">
        <div class="label">Investigation State</div>
        <div class="value">{{ investigation_state }}</div>
        <div class="label">Primary Typology</div>
        <div class="value">{{ primary_typology }}</div>
        {% if regulatory_obligation %}
        <div class="label">Regulatory Obligation</div>
        <div class="value">{{ regulatory_obligation }}</div>
        {% endif %}
        {% if regulatory_position %}
        <div class="label">Regulatory Position</div>
        <div class="value">{{ regulatory_position }}</div>
        {% endif %}
        {% if decision_confidence %}
        <div class="label">Confidence</div>
        <div class="value">{{ decision_confidence }}{% if decision_confidence_score is defined %} ({{ decision_confidence_score }}%){% endif %}</div>
        {% endif %}
      </div>
      {% if decision_confidence %}
      <h4 style="margin-top:14px; margin-bottom:8px; font-size:13px;">Confidence Metrics</h4>
      <table style="font-size:12px; margin-bottom:8px;">
        <thead>
          <tr><th>Metric</th><th>Value</th><th>Definition</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>Decision Confidence</td>
            <td class="mono">{{ decision_confidence }} ({{ decision_confidence_score | default(0) }}%)</td>
            <td class="small">Composite score reflecting evidence completeness and rule alignment</td>
          </tr>
          <tr>
            <td>Precedent Alignment</td>
            <td class="mono">{{ precedent_alignment_pct | default(0) }}%</td>
            <td class="small">supporting_decisive / count(decisive_precedents) within same basis</td>
          </tr>
          <tr>
            <td>Precedent Match Rate</td>
            <td class="mono">{{ precedent_match_rate | default(0) }}% ({{ scored_precedent_count | default(0) }} / {{ total_comparable_pool | default(0) }})</td>
            <td class="small">Percentage of comparable pool meeting similarity threshold</td>
          </tr>
        </tbody>
      </table>
      {% endif %}
      <p class="small" style="margin-top:10px;">{{ decision_explainer }}</p>
    </div>

    {% if canonical_outcome %}
    <h3>Canonical Outcome</h3>
    <div class="card break">
      <div class="kv">
        <div class="label">Disposition</div>
        <div class="value" style="font-weight:700;">{{ canonical_outcome.disposition | default('N/A') | replace('_', ' ') }}</div>
        <div class="label">Disposition Basis</div>
        <div class="value">{{ canonical_outcome.disposition_basis | default('N/A') | replace('_', ' ') }}</div>
        <div class="label">Reporting</div>
        <div class="value">{{ canonical_outcome.reporting | default('N/A') | replace('_', ' ') }}{% if canonical_outcome.reporting_note %} <span class="small">({{ canonical_outcome.reporting_note }})</span>{% endif %}</div>
      </div>
    </div>
    {% endif %}

    <h3>Case Facts</h3>
    <table class="break">
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        {% for fact in transaction_facts %}
        <tr>
          <td>{{ fact.field }}</td>
          <td class="mono">{{ fact.value }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <h2>Case Classification</h2>
    <div class="card break">
      <div class="kv">
        <div class="label">Source</div>
        <div class="value">{{ source_type }}</div>
        <div class="label">Seed Category</div>
        <div class="value">{{ seed_category }}</div>
        <div class="label">Scenario Code</div>
        <div class="value mono">{{ scenario_code }}</div>
      </div>
      {% if is_seed %}
        <p class="small" style="margin-top:10px;">
          Synthetic training case (seeded).
        </p>
      {% endif %}
    </div>

    <h2>Regulatory Determination</h2>
    {% if governed_disposition == "NO_REPORT" %}
      <div class="status ok break">
        <h3>NO_REPORT ‚Äî Alert Cleared</h3>
        <p>Based on available information at time of review, the totality of indicators does not meet the threshold for reasonable grounds to suspect money laundering or terrorist financing activity.</p>
        <p style="margin-top:12px;" class="small"><strong>Recommended Actions:</strong></p>
        <ul class="small">
          <li>Document clearance rationale</li>
          <li>Return to standard monitoring parameters</li>
          <li>No regulatory filing required at this time</li>
        </ul>
      </div>
    {% elif governed_disposition == "STR_REQUIRED" %}
      <div class="status bad break">
        <h3>FILE_STR ‚Äî Suspicious Transaction Report Required</h3>
        <p>Suspicion threshold met under PCMLTFA/FINTRAC guidance. Reasonable grounds exist to suspect that the transaction or attempted transaction is related to the commission or attempted commission of a money laundering or terrorist financing offence.</p>
        {% if escalation_reasons and escalation_reasons|length > 0 %}
          <p style="margin-top:12px;"><strong>Primary Suspicion Drivers:</strong></p>
          <ul>
            {% for reason in escalation_reasons[:4] %}
              <li>{{ reason }}</li>
            {% endfor %}
          </ul>
        {% endif %}
        <p style="margin-top:12px;" class="small"><strong>Recommended Actions:</strong></p>
        <ul class="small">
          <li>File STR within 30 days of suspicion formation</li>
          <li>Apply Enhanced Due Diligence measures</li>
          <li>Implement ongoing monitoring with elevated parameters</li>
          <li>Document investigative rationale in case file</li>
        </ul>
      </div>
    {% elif governed_disposition == "ESCALATE" %}
      <div class="status bad break">
        <h3>ESCALATE ‚Äî Compliance Review Required</h3>
        <p>Suspicion indicators are present and warrant escalation to senior compliance. Final regulatory determination pending review.</p>
        {% if escalation_reasons and escalation_reasons|length > 0 %}
          <p style="margin-top:12px;"><strong>Escalation Triggers:</strong></p>
          <ul>
            {% for reason in escalation_reasons[:4] %}
              <li>{{ reason }}</li>
            {% endfor %}
          </ul>
        {% endif %}
        <p style="margin-top:12px;" class="small"><strong>Recommended Actions:</strong></p>
        <ul class="small">
          <li>Escalate to Senior Analyst / Compliance Officer</li>
          <li>Apply Enhanced Due Diligence measures</li>
          <li>Document escalation rationale in case file</li>
          <li>Determine if STR filing is warranted after review</li>
        </ul>
      </div>
    {% else %}
      <div class="status warn break">
        <h3>EDD_REQUIRED ‚Äî Enhanced Due Diligence Required</h3>
        {% if decision_integrity_alert and decision_integrity_alert.severity == 'CRITICAL' %}
        <div style="background:#fef2f2; border:1px solid #fca5a5; border-radius:6px; padding:12px; margin-bottom:12px;">
          <strong style="color:#dc2626;">‚ö† {{ decision_integrity_alert.type | replace('_', ' ') }}</strong><br>
          <span class="small" style="color:#1f2937;">{{ decision_integrity_alert.message }}</span>
        </div>
        {% endif %}
        {% if decision_integrity_alert and decision_integrity_alert.type == 'CLASSIFICATION_DISPOSITION_CONFLICT' %}
        <p>Classifier identified Tier 1 suspicion indicators that would ordinarily meet the STR threshold. A compliance officer must review the indicators and make the final STR determination. Until reviewed, Enhanced Due Diligence applies.</p>
        {% else %}
        <p>Additional information required before regulatory determination can be finalized. Current indicators warrant enhanced scrutiny but do not independently establish reasonable grounds to suspect.</p>
        {% endif %}
        {% if engine_disposition != governed_disposition %}
        <p class="small" style="margin-top:8px; font-style:italic;">
          Engine originally suggested {{ engine_disposition | replace('_', ' ') }}. Classifier sovereignty applied ‚Äî {{ governed_disposition | replace('_', ' ') }} is the governed outcome.
        </p>
        {% endif %}
        <p style="margin-top:12px;" class="small"><strong>Recommended Actions:</strong></p>
        <ul class="small">
          <li>Complete Enhanced Due Diligence review</li>
          {% if decision_integrity_alert and decision_integrity_alert.type == 'CLASSIFICATION_DISPOSITION_CONFLICT' %}
          <li><strong>Compliance officer review of Tier 1 indicators required before final disposition</strong></li>
          {% endif %}
          <li>Obtain additional documentation as required</li>
          <li>Escalate to Senior Analyst / Compliance Officer within 5 business days</li>
        </ul>
      </div>
    {% endif %}

    <div class="card break">
      <h3>Regulatory Escalation Summary</h3>
      <p class="small">{{ escalation_summary }}</p>
      {% if decision_confidence %}
      <p class="small" style="margin-top:10px;"><strong>Decision Confidence:</strong> {{ decision_confidence }}</p>
      <p class="small">{{ decision_confidence_reason }}</p>
      {% endif %}
    </div>

    {% if analyst_actions and analyst_actions|length > 0 %}
    <h3 style="margin-top:16px;">Analyst Actions</h3>
    <div class="card break" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <span class="small" style="margin-right:8px;">Available for <strong>{{ governed_disposition | replace('_', ' ') }}</strong>:</span>
      {% for act in analyst_actions %}
      {% set is_approval = act.label in ('Approve', 'Confirm Clearance') %}
      {% set block_approval = decision_integrity_alert or display_verdict == 'PENDING_REVIEW' %}
      {% if not (is_approval and block_approval) %}
      <span style="display:inline-block; padding:8px 16px; border-radius:6px; font-size:13px; font-weight:{% if act.primary %}700{% else %}500{% endif %}; border:1px solid {% if act.primary %}#1f2937{% else %}var(--border){% endif %}; background:{% if act.primary %}#1f2937{% else %}#fff{% endif %}; color:{% if act.primary %}#fff{% else %}var(--fg){% endif %};">{{ act.label }}</span>
      {% endif %}
      {% endfor %}
    </div>
    {% endif %}

    {% if edd_recommendations and edd_recommendations|length > 0 %}
    <h2>Recommended Actions</h2>
    <div class="card break">
      <ol class="small" style="margin:0; padding-left:20px;">
        {% for rec in edd_recommendations %}
        <li style="margin-bottom:8px;">
          <strong>{{ rec.action }}</strong>
          {% if rec.reference %}<br><span class="small" style="font-style:italic;">Ref: {{ rec.reference }}</span>{% endif %}
        </li>
        {% endfor %}
      </ol>
    </div>
    {% endif %}

    <h2>Suspicion Classification</h2>
    <div class="card break">
      <div class="kv">
        <div class="label">Classifier Outcome</div>
        <div class="value"><strong>{{ classification_outcome }}</strong></div>
        <div class="label">Classifier Authority</div>
        {% if classification_outcome == 'STR_REQUIRED' and governed_disposition != 'STR_REQUIRED' %}
        <div class="value" style="color:var(--warn); font-weight:600;">OVERRIDDEN ‚Äî Classifier recommends STR, governed disposition is {{ governed_disposition | replace('_', ' ') }}</div>
        {% else %}
        <div class="value" style="color:#059669; font-weight:600;">SOVEREIGN ‚Äî Hard Gate</div>
        {% endif %}
        <div class="label">Suspicion Indicators (Tier 1)</div>
        <div class="value">{{ suspicion_count }}</div>
        <div class="label">Investigative Signals (Tier 2)</div>
        <div class="value">{{ investigative_count }}</div>
        <div class="label">Classifier Version</div>
        <div class="value mono">{{ classification.classifier_version }}</div>
      </div>
      <p class="small" style="margin-top:10px;">{{ classification_reason }}</p>
      <p class="small" style="margin-top:6px; color:var(--muted);">
        {% if classification_outcome == 'STR_REQUIRED' and governed_disposition != 'STR_REQUIRED' %}
        Decision Hierarchy: Classifier recommends {{ classification_outcome | replace('_', ' ') }}, but gate evaluation produced {{ governed_disposition | replace('_', ' ') }}. Conflict deferred to compliance officer for final STR determination.
        {% elif suspicion_count == 0 %}
        Decision Hierarchy: Classifier ‚Üí Rules ‚Üí Narrative ‚Üí Governance. STR is impossible when Tier 1 = 0. No rule, gate, or precedent can override this.
        {% elif governed_disposition != classification_outcome %}
        Decision Hierarchy: Classifier recommends {{ classification_outcome | replace('_', ' ') }}. Governed: {{ governed_disposition | replace('_', ' ') }}. Conflict deferred to compliance officer.
        {% else %}
        Decision Hierarchy: Classifier ‚Üí Rules ‚Üí Narrative ‚Üí Governance. Classifier is sovereign ‚Äî final authority on suspicion determination.
        {% endif %}
      </p>
      {% if tier1_signals and tier1_signals|length > 0 %}
      <h4 style="margin-top:14px; margin-bottom:6px; color:#b91c1c;">Tier 1 ‚Äî Suspicion Indicators (RGS Contributors)</h4>
      <table style="font-size:12px;">
        <thead><tr><th>Code</th><th>Source</th><th>Detail</th></tr></thead>
        <tbody>
          {% for sig in tier1_signals %}
          <tr><td class="mono">{{ sig.code }}</td><td>{{ sig.source }}</td><td>{{ sig.detail }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
      {% if tier2_signals and tier2_signals|length > 0 %}
      <h4 style="margin-top:14px; margin-bottom:6px; color:#92400e;">Tier 2 ‚Äî Investigative Signals (EDD Triggers)</h4>
      <table style="font-size:12px;">
        <thead><tr><th>Code</th><th>Source</th><th>Detail</th></tr></thead>
        <tbody>
          {% for sig in tier2_signals %}
          <tr><td class="mono">{{ sig.code }}</td><td>{{ sig.source }}</td><td>{{ sig.detail }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
      {% if classification.mitigation_applied %}
      <div class="status warn" style="margin-top:12px; padding:12px;">
        <strong>Mitigation Applied</strong><br>
        <span class="small">{{ classification.mitigation_reason }}</span>
      </div>
      {% endif %}
      {% if precedent_consistency_alert %}
      <div class="status warn" style="margin-top:12px; padding:12px;">
        <strong>‚ö†Ô∏è PRECEDENT CONSISTENCY ALERT</strong><br>
        <span class="small">{{ precedent_consistency_detail }}</span>
      </div>
      {% endif %}
    </div>

    <h2>Decision Drivers</h2>
    <div class="card break">
      {% if decision_drivers and decision_drivers|length > 0 %}
      <ul class="small">
        {% for driver in decision_drivers %}
          <li>{{ driver }}</li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="small">Decision drivers derived from rule evaluation were not available in this record.</p>
      {% endif %}
    </div>

    <h2>Gate Evaluation</h2>
    <h3>Gate 1: Zero-False-Escalation Check</h3>
    <div class="gate-block break">
      <h4>
        {% if gate1_passed %}
          <span class="pill pass">REVIEW PERMITTED</span>
        {% else %}
          <span class="pill trig">REVIEW BLOCKED</span>
        {% endif %}
      </h4>
      <p class="small" style="margin-bottom:12px;">
        {% if gate1_passed %}
          Sufficient regulatory basis exists to permit enhanced review if warranted by suspicion indicators.
        {% else %}
          Insufficient lawful basis to escalate. Case cleared ‚Äî no regulatory reporting required.
        {% endif %}
      </p>
      {% if gate1_sections and gate1_sections|length > 0 %}
        {% for section in gate1_sections %}
        <div class="gate-section">
          {% if section.passed %}
            <span class="pill pass">PASS</span>
          {% else %}
            <span class="pill trig">FAIL</span>
          {% endif %}
          <div>
            <div class="section-name">{{ section.name }}</div>
            <div class="section-reason">{{ section.reason }}</div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p class="small">No sections evaluated</p>
      {% endif %}
    </div>

    <h3>Gate 2: STR Threshold</h3>
    <div class="gate-block break">
      <h4>
        STR Required:
        {% if str_required %}
          <span class="pill trig">YES ‚Äî FILE STR</span>
        {% else %}
          <span class="pill pass">NO</span>
        {% endif %}
      </h4>
      {% if not gate1_passed %}
        <p class="small" style="margin-bottom:12px; font-style:italic;">
          Gate 2 evaluation skipped ‚Äî escalation not permitted by Gate 1.
        </p>
      {% endif %}
      {% if gate2_sections and gate2_sections|length > 0 %}
        {% for section in gate2_sections %}
        <div class="gate-section" {% if not gate1_passed %}style="opacity:0.8;"{% endif %}>
          {% if not gate1_passed %}
            <span class="pill na">SKIPPED</span>
          {% elif section.passed %}
            <span class="pill pass">PASS</span>
          {% else %}
            <span class="pill req">REVIEW</span>
          {% endif %}
          <div>
            <div class="section-name">{{ section.name }}</div>
            <div class="section-reason">
              {% if not gate1_passed %}
                Skipped ‚Äî escalation not permitted
              {% else %}
                {{ section.reason }}
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p class="small">No sections evaluated</p>
      {% endif %}
    </div>

    <h2>Rules Evaluated</h2>
    {% set rule_evidence_map = {
      'AML_ESC_HR_COUNTRY': ['txn.destination_country', 'txn.cross_border'],
      'AML_ESC_PEP_SCREEN': ['flag.pep', 'customer.pep_flag'],
      'AML_ESC_PEP': ['flag.pep', 'customer.pep_flag'],
      'AML_ESC_STRUCT': ['flag.structuring_suspected', 'txn.amount_band'],
      'AML_BLOCK_SANCTIONS': ['flag.sanctions_proximity'],
      'AML_INV_STRUCT': ['flag.structuring_suspected', 'txn.amount_band'],
      'AML_STR_LAYER': ['flag.rapid_movement', 'txn.method'],
      'AML_ESC_ADVERSE_MEDIA': ['flag.adverse_media']
    } %}
    {% set ev_lookup = {} %}
    {% for ev in evidence_used %}
      {% if ev.field %}{% set _ = ev_lookup.update({ev.field: ev.value}) %}{% endif %}
    {% endfor %}
    <table class="break">
      <thead>
        <tr>
          <th style="width:140px;">Rule Code</th>
          <th style="width:120px;">Result</th>
          <th>Reason</th>
        </tr>
      </thead>
      <tbody>
        {% for rule in rules_fired %}
        <tr>
          <td class="mono">{{ rule.code }}</td>
          <td>
            {% if rule.result in ['CLEAR', 'NOT_APPLICABLE', 'APPLIED'] %}
              <span class="pill pass">{{ rule.result }}</span>
            {% elif rule.result == 'TRIGGERED' or rule.result == 'ACTIVATED' %}
              <span class="pill trig">{{ rule.result }}</span>
            {% else %}
              <span class="pill na">{{ rule.result }}</span>
            {% endif %}
          </td>
          <td class="small">
            {{ rule.reason }}
            {% if rule.result in ['TRIGGERED', 'ACTIVATED', 'WARN', 'FAIL', 'FAILED'] %}
              {% set mapped = rule_evidence_map.get(rule.code | upper, []) %}
              {% set ns = namespace(active=[]) %}
              {% for f in mapped %}
                {% if f in ev_lookup %}
                  {% set ns.active = ns.active + [f ~ ' = ' ~ ev_lookup[f]] %}
                {% endif %}
              {% endfor %}
              {% if ns.active %}
                <br><span style="color:#374151; font-size:12px;">Triggered by: {{ ns.active[:3] | join(', ') }}</span>
              {% endif %}
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% if not rules_fired %}
        <tr>
          <td colspan="3" class="small">No rules evaluated</td>
        </tr>
        {% endif %}
      </tbody>
    </table>

    {% if precedent_analysis and precedent_analysis.available %}
    <h2>Precedent Intelligence</h2>
    <p class="small"><em>Precedent analysis is advisory and does not override the deterministic engine verdict. Absence of precedent matches does not imply the recommendation is incorrect.</em></p>

    {% if precedent_pool_warning %}
    <div class="integrity-alert warning break">
      <div class="alert-header warning">‚ö† Thin Precedent Pool</div>
      <div class="alert-body">{{ precedent_pool_warning.message }}</div>
      <div class="alert-detail">Pool size: {{ precedent_pool_warning.pool_size }} ¬∑ Minimum required: {{ precedent_pool_warning.minimum_required }}. Percentage-based metrics below are informational only and must not be relied upon for disposition decisions.</div>
    </div>
    {% endif %}

    <!-- FIX-027: Pattern Summary ‚Äî institutional knowledge headline -->
    {% if enhanced_precedent and enhanced_precedent.pattern_summary %}
    <div class="card break" style="border-left:4px solid #2563eb; background:#f0f9ff;">
      <h4 style="margin:0 0 8px 0; color:#1e40af;">Institutional Pattern Summary</h4>
      <p style="font-size:14px; line-height:1.6; margin:0;">{{ enhanced_precedent.pattern_summary }}</p>
    </div>
    {% endif %}

    <!-- FIX-027: Institutional Posture Statement -->
    {% if enhanced_precedent and enhanced_precedent.institutional_posture %}
    <div class="statement break" style="margin-top:12px;">
      <strong>Institutional Posture</strong><br>
      <p style="font-size:14px; line-height:1.6; margin:8px 0 0 0;">{{ enhanced_precedent.institutional_posture }}</p>
    </div>
    {% endif %}

    <!-- FIX-027: Case Thumbnails ‚Äî readable precedent summaries -->
    {% if enhanced_precedent and enhanced_precedent.case_thumbnails and enhanced_precedent.case_thumbnails|length > 0 %}
    <h3 style="margin-top:16px;">Precedent Case Summaries</h3>
    <div class="match-grid">
      {% for thumb in enhanced_precedent.case_thumbnails %}
      <div class="card break" style="border-left:3px solid {% if thumb.classification == 'supporting' %}var(--ok){% elif thumb.classification == 'contrary' %}var(--bad){% else %}var(--warn){% endif %}; padding:12px 16px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
          <span class="mono" style="font-size:13px; font-weight:600;">{{ thumb.precedent_id }}</span>
          <span style="font-size:18px; font-weight:700;">{{ thumb.similarity_pct }}%</span>
        </div>
        <p style="font-size:13px; margin:0 0 6px 0;">{{ thumb.description }}</p>
        {% if thumb.key_matches %}
        <span class="small" style="color:var(--ok);">Matching: {{ thumb.key_matches | join(', ') }}</span><br>
        {% endif %}
        {% if thumb.key_differences %}
        <span class="small" style="color:var(--bad);">Differs: {{ thumb.key_differences | join(', ') }}</span>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Feature Comparison Matrix -->
    {% if enhanced_precedent and enhanced_precedent.feature_comparison_matrix and enhanced_precedent.feature_comparison_matrix|length > 0 %}
    <h3 style="margin-top:16px;">Feature Comparison Matrix</h3>
    <p class="small" style="margin-bottom:8px;"><em>Top precedents compared by similarity feature. Differentiating features highlight where dissimilarity lives.</em></p>
    <table style="width:100%; font-size:13px; border-collapse:collapse;">
      <thead>
        <tr style="background:var(--bg); text-align:left;">
          <th style="padding:6px 8px;">Precedent</th>
          <th style="padding:6px 8px;">Sim.</th>
          <th style="padding:6px 8px;">Outcome</th>
          <th style="padding:6px 8px;">Class</th>
          <th style="padding:6px 8px;">Matching Features</th>
          <th style="padding:6px 8px;">Differentiating Features</th>
        </tr>
      </thead>
      <tbody>
        {% for entry in enhanced_precedent.feature_comparison_matrix %}
        <tr style="border-bottom:1px solid #e5e7eb;">
          <td style="padding:6px 8px;" class="mono">{{ entry.precedent_id }}</td>
          <td style="padding:6px 8px; font-weight:600;">{{ entry.similarity_pct }}%</td>
          <td style="padding:6px 8px;">{{ entry.outcome }}</td>
          <td style="padding:6px 8px; color:{% if entry.classification == 'supporting' %}var(--ok){% elif entry.classification == 'contrary' %}var(--bad){% else %}var(--warn){% endif %};">{{ entry.classification }}</td>
          <td style="padding:6px 8px; color:var(--ok); font-size:12px;">{{ entry.matching_features | join(', ') or 'None' }}</td>
          <td style="padding:6px 8px; color:var(--bad); font-size:12px;">{{ entry.differing_features | join(', ') or 'None' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}

    <!-- Divergence Justification -->
    {% if enhanced_precedent and enhanced_precedent.divergence_justification %}
    {% set dj = enhanced_precedent.divergence_justification %}
    <div class="card break" style="border-left:4px solid var(--warn); margin-top:16px; padding:12px 16px;">
      <h3 style="margin:0 0 8px 0; font-size:15px;">Divergence Justification</h3>
      {% if dj.statement %}
      <p style="font-weight:600; margin:0 0 10px 0;">{{ dj.statement }}</p>
      {% endif %}
      {% if dj.contrary_details and dj.contrary_details|length > 0 %}
      <table style="width:100%; font-size:13px; border-collapse:collapse;">
        <thead>
          <tr style="background:var(--bg); text-align:left;">
            <th style="padding:4px 8px;">Contrary Precedent</th>
            <th style="padding:4px 8px;">Outcome</th>
            <th style="padding:4px 8px;">Similarity</th>
            <th style="padding:4px 8px;">Distinguishing Factors</th>
          </tr>
        </thead>
        <tbody>
          {% for cd in dj.contrary_details %}
          <tr style="border-bottom:1px solid #e5e7eb;">
            <td style="padding:4px 8px;" class="mono">{{ cd.precedent_id }}</td>
            <td style="padding:4px 8px;">{{ cd.outcome }}</td>
            <td style="padding:4px 8px;">{{ cd.similarity_pct }}%</td>
            <td style="padding:4px 8px; font-size:12px;">{{ cd.distinguishing_factors | join('; ') }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
    </div>
    {% endif %}

    <!-- Temporal Context -->
    {% if enhanced_precedent and enhanced_precedent.temporal_context and enhanced_precedent.temporal_context|length > 0 %}
    {% set contrary_timestamps = [] %}
    {% for t in enhanced_precedent.temporal_context if t.classification == 'contrary' and t.timestamp %}
      {% if contrary_timestamps.append(t) %}{% endif %}
    {% endfor %}
    {% if contrary_timestamps|length > 0 %}
    <div style="margin-top:12px;">
      <h4 style="margin-bottom:4px; font-size:14px;">Temporal Context</h4>
      <p class="small" style="margin-bottom:6px;"><em>Contrary precedent decision dates ‚Äî older cases may reflect superseded regulatory guidance.</em></p>
      <ul style="font-size:13px; margin:0; padding-left:20px;">
        {% for t in contrary_timestamps[:5] %}
        <li><span class="mono">{{ t.precedent_id }}</span>: {{ t.timestamp }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    {% endif %}

    <!-- Override Statement -->
    {% if enhanced_precedent and enhanced_precedent.override_statement %}
    <div class="card break" style="border-left:4px solid var(--bad); margin-top:16px; padding:12px 16px; background:#fef2f2;">
      <h3 style="margin:0 0 8px 0; font-size:15px;">Precedent Override Statement</h3>
      <p class="small" style="margin-bottom:10px;"><em>This statement must be reviewed and approved by a compliance officer when the current decision diverges from precedent majority.</em></p>
      <blockquote style="border-left:3px solid var(--bad); padding:8px 12px; margin:0 0 12px 0; font-style:italic; background:#fff;">
        {{ enhanced_precedent.override_statement }}
      </blockquote>
      <div style="display:grid; grid-template-columns:100px 1fr; gap:4px 12px; font-size:13px;">
        <div style="font-weight:600;">Reviewer</div>
        <div style="border-bottom:1px solid #999; min-width:200px;">&nbsp;</div>
        <div style="font-weight:600;">Date</div>
        <div style="border-bottom:1px solid #999; min-width:200px;">&nbsp;</div>
        <div style="font-weight:600;">Rationale</div>
        <div style="border-bottom:1px solid #999; min-width:200px;">&nbsp;</div>
      </div>
    </div>
    {% endif %}

    <!-- Decision Intelligence Summary -->
    <div class="gate-block break" style="background: #f8fafc;">
      <h4 style="margin-bottom:8px;">Precedent Alignment Summary</h4>

      {# Governed Disposition Alignment ‚Äî from enhanced_precedent (uses actual governed disposition) #}
      {% set gov_align = enhanced_precedent.governed_alignment_count | default(precedent_analysis.governed_alignment_count | default(0)) %}
      {% set gov_total = enhanced_precedent.governed_alignment_total | default(precedent_analysis.governed_alignment_total | default(0)) %}
      {% if gov_total > 0 %}
      <div style="border-left:4px solid var(--ok); padding:8px 12px; margin-bottom:12px; background:#f0fdf4;">
        <div style="font-size:15px; font-weight:700;">
          Governed Disposition Alignment: {{ gov_align }}/{{ gov_total }}
          ({{ "%.0f"|format(gov_align / gov_total * 100) }}%)
        </div>
        <p class="small" style="margin:4px 0 0 0;">
          {% if gov_align == gov_total %}
          All comparable precedents resulted in {{ precedent_analysis.proposed_outcome_label | default(governed_disposition | replace('_', ' ')) }} ‚Äî consistent with current governed disposition.
          {% elif gov_align > gov_total / 2 %}
          Majority of comparable precedents ({{ gov_align }}/{{ gov_total }}) match the current governed disposition.
          {% else %}
          Minority of comparable precedents ({{ gov_align }}/{{ gov_total }}) match the current governed disposition.
          {% endif %}
        </p>
      </div>
      {% endif %}

      <div class="kv" style="font-size:13px;">
        <div class="label">Comparable Matches (Scored)</div>
        <div class="value">{{ precedent_analysis.match_count }}</div>
        <div class="label">Raw Overlaps Found</div>
        <div class="value">{{ precedent_analysis.raw_overlap_count | default(0) }}</div>
        <div class="label">Representative Sample</div>
        <div class="value">{{ precedent_analysis.sample_size | default(50) }} cases (‚â•{{ (precedent_analysis.threshold_used * 100) | round | int if precedent_analysis.threshold_used is defined else (precedent_analysis.min_similarity_pct | default(50)) }}% similarity required; mode: {{ precedent_analysis.threshold_mode | default('prod') }})</div>

        {# Terminal Confidence ‚Äî show N/A when no decisive precedents #}
        {% set decisive_total = precedent_analysis.decisive_total | default(-1) %}
        <div class="label">Terminal Confidence</div>
        {% if decisive_total == 0 %}
        <div class="value">N/A ‚Äî No terminal precedents in pool</div>
        {% else %}
        <div class="value">{{ "%.0f"|format(precedent_analysis.precedent_confidence * 100) }}%</div>
        {% endif %}

        <div class="label">Exact Matches</div>
        <div class="value">{{ precedent_analysis.exact_match_count | default(0) }}</div>
      </div>

      {# Terminal confidence context when N/A #}
      {% if decisive_total == 0 %}
      <p class="small" style="margin-top:8px; font-style:italic;">
        All comparable precedents are non-terminal (EDD/review). Terminal confidence scoring requires resolved outcomes (ALLOW/BLOCK). Governed disposition alignment above reflects institutional practice.
      </p>
      {% endif %}

      {# Alignment text for cases WITH decisive precedents #}
      {% set total_decisive = precedent_analysis.supporting_precedents + precedent_analysis.contrary_precedents %}
      {% if total_decisive > 0 %}
      {% set alignment_pct = (precedent_analysis.supporting_precedents / total_decisive * 100) %}
      <p class="small" style="margin-top:12px;">
        {% if alignment_pct >= 100 %}
          <strong>All scored comparable precedents</strong> resulted in the same regulatory outcome.
        {% else %}
          <strong>{{ "%.0f"|format(alignment_pct) }}%</strong> of scored comparable cases resulted in the same regulatory outcome.
        {% endif %}
        <em>(Based on {{ total_decisive }} scored matches above similarity threshold only.)</em>
      </p>
      {% endif %}
      {% if precedent_analysis.similarity_summary %}
      <p class="small" style="margin-top:6px;"><strong>{{ precedent_analysis.similarity_summary }}</strong></p>
      {% endif %}
      {% if precedent_analysis.contrary_precedents > precedent_analysis.supporting_precedents %}
      <div class="status warn" style="margin-top:12px; padding:12px;">
        <strong>‚ö†Ô∏è PRECEDENT DIVERGENCE DETECTED</strong><br>
        <span class="small">Current recommendation diverges from majority of historical cases. Senior compliance review advised before finalization.</span>
      </div>
      {% endif %}
      {% if precedent_analysis.raw_overlap_count | default(0) > 0 and precedent_analysis.match_count == 0 %}
      <div class="status warn" style="margin-top:12px; padding:12px;">
        <strong>Limited Matching Evidence</strong><br>
        <span class="small">Raw overlaps were found based on limited features, but no precedents met the similarity threshold. Provide transaction shape and customer profile facts to enable scoring.</span>
      </div>
      {% endif %}
      {% if precedent_analysis.raw_overlap_count | default(0) > 0 %}
      <p class="small" style="margin-top:10px;">
        Raw overlaps reflect cases sharing one or more structural indicators but not meeting the similarity threshold required for scored comparison.
      </p>
      {% endif %}
      {% set threshold_used = precedent_analysis.threshold_used if precedent_analysis.threshold_used is defined else (precedent_analysis.min_similarity_pct | default(50)) / 100 %}
      {% set avg_similarity = precedent_analysis.avg_top_k_similarity | default(0) %}
      {% set show_why = (precedent_analysis.match_count == 0) or (precedent_analysis.precedent_confidence < 0.4) or (avg_similarity < threshold_used) %}
      {% if show_why and precedent_analysis.why_low_match and precedent_analysis.why_low_match|length > 0 %}
      <div class="status warn" style="margin-top:12px; padding:12px;">
        <strong>Why precedent confidence is limited</strong><br>
        <ul class="small">
          {% set ns = namespace(missing=[], gate=[], rule=[], typo=[]) %}
          {% for item in precedent_analysis.why_low_match %}
            {% if item.missing_features is defined %}{% set ns.missing = item.missing_features %}{% endif %}
            {% if item.gate_mismatch is defined %}{% set ns.gate = item.gate_mismatch %}{% endif %}
            {% if item.rule_mismatch is defined %}{% set ns.rule = item.rule_mismatch %}{% endif %}
            {% if item.typology_mismatch is defined %}{% set ns.typo = item.typology_mismatch %}{% endif %}
          {% endfor %}
          {% if ns.missing|length > 0 %}
          <li>Missing features: {{ ns.missing | join(', ') | replace('_', ' ') }}</li>
          {% endif %}
          {% if ns.gate|length > 0 %}
          <li>Gate mismatch or missing gate data: {{ ns.gate | join(', ') }}</li>
          {% endif %}
          {% if ns.rule|length > 0 %}
          <li>Rule mismatch: {{ ns.rule | join(', ') | replace('_', ' ') }}</li>
          {% endif %}
          {% if ns.typo|length > 0 %}
          <li>Typology mismatch: {{ ns.typo | join(', ') | replace('_', ' ') }}</li>
          {% endif %}
        </ul>
        <span class="small"><strong>How to improve matching:</strong> provide amount bucket, channel/method, corridor, customer type, relationship length, and PEP status.</span>
      </div>
      {% endif %}
    </div>

    <h3>Precedent Classification</h3>
    <div class="card break">
      <div class="kv">
        <div class="label">Supporting Precedents</div>
        <div class="value" style="color: var(--ok);">{{ precedent_analysis.supporting_precedents }} <span class="small">(same outcome as recommendation)</span></div>
        <div class="label">Contrary Precedents</div>
        <div class="value" style="color: var(--bad);">{{ precedent_analysis.contrary_precedents }} <span class="small">(different outcome)</span></div>
        <div class="label">Neutral / Procedural Outcomes</div>
        <div class="value" style="color: var(--muted);">{{ precedent_analysis.neutral_precedents | default(0) }} <span class="small">(resolved via enhanced review)</span></div>
      </div>
      <p class="small" style="margin-top:12px;">
        <em>Procedural outcomes reflect cases resolved through enhanced review processes (EDD/review states) rather than immediate determination.</em>
      </p>
      {% if precedent_analysis.neutral_precedents | default(0) > 0 and precedent_analysis.supporting_precedents + precedent_analysis.contrary_precedents == 0 %}
      {% set cls_gov_align = enhanced_precedent.governed_alignment_count | default(0) %}
      {% set cls_gov_total = enhanced_precedent.governed_alignment_total | default(0) %}
      <p class="small" style="margin-top:8px; border-left:3px solid var(--ok); padding-left:8px;">
        <strong>Note:</strong> All {{ precedent_analysis.neutral_precedents }} precedents are non-terminal (EDD/review) and classified as "Neutral" per INV-005.
        {% if cls_gov_align > 0 %}
        However, {{ cls_gov_align }} of {{ cls_gov_total }} match the current governed disposition ‚Äî indicating strong institutional alignment despite absence of terminal outcomes.
        {% else %}
        The governed disposition diverges from the precedent pool ‚Äî all comparable cases resolved through EDD while the current disposition differs.
        {% endif %}
      </p>
      {% endif %}
    </div>

    <h3>Scored Match Outcome Distribution</h3>
    {% set scored_distribution = precedent_analysis.match_outcome_distribution or precedent_analysis.outcome_distribution %}
    {% set outcome_total = scored_distribution.values()|sum %}
    <table class="break">
      <thead>
        <tr>
          <th>Outcome</th>
          <th>Count</th>
          <th style="width:220px;">Distribution</th>
        </tr>
      </thead>
      <tbody>
        {% for outcome, count in scored_distribution.items() %}
        {% set pct = (count / outcome_total * 100) if outcome_total else 0 %}
        <tr>
          <td>{{ outcome|upper }}</td>
          <td class="mono">{{ count }}</td>
          <td>
            <div class="bar"><span style="width: {{ "%.0f"|format(pct) }}%;"></span></div>
          </td>
        </tr>
        {% endfor %}
        {% if not scored_distribution %}
        <tr>
          <td colspan="3" class="small">No data</td>
        </tr>
        {% endif %}
      </tbody>
    </table>

    <h3>Raw Overlap Outcome Distribution</h3>
    {% set overlap_distribution = precedent_analysis.raw_outcome_distribution or precedent_analysis.overlap_outcome_distribution | default({}) %}
    {% set overlap_total = overlap_distribution.values()|sum %}
    <table class="break">
      <thead>
        <tr>
          <th>Outcome</th>
          <th>Count</th>
          <th style="width:220px;">Distribution</th>
        </tr>
      </thead>
      <tbody>
        {% for outcome, count in overlap_distribution.items() %}
        {% set pct = (count / overlap_total * 100) if overlap_total else 0 %}
        <tr>
          <td>{{ outcome|upper }}</td>
          <td class="mono">{{ count }}</td>
          <td>
            <div class="bar"><span style="width: {{ "%.0f"|format(pct) }}%;"></span></div>
          </td>
        </tr>
        {% endfor %}
        {% if not overlap_distribution %}
        <tr>
          <td colspan="3" class="small">No data</td>
        </tr>
        {% endif %}
      </tbody>
    </table>

    <h3>Precedent Evidence (Top Matches)</h3>
    {% set threshold_pct = ((precedent_analysis.threshold_used|default(0.5)) * 100)|int %}
    <p class="small" style="margin-bottom:8px;"><em>Similarity threshold: ‚â•{{ threshold_pct }}%. Matches below threshold are shown as nearest neighbors for analyst context only.</em></p>
    <div class="match-grid">
      {% for match in precedent_analysis.sample_cases %}
      {% set sc = match.similarity_components %}
      {% set below_threshold = match.similarity_pct < threshold_pct %}
      <div class="match-card break{% if below_threshold %} below-threshold{% endif %}">
        <div class="match-card-header">
          <span class="match-id">{{ match.precedent_id }}</span>
          <span class="match-sim">{{ match.similarity_pct }}%
            {% if match.exact_match %}<span class="badge">EXACT</span>{% endif %}
            {% if below_threshold %}<span class="badge" style="background:#4b5563; color:#fff;">BELOW THRESHOLD</span>{% endif %}
          </span>
        </div>

        <div class="match-meta">
          <span class="meta-chip {{ match.classification | default('neutral') }}">{{ match.outcome_label }}</span>
          <span class="meta-chip">{{ match.decision_level | default('N/A') }}</span>
          {% if match.appealed %}<span class="meta-chip contrary">Appealed{% if match.appeal_outcome %} ¬∑ {{ match.appeal_outcome }}{% endif %}</span>{% endif %}
        </div>

        <div class="sim-bars">
          {% set drivers = [
            ("Rules", sc.rules_overlap|default(0), 30),
            ("Gates", sc.gate_match|default(0), 25),
            ("Typology", sc.typology_overlap|default(0), 15),
            ("Amount", sc.amount_bucket|default(0), 10),
            ("Corridor", sc.corridor_match|default(0), 8),
            ("Channel", sc.channel_method|default(0), 7),
            ("PEP", sc.pep_match|default(0), 5),
            ("Customer", sc.customer_profile|default(0), 5),
            ("Geo Risk", sc.geo_risk|default(0), 5)
          ] %}
          {% for label, pct, weight in drivers %}
          <span class="sim-label">{{ label }}</span>
          <span class="sim-track"><span class="sim-fill {% if pct >= 80 %}high{% elif pct >= 40 %}med{% else %}low{% endif %}" style="width:{{ pct }}%"></span></span>
          <span class="sim-pct {% if pct == 0 %}zero{% endif %}">{% if pct > 0 %}{{ pct }}%{% else %}‚Äî{% endif %}</span>
          {% endfor %}
        </div>

        <div class="match-codes">{{ match.reason_codes | join(' ¬∑ ') }}</div>
      </div>
      {% endfor %}
      {% if not precedent_analysis.sample_cases %}
      <div class="card small">No precedent matches available</div>
      {% endif %}
    </div>

    <h3>Appeal Statistics</h3>
    <div class="card break">
      <div class="kv">
        <div class="label">Total Appealed</div>
        <div class="value">{{ precedent_analysis.appeal_statistics.total_appealed }}</div>
        <div class="label">Upheld</div>
        <div class="value">{{ precedent_analysis.appeal_statistics.upheld }}</div>
        <div class="label">Overturned</div>
        <div class="value">{{ precedent_analysis.appeal_statistics.overturned }}</div>
        <div class="label">Upheld Rate</div>
        <div class="value">{% if precedent_analysis.appeal_statistics.total_appealed > 0 %}{{ "%.0f"|format(precedent_analysis.appeal_statistics.upheld_rate * 100) }}%{% else %}N/A ‚Äî No appeals filed{% endif %}</div>
      </div>
    </div>

    {% if precedent_analysis.caution_precedents and precedent_analysis.caution_precedents|length > 0 %}
    <h3>Caution Precedents (Overturned Cases)</h3>
    <div class="status warn break">
      <p><strong>{{ precedent_analysis.caution_precedents|length }}</strong> similar cases were later overturned on appeal. Review these precedents carefully:</p>
      <ul>
        {% for prec in precedent_analysis.caution_precedents[:5] %}
        <li>
          <strong>{{ prec.case_ref }}</strong> ‚Äî {{ prec.outcome|upper }}
          {% if prec.appeal_result %}<span class="small">(Appeal: {{ prec.appeal_result }})</span>{% endif %}
        </li>
        {% endfor %}
        {% if precedent_analysis.caution_precedents|length > 5 %}
        <li class="small">... and {{ precedent_analysis.caution_precedents|length - 5 }} more</li>
        {% endif %}
      </ul>
    </div>
    {% endif %}
    {% elif precedent_analysis %}
    <h2>Precedent Intelligence</h2>
    <div class="status warn" style="margin-top:12px; padding:12px;">
      <strong>Precedent Analysis Unavailable</strong><br>
      <span class="small">{{ precedent_analysis.message or precedent_analysis.error or 'Precedent analysis unavailable.' }}</span>
    </div>
    {% endif %}

    {% if defensibility_check %}
    <h2>Defensibility Check</h2>
    <div class="card break">
      <div class="kv">
        <div class="label">Status</div>
        <div class="value" style="font-weight:700; {% if defensibility_check.status == 'PASS' %}color:#059669;{% elif defensibility_check.status == 'DEFERRED' %}color:#d97706;{% else %}color:#dc2626;{% endif %}">
          {% if defensibility_check.status == 'PASS' %}‚úÖ{% elif defensibility_check.status == 'DEFERRED' %}‚è≥{% else %}üö®{% endif %}
          {{ defensibility_check.status | default('UNKNOWN') }} ‚Äî {{ defensibility_check.message | default('') }}
        </div>
        {% if defensibility_check.action %}
        <div class="label">Action</div>
        <div class="value">{{ defensibility_check.action }}</div>
        {% endif %}
        {% if defensibility_check.note %}
        <div class="label">Note</div>
        <div class="value small">{{ defensibility_check.note }}</div>
        {% endif %}
        {% if defensibility_check.requires_documented_rationale %}
        <div class="label" style="color:#dc2626; font-weight:600;">INV-009</div>
        <div class="value small" style="color:#dc2626;">{{ defensibility_check.inv_009_note }}</div>
        <div class="label">Rationale Status</div>
        <div class="value" style="font-weight:600; color:#d97706;">{{ defensibility_check.rationale_status | default('PENDING') }}</div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <h2>Risk Factors</h2>
    <table class="break">
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        {% for ev in risk_factors %}
        <tr>
          <td class="mono">{{ ev.field }}</td>
          <td>
            {% if ev.value is sameas true %}
              Yes
            {% elif ev.value is sameas false %}
              No
            {% else %}
              {{ ev.value }}
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% if not risk_factors %}
        <tr>
          <td colspan="2" class="small">No risk factors recorded</td>
        </tr>
        {% endif %}
      </tbody>
    </table>

    <h2>Evidence Considered</h2>
    <p class="small" style="margin-bottom:8px;">Evidence fields reflect the normalized investigation record used for rule evaluation (booleans and buckets). Raw customer identifiers are not included in this report.</p>
    {% set scope_labels = {
      'risk.high_risk_jurisdiction': 'Customer domicile jurisdiction risk',
      'txn.destination_country': 'Transaction destination jurisdiction',
      'txn.cross_border': 'Transaction cross-border indicator',
      'flag.cross_border': 'Cross-border flag (transaction-level)',
      'customer.type': 'Customer entity type',
      'customer.pep_flag': 'Customer PEP status',
      'flag.pep': 'PEP flag (customer-level)',
      'txn.amount_band': 'Transaction amount band',
      'txn.method': 'Payment method',
      'flag.structuring_suspected': 'Structuring indicator (transaction pattern)',
      'flag.sanctions_proximity': 'Sanctions screening proximity',
      'flag.adverse_media': 'Adverse media indicator',
      'flag.rapid_movement': 'Rapid fund movement indicator',
      'flag.shell_entity': 'Shell entity indicator',
      'risk.risk_score': 'Overall risk score'
    } %}
    <table class="break">
      <thead>
        <tr>
          <th>Field</th>
          <th>Scope</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        {% for ev in evidence_used %}
        <tr>
          <td class="mono">{{ ev.field }}</td>
          <td class="small">{{ scope_labels.get(ev.field, ev.field) }}</td>
          <td>{% if ev.value is sameas true %}Yes{% elif ev.value is sameas false %}No{% else %}{{ ev.value }}{% endif %}</td>
        </tr>
        {% endfor %}
        {% if not evidence_used %}
        <tr>
          <td colspan="3" class="small">No evidence recorded</td>
        </tr>
        {% endif %}
      </tbody>
    </table>

    {% if sla_timeline %}
    <h2>Timeline</h2>
    <div class="card break">
      <div class="kv">
        <div class="label">Case Created</div>
        <div class="value mono">{{ sla_timeline.case_created | default('N/A') }}</div>
        <div class="label">EDD Deadline</div>
        <div class="value mono">{{ sla_timeline.edd_deadline | default('N/A') }}</div>
        <div class="label">Final Disposition Due</div>
        <div class="value">{{ sla_timeline.final_disposition_due | default('N/A') }}</div>
        <div class="label">STR Filing Window</div>
        <div class="value">{{ sla_timeline.str_filing_window | default('N/A') }}</div>
      </div>
    </div>
    {% endif %}

    <h2>Auditability &amp; Governance</h2>
    <h3>Decision Provenance</h3>
    <div class="provenance break">
      <div class="kv">
        <div class="label">Decision Hash (SHA-256)</div>
        <div class="value mono hash">{{ decision_id }}</div>
        <div class="label">Input Hash</div>
        <div class="value mono hash">{{ input_hash }}</div>
        <div class="label">Policy Hash</div>
        <div class="value mono hash">{{ policy_hash }}</div>
        <div class="label">Decision Path</div>
        <div class="value mono">{{ decision_path_trace or action or 'N/A' }}</div>
        <div class="label">Engine Verdict (Raw)</div>
        <div class="value mono" style="{% if verdict != engine_verdict %}color:var(--muted); text-decoration:line-through;{% endif %}">{{ engine_verdict or action or 'N/A' }}</div>
        <div class="label">Governed Verdict</div>
        <div class="value mono" style="font-weight:700;">{{ verdict or 'N/A' }}</div>
        <div class="label">Engine Disposition</div>
        <div class="value mono" style="{% if engine_disposition != governed_disposition %}color:var(--muted);{% endif %}">{{ engine_disposition or 'N/A' }}</div>
        <div class="label">Governed Disposition</div>
        <div class="value mono" style="font-weight:700;">{{ governed_disposition or 'N/A' }}</div>
      </div>
      <p class="small" style="margin-top:12px;">
        This decision is cryptographically bound to the exact input and policy evaluated at decision time.
      </p>
    </div>

    <div class="statement break">
      <strong>Determinism & Auditability Statement</strong><br><br>
      This decision was produced by a deterministic rule engine operating under CA-FINTRAC regulatory framework.
      Re-evaluation using identical inputs and the same policy version will produce identical results.<br><br>
      The decision may be independently verified using the <code class="mono">/verify</code> endpoint. Complete decision lineage, rule sequencing, and evidentiary artifacts are preserved within the immutable audit record and available for supervisory review.
    </div>

    {% if str_required %}
    <div class="regulatory break">
      <strong>Regulatory Note</strong><br><br>
      A Suspicious Transaction Report (STR) is required under PCMLTFA/FINTRAC guidelines.
      File within applicable statutory timeframe per regulatory guidance (policy version: {{ policy_version }}).
    </div>
    {% endif %}

    <div class="foot">
      <strong>DecisionGraph</strong> ‚Äî Deterministic - Reproducible - Auditable<br>
      Generated {{ timestamp }}
    </div>
  </div>
</body>
</html>
