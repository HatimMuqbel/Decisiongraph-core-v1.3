<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DecisionGraph - AML/KYC Decision Report</title>
  <style>
    :root{
      --fg:#111827; --muted:#6b7280; --border:#e5e7eb; --bg:#ffffff;
      --chip:#f3f4f6; --ok:#065f46; --warn:#92400e; --bad:#991b1b;
      --okbg:#ecfdf5; --warnbg:#fffbeb; --badbg:#fef2f2;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{ margin:0; padding:24px; font-family:var(--sans); color:var(--fg); background:var(--bg); }
    .page{ max-width:900px; margin:0 auto; }
    .header{ text-align:center; padding-bottom:20px; border-bottom:2px solid var(--fg); margin-bottom:24px; }
    .header h1{ font-size:24px; margin:0 0 4px 0; }
    .header .subtitle{ color:var(--muted); font-size:14px; }
    h2{ font-size:16px; margin:24px 0 12px 0; padding-bottom:6px; border-bottom:1px solid var(--border); }
    h3{ font-size:14px; margin:16px 0 8px 0; }
    .card{ border:1px solid var(--border); border-radius:8px; padding:16px; margin-bottom:16px; }
    .kv{ display:grid; grid-template-columns: 180px 1fr; gap:8px 16px; font-size:14px; }
    .kv .label{ color:var(--muted); }
    .kv .value{ font-weight:600; }
    .kv .value.mono{ font-family:var(--mono); font-size:13px; }
    table{ width:100%; border-collapse:collapse; font-size:13px; margin:12px 0; }
    th, td{ text-align:left; padding:10px 12px; border:1px solid var(--border); vertical-align:top; }
    th{ background:#f9fafb; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:0.05em; font-weight:600; }
    .status{ border-radius:8px; padding:16px; margin:12px 0; }
    .status.ok{ background:var(--okbg); border:1px solid #a7f3d0; }
    .status.warn{ background:var(--warnbg); border:1px solid #fcd34d; }
    .status.bad{ background:var(--badbg); border:1px solid #fecaca; }
    .status h3{ margin:0 0 8px 0; font-size:15px; }
    .status p{ margin:0; font-size:14px; color:var(--fg); }
    .status ul{ margin:8px 0 0 0; padding-left:20px; }
    .status li{ margin:4px 0; }
    .pill{ display:inline-block; padding:3px 10px; border-radius:999px; font-size:12px; font-weight:600; }
    .pill.na{ background:#f3f4f6; color:#374151; }
    .pill.req{ background:#fffbeb; color:var(--warn); }
    .pill.trig{ background:#fef2f2; color:var(--bad); }
    .pill.pass{ background:#ecfdf5; color:var(--ok); }
    .mono{ font-family:var(--mono); }
    .small{ font-size:12px; color:var(--muted); }
    .gate-block{ background:#f9fafb; border:1px solid var(--border); border-radius:8px; padding:16px; margin:12px 0; }
    .gate-block h4{ margin:0 0 12px 0; font-size:14px; display:flex; align-items:center; gap:8px; }
    .gate-section{ display:flex; align-items:flex-start; gap:8px; padding:8px 0; border-bottom:1px solid var(--border); }
    .gate-section:last-child{ border-bottom:none; }
    .gate-section .section-name{ font-weight:600; font-size:13px; }
    .gate-section .section-reason{ font-size:12px; color:var(--muted); margin-top:2px; }
    .provenance{ background:#f9fafb; border:1px solid var(--border); border-radius:8px; padding:16px; }
    .provenance .hash{ word-break:break-all; font-size:12px; }
    .statement{ background:#f0f9ff; border:1px solid #bae6fd; border-radius:8px; padding:16px; margin:16px 0; font-size:14px; }
    .regulatory{ background:#fefce8; border:1px solid #fde047; border-radius:8px; padding:16px; margin:16px 0; font-size:14px; }
    .foot{ margin-top:24px; padding-top:16px; border-top:1px solid var(--border); color:var(--muted); font-size:12px; text-align:center; }
    .break{ break-inside:avoid; page-break-inside:avoid; }
    .bar{ height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
    .bar > span{ display:block; height:100%; background:#1f2937; }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:700; background:#ecfdf5; color:#065f46; }
    .schema-panel{ border:1px solid var(--border); border-radius:8px; padding:12px; background:#f9fafb; font-size:12px; margin:16px 0; }
    .schema-panel ul{ margin:8px 0 0 18px; padding:0; }
    .schema-panel li{ margin:2px 0; }
    @media print {
      body { padding: 12px; }
      .page { max-width: 100%; }
      .status, .gate-block, .provenance, .statement, .regulatory { break-inside: avoid; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="header">
      <h1>AML/KYC Investigation Report</h1>
      <div class="subtitle">Deterministic Regulatory Decision Engine</div>
    </div>

    <div class="schema-panel break">
      <div><strong>{{ report_schema_version }}</strong></div>
      <div class="small">Engine: {{ engine_version }} · Policy: {{ policy_version }}</div>
      <div class="small">Change control: Report schema version v1 (frozen)</div>
      <ul>
        {% for section in report_sections %}
          <li>{{ section }}</li>
        {% endfor %}
      </ul>
    </div>

    <h2>Administrative Details</h2>
    <div class="card break">
      <div class="kv">
        <div class="label">Decision ID</div>
        <div class="value mono">{{ decision_id_short }}...</div>
        <div class="label">Case ID</div>
        <div class="value mono">{{ case_id }}</div>
        <div class="label">Timestamp</div>
        <div class="value mono">{{ timestamp }}</div>
        <div class="label">Jurisdiction</div>
        <div class="value">{{ jurisdiction }}</div>
        <div class="label">Engine Version</div>
        <div class="value mono">{{ engine_version }}</div>
        <div class="label">Policy Version</div>
        <div class="value mono">{{ policy_version }}</div>
        <div class="label">Report Schema</div>
        <div class="value mono">{{ report_schema_version }}</div>
      </div>
    </div>

    <h2>Investigation Outcome Summary</h2>
    <div class="card break">
      <div class="kv">
        <div class="label">Regulatory Status</div>
        <div class="value">{{ regulatory_status }}</div>
        <div class="label">Investigation State</div>
        <div class="value">{{ investigation_state }}</div>
        <div class="label">Primary Typology</div>
        <div class="value">{{ primary_typology }}</div>
        {% if regulatory_obligation %}
        <div class="label">Regulatory Obligation</div>
        <div class="value">{{ regulatory_obligation }}</div>
        {% endif %}
        {% if regulatory_position %}
        <div class="label">Regulatory Position</div>
        <div class="value">{{ regulatory_position }}</div>
        {% endif %}
        {% if decision_confidence %}
        <div class="label">Confidence</div>
        <div class="value">{{ decision_confidence }}{% if decision_confidence_score is defined %} ({{ decision_confidence_score }}%){% endif %}</div>
        {% endif %}
      </div>
      <p class="small" style="margin-top:10px;">{{ decision_explainer }}</p>
    </div>

    <h3>Case Facts</h3>
    <table class="break">
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        {% for fact in transaction_facts %}
        <tr>
          <td>{{ fact.field }}</td>
          <td class="mono">{{ fact.value }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <h2>Case Classification</h2>
    <div class="card break">
      <div class="kv">
        <div class="label">Source</div>
        <div class="value">{{ source_type }}</div>
        <div class="label">Seed Category</div>
        <div class="value">{{ seed_category }}</div>
        <div class="label">Scenario Code</div>
        <div class="value mono">{{ scenario_code }}</div>
      </div>
      {% if is_seed %}
        <p class="small" style="margin-top:10px;">
          Synthetic training case (seeded).
        </p>
      {% endif %}
    </div>

    <h2>Regulatory Determination</h2>
    {% if decision_status == "pass" %}
      <div class="status ok break">
        <h3>NO_REPORT — Alert Cleared</h3>
        <p>Based on available information at time of review, the totality of indicators does not meet the threshold for reasonable grounds to suspect money laundering or terrorist financing activity.</p>
        <p style="margin-top:12px;" class="small"><strong>Recommended Actions:</strong></p>
        <ul class="small">
          <li>Document clearance rationale</li>
          <li>Return to standard monitoring parameters</li>
          <li>No regulatory filing required at this time</li>
        </ul>
      </div>
    {% elif decision_status == "escalate" %}
      <div class="status bad break">
        <h3>FILE_STR — Suspicious Transaction Report Required</h3>
        <p>Suspicion threshold met under PCMLTFA/FINTRAC guidance. Reasonable grounds exist to suspect that the transaction or attempted transaction is related to the commission or attempted commission of a money laundering or terrorist financing offence.</p>
        {% if escalation_reasons and escalation_reasons|length > 0 %}
          <p style="margin-top:12px;"><strong>Primary Suspicion Drivers:</strong></p>
          <ul>
            {% for reason in escalation_reasons[:4] %}
              <li>{{ reason }}</li>
            {% endfor %}
          </ul>
        {% endif %}
        <p style="margin-top:12px;" class="small"><strong>Recommended Actions:</strong></p>
        <ul class="small">
          <li>File STR within 30 days of suspicion formation</li>
          <li>Apply Enhanced Due Diligence measures</li>
          <li>Implement ongoing monitoring with elevated parameters</li>
          <li>Document investigative rationale in case file</li>
        </ul>
      </div>
    {% else %}
      <div class="status warn break">
        <h3>EDD_REQUIRED — Enhanced Due Diligence Required</h3>
        <p>Additional information required before regulatory determination can be finalized. Current indicators warrant enhanced scrutiny but do not independently establish reasonable grounds to suspect.</p>
        <p style="margin-top:12px;" class="small"><strong>Recommended Actions:</strong></p>
        <ul class="small">
          <li>Complete Enhanced Due Diligence review</li>
          <li>Obtain additional documentation as required</li>
          <li>Escalate to Senior Analyst / Compliance Officer within 5 business days</li>
        </ul>
      </div>
    {% endif %}

    <div class="card break">
      <h3>Regulatory Escalation Summary</h3>
      <p class="small">{{ escalation_summary }}</p>
      {% if decision_confidence %}
      <p class="small" style="margin-top:10px;"><strong>Decision Confidence:</strong> {{ decision_confidence }}</p>
      <p class="small">{{ decision_confidence_reason }}</p>
      {% endif %}
    </div>

    <h2>Suspicion Classification</h2>
    <div class="card break">
      <div class="kv">
        <div class="label">Classifier Outcome</div>
        <div class="value"><strong>{{ classification_outcome }}</strong></div>
        <div class="label">Suspicion Indicators (Tier 1)</div>
        <div class="value">{{ suspicion_count }}</div>
        <div class="label">Investigative Signals (Tier 2)</div>
        <div class="value">{{ investigative_count }}</div>
        <div class="label">Classifier Version</div>
        <div class="value mono">{{ classification.classifier_version }}</div>
      </div>
      <p class="small" style="margin-top:10px;">{{ classification_reason }}</p>
      {% if tier1_signals and tier1_signals|length > 0 %}
      <h4 style="margin-top:14px; margin-bottom:6px; color:#b91c1c;">Tier 1 — Suspicion Indicators (RGS Contributors)</h4>
      <table style="font-size:12px;">
        <thead><tr><th>Code</th><th>Source</th><th>Detail</th></tr></thead>
        <tbody>
          {% for sig in tier1_signals %}
          <tr><td class="mono">{{ sig.code }}</td><td>{{ sig.source }}</td><td>{{ sig.detail }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
      {% if tier2_signals and tier2_signals|length > 0 %}
      <h4 style="margin-top:14px; margin-bottom:6px; color:#92400e;">Tier 2 — Investigative Signals (EDD Triggers)</h4>
      <table style="font-size:12px;">
        <thead><tr><th>Code</th><th>Source</th><th>Detail</th></tr></thead>
        <tbody>
          {% for sig in tier2_signals %}
          <tr><td class="mono">{{ sig.code }}</td><td>{{ sig.source }}</td><td>{{ sig.detail }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
      {% if classification.mitigation_applied %}
      <div class="status warn" style="margin-top:12px; padding:12px;">
        <strong>Mitigation Applied</strong><br>
        <span class="small">{{ classification.mitigation_reason }}</span>
      </div>
      {% endif %}
      {% if precedent_consistency_alert %}
      <div class="status warn" style="margin-top:12px; padding:12px;">
        <strong>⚠️ PRECEDENT CONSISTENCY ALERT</strong><br>
        <span class="small">{{ precedent_consistency_detail }}</span>
      </div>
      {% endif %}
    </div>

    <h2>Decision Drivers</h2>
    <div class="card break">
      {% if decision_drivers and decision_drivers|length > 0 %}
      <ul class="small">
        {% for driver in decision_drivers %}
          <li>{{ driver }}</li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="small">Decision drivers derived from rule evaluation were not available in this record.</p>
      {% endif %}
    </div>

    <h2>Gate Evaluation</h2>
    <h3>Gate 1: Zero-False-Escalation Check</h3>
    <div class="gate-block break">
      <h4>
        {% if gate1_passed %}
          <span class="pill pass">REVIEW PERMITTED</span>
        {% else %}
          <span class="pill trig">REVIEW BLOCKED</span>
        {% endif %}
      </h4>
      <p class="small" style="margin-bottom:12px;">
        {% if gate1_passed %}
          Sufficient regulatory basis exists to permit enhanced review if warranted by suspicion indicators.
        {% else %}
          Insufficient lawful basis to escalate. Case cleared — no regulatory reporting required.
        {% endif %}
      </p>
      {% if gate1_sections and gate1_sections|length > 0 %}
        {% for section in gate1_sections %}
        <div class="gate-section">
          {% if section.passed %}
            <span class="pill pass">PASS</span>
          {% else %}
            <span class="pill trig">FAIL</span>
          {% endif %}
          <div>
            <div class="section-name">{{ section.name }}</div>
            <div class="section-reason">{{ section.reason }}</div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p class="small">No sections evaluated</p>
      {% endif %}
    </div>

    <h3>Gate 2: STR Threshold</h3>
    <div class="gate-block break">
      <h4>
        STR Required:
        {% if str_required %}
          <span class="pill trig">YES — FILE STR</span>
        {% else %}
          <span class="pill pass">NO</span>
        {% endif %}
      </h4>
      {% if not gate1_passed %}
        <p class="small" style="margin-bottom:12px; font-style:italic;">
          Gate 2 evaluation skipped — escalation not permitted by Gate 1.
        </p>
      {% endif %}
      {% if gate2_sections and gate2_sections|length > 0 %}
        {% for section in gate2_sections %}
        <div class="gate-section" {% if not gate1_passed %}style="opacity:0.5;"{% endif %}>
          {% if not gate1_passed %}
            <span class="pill na">SKIPPED</span>
          {% elif section.passed %}
            <span class="pill pass">PASS</span>
          {% else %}
            <span class="pill req">REVIEW</span>
          {% endif %}
          <div>
            <div class="section-name">{{ section.name }}</div>
            <div class="section-reason">
              {% if not gate1_passed %}
                Skipped — escalation not permitted
              {% else %}
                {{ section.reason }}
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p class="small">No sections evaluated</p>
      {% endif %}
    </div>

    <h2>Rules Evaluated</h2>
    <table class="break">
      <thead>
        <tr>
          <th style="width:140px;">Rule Code</th>
          <th style="width:120px;">Result</th>
          <th>Reason</th>
        </tr>
      </thead>
      <tbody>
        {% for rule in rules_fired %}
        <tr>
          <td class="mono">{{ rule.code }}</td>
          <td>
            {% if rule.result in ['CLEAR', 'NOT_APPLICABLE', 'APPLIED'] %}
              <span class="pill pass">{{ rule.result }}</span>
            {% elif rule.result == 'TRIGGERED' or rule.result == 'ACTIVATED' %}
              <span class="pill trig">{{ rule.result }}</span>
            {% else %}
              <span class="pill na">{{ rule.result }}</span>
            {% endif %}
          </td>
          <td class="small">{{ rule.reason }}</td>
        </tr>
        {% endfor %}
        {% if not rules_fired %}
        <tr>
          <td colspan="3" class="small">No rules evaluated</td>
        </tr>
        {% endif %}
      </tbody>
    </table>

    {% if precedent_analysis and precedent_analysis.available %}
    <h2>Precedent Intelligence</h2>
    <p class="small"><em>Precedent analysis is advisory and does not override the deterministic engine verdict. Absence of precedent matches does not imply the recommendation is incorrect.</em></p>

    <!-- Decision Intelligence Summary -->
    <div class="gate-block break" style="background: #f8fafc;">
      <h4 style="margin-bottom:8px;">Precedent Alignment Summary</h4>
      <div class="kv" style="font-size:13px;">
        <div class="label">Comparable Matches (Scored)</div>
        <div class="value">{{ precedent_analysis.match_count }}</div>
        <div class="label">Raw Overlaps Found</div>
        <div class="value">{{ precedent_analysis.raw_overlap_count | default(0) }}</div>
        <div class="label">Representative Sample</div>
        <div class="value">{{ precedent_analysis.sample_size | default(50) }} cases (≥{{ (precedent_analysis.threshold_used * 100) | round | int if precedent_analysis.threshold_used is defined else (precedent_analysis.min_similarity_pct | default(50)) }}% similarity required; mode: {{ precedent_analysis.threshold_mode | default('prod') }})</div>
        <div class="label">Precedent Alignment</div>
        <div class="value">{{ "%.0f"|format(precedent_analysis.precedent_confidence * 100) }}%</div>
        <div class="label">Exact Matches</div>
        <div class="value">{{ precedent_analysis.exact_match_count | default(0) }}</div>
      </div>
      {% set total_decisive = precedent_analysis.supporting_precedents + precedent_analysis.contrary_precedents %}
      {% if total_decisive > 0 %}
      {% set alignment_pct = (precedent_analysis.supporting_precedents / total_decisive * 100) %}
      <p class="small" style="margin-top:12px;">
        {% if alignment_pct >= 100 %}
          <strong>All</strong> comparable precedents resulted in the same regulatory outcome.
        {% else %}
          <strong>{{ "%.0f"|format(alignment_pct) }}%</strong> of comparable cases resulted in the same regulatory outcome.
        {% endif %}
      </p>
      {% endif %}
      {% if precedent_analysis.similarity_summary %}
      <p class="small" style="margin-top:6px;"><strong>{{ precedent_analysis.similarity_summary }}</strong></p>
      {% endif %}
      {% if precedent_analysis.contrary_precedents > precedent_analysis.supporting_precedents %}
      <div class="status warn" style="margin-top:12px; padding:12px;">
        <strong>⚠️ PRECEDENT DIVERGENCE DETECTED</strong><br>
        <span class="small">Current recommendation diverges from majority of historical cases. Senior compliance review advised before finalization.</span>
      </div>
      {% endif %}
      {% if precedent_analysis.raw_overlap_count | default(0) > 0 and precedent_analysis.match_count == 0 %}
      <div class="status warn" style="margin-top:12px; padding:12px;">
        <strong>Limited Matching Evidence</strong><br>
        <span class="small">Raw overlaps were found based on limited features, but no precedents met the similarity threshold. Provide transaction shape and customer profile facts to enable scoring.</span>
      </div>
      {% endif %}
      {% if precedent_analysis.raw_overlap_count | default(0) > 0 %}
      <p class="small" style="margin-top:10px;">
        Raw overlaps reflect cases sharing one or more structural indicators but not meeting the similarity threshold required for scored comparison.
      </p>
      {% endif %}
      {% set threshold_used = precedent_analysis.threshold_used if precedent_analysis.threshold_used is defined else (precedent_analysis.min_similarity_pct | default(50)) / 100 %}
      {% set avg_similarity = precedent_analysis.avg_top_k_similarity | default(0) %}
      {% set show_why = (precedent_analysis.match_count == 0) or (precedent_analysis.precedent_confidence < 0.4) or (avg_similarity < threshold_used) %}
      {% if show_why and precedent_analysis.why_low_match and precedent_analysis.why_low_match|length > 0 %}
      <div class="status warn" style="margin-top:12px; padding:12px;">
        <strong>Why precedent confidence is limited</strong><br>
        <ul class="small">
          {% set ns = namespace(missing=[], gate=[], rule=[], typo=[]) %}
          {% for item in precedent_analysis.why_low_match %}
            {% if item.missing_features is defined %}{% set ns.missing = item.missing_features %}{% endif %}
            {% if item.gate_mismatch is defined %}{% set ns.gate = item.gate_mismatch %}{% endif %}
            {% if item.rule_mismatch is defined %}{% set ns.rule = item.rule_mismatch %}{% endif %}
            {% if item.typology_mismatch is defined %}{% set ns.typo = item.typology_mismatch %}{% endif %}
          {% endfor %}
          {% if ns.missing|length > 0 %}
          <li>Missing features: {{ ns.missing | join(', ') | replace('_', ' ') }}</li>
          {% endif %}
          {% if ns.gate|length > 0 %}
          <li>Gate mismatch or missing gate data: {{ ns.gate | join(', ') }}</li>
          {% endif %}
          {% if ns.rule|length > 0 %}
          <li>Rule mismatch: {{ ns.rule | join(', ') | replace('_', ' ') }}</li>
          {% endif %}
          {% if ns.typo|length > 0 %}
          <li>Typology mismatch: {{ ns.typo | join(', ') | replace('_', ' ') }}</li>
          {% endif %}
        </ul>
        <span class="small"><strong>How to improve matching:</strong> provide amount bucket, channel/method, corridor, customer type, relationship length, and PEP status.</span>
      </div>
      {% endif %}
    </div>

    <h3>Precedent Classification</h3>
    <div class="card break">
      <div class="kv">
        <div class="label">Supporting Precedents</div>
        <div class="value" style="color: var(--ok);">{{ precedent_analysis.supporting_precedents }} <span class="small">(same outcome as recommendation)</span></div>
        <div class="label">Contrary Precedents</div>
        <div class="value" style="color: var(--bad);">{{ precedent_analysis.contrary_precedents }} <span class="small">(different outcome)</span></div>
        <div class="label">Neutral / Procedural Outcomes</div>
        <div class="value" style="color: var(--muted);">{{ precedent_analysis.neutral_precedents | default(0) }} <span class="small">(resolved via enhanced review)</span></div>
      </div>
      <p class="small" style="margin-top:12px;">
        <em>Procedural outcomes reflect cases resolved through enhanced review processes (EDD/review states) rather than immediate determination.</em>
      </p>
    </div>

    <h3>Scored Match Outcome Distribution</h3>
    {% set scored_distribution = precedent_analysis.match_outcome_distribution or precedent_analysis.outcome_distribution %}
    {% set outcome_total = scored_distribution.values()|sum %}
    <table class="break">
      <thead>
        <tr>
          <th>Outcome</th>
          <th>Count</th>
          <th style="width:220px;">Distribution</th>
        </tr>
      </thead>
      <tbody>
        {% for outcome, count in scored_distribution.items() %}
        {% set pct = (count / outcome_total * 100) if outcome_total else 0 %}
        <tr>
          <td>{% if outcome|lower == 'pay' %}NO_REPORT{% elif outcome|lower == 'deny' %}FILE_STR{% elif outcome|lower == 'escalate' %}EDD_REQUIRED{% else %}{{ outcome|upper }}{% endif %}</td>
          <td class="mono">{{ count }}</td>
          <td>
            <div class="bar"><span style="width: {{ "%.0f"|format(pct) }}%;"></span></div>
          </td>
        </tr>
        {% endfor %}
        {% if not scored_distribution %}
        <tr>
          <td colspan="3" class="small">No data</td>
        </tr>
        {% endif %}
      </tbody>
    </table>

    <h3>Raw Overlap Outcome Distribution</h3>
    {% set overlap_distribution = precedent_analysis.raw_outcome_distribution or precedent_analysis.overlap_outcome_distribution | default({}) %}
    {% set overlap_total = overlap_distribution.values()|sum %}
    <table class="break">
      <thead>
        <tr>
          <th>Outcome</th>
          <th>Count</th>
          <th style="width:220px;">Distribution</th>
        </tr>
      </thead>
      <tbody>
        {% for outcome, count in overlap_distribution.items() %}
        {% set pct = (count / overlap_total * 100) if overlap_total else 0 %}
        <tr>
          <td>{% if outcome|lower == 'pay' %}NO_REPORT{% elif outcome|lower == 'deny' %}FILE_STR{% elif outcome|lower == 'escalate' %}EDD_REQUIRED{% else %}{{ outcome|upper }}{% endif %}</td>
          <td class="mono">{{ count }}</td>
          <td>
            <div class="bar"><span style="width: {{ "%.0f"|format(pct) }}%;"></span></div>
          </td>
        </tr>
        {% endfor %}
        {% if not overlap_distribution %}
        <tr>
          <td colspan="3" class="small">No data</td>
        </tr>
        {% endif %}
      </tbody>
    </table>

    <h3>Precedent Evidence (Top Matches)</h3>
    <table class="break">
      <thead>
        <tr>
          <th>Precedent</th>
          <th>Outcome</th>
          <th>Similarity</th>
          <th>Decision Level</th>
          <th>Reason Codes</th>
          <th>Similarity Drivers</th>
        </tr>
      </thead>
      <tbody>
        {% for match in precedent_analysis.sample_cases %}
        <tr>
          <td class="mono">{{ match.precedent_id }}</td>
          <td>{{ match.outcome_label }}</td>
          <td>
            {{ match.similarity_pct }}%
            {% if match.exact_match %}
              <span class="badge">EXACT</span>
            {% endif %}
          </td>
          <td>{{ match.decision_level | default('N/A') }}</td>
          <td class="mono">{{ match.reason_codes | join(', ') }}</td>
          <td class="small">
            Rules: {% if match.similarity_components.rules_overlap %}{{ match.similarity_components.rules_overlap }}% (25%){% else %}Not material{% endif %}<br>
            Gates: {% if match.similarity_components.gate_match %}{{ match.similarity_components.gate_match }}% (20%){% else %}Not material{% endif %}<br>
            Typologies: {% if match.similarity_components.typology_overlap %}{{ match.similarity_components.typology_overlap }}% (15%){% else %}Not material{% endif %}<br>
            Amount: {% if match.similarity_components.amount_bucket %}{{ match.similarity_components.amount_bucket }}% (10%){% else %}Not material{% endif %}<br>
            Channel: {% if match.similarity_components.channel_method %}{{ match.similarity_components.channel_method }}% (7%){% else %}Not material{% endif %}<br>
            Corridor: {% if match.similarity_components.corridor_match %}{{ match.similarity_components.corridor_match }}% (8%){% else %}Not material{% endif %}<br>
            PEP: {% if match.similarity_components.pep_match %}{{ match.similarity_components.pep_match }}% (6%){% else %}Not material{% endif %}<br>
            Customer: {% if match.similarity_components.customer_profile %}{{ match.similarity_components.customer_profile }}% (5%){% else %}Not material{% endif %}<br>
            Geo Risk: {% if match.similarity_components.geo_risk %}{{ match.similarity_components.geo_risk }}% (4%){% else %}Not material{% endif %}
          </td>
        </tr>
        {% endfor %}
        {% if not precedent_analysis.sample_cases %}
        <tr>
          <td colspan="6" class="small">No precedent matches available</td>
        </tr>
        {% endif %}
      </tbody>
    </table>

    <h3>Appeal Statistics</h3>
    <div class="card break">
      <div class="kv">
        <div class="label">Total Appealed</div>
        <div class="value">{{ precedent_analysis.appeal_statistics.total_appealed }}</div>
        <div class="label">Upheld</div>
        <div class="value">{{ precedent_analysis.appeal_statistics.upheld }}</div>
        <div class="label">Overturned</div>
        <div class="value">{{ precedent_analysis.appeal_statistics.overturned }}</div>
        <div class="label">Upheld Rate</div>
        <div class="value">{{ "%.0f"|format(precedent_analysis.appeal_statistics.upheld_rate * 100) }}%</div>
      </div>
    </div>

    {% if precedent_analysis.caution_precedents and precedent_analysis.caution_precedents|length > 0 %}
    <h3>Caution Precedents (Overturned Cases)</h3>
    <div class="status warn break">
      <p><strong>{{ precedent_analysis.caution_precedents|length }}</strong> similar cases were later overturned on appeal. Review these precedents carefully:</p>
      <ul>
        {% for prec in precedent_analysis.caution_precedents[:5] %}
        <li>
          <strong>{{ prec.case_ref }}</strong> — {{ prec.outcome|upper }}
          {% if prec.appeal_result %}<span class="small">(Appeal: {{ prec.appeal_result }})</span>{% endif %}
        </li>
        {% endfor %}
        {% if precedent_analysis.caution_precedents|length > 5 %}
        <li class="small">... and {{ precedent_analysis.caution_precedents|length - 5 }} more</li>
        {% endif %}
      </ul>
    </div>
    {% endif %}
    {% elif precedent_analysis %}
    <h2>Precedent Intelligence</h2>
    <div class="status warn" style="margin-top:12px; padding:12px;">
      <strong>Precedent Analysis Unavailable</strong><br>
      <span class="small">{{ precedent_analysis.message or precedent_analysis.error or 'Precedent analysis unavailable.' }}</span>
    </div>
    {% endif %}

    <h2>Risk Factors</h2>
    <table class="break">
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        {% for ev in risk_factors %}
        <tr>
          <td class="mono">{{ ev.field }}</td>
          <td>
            {% if ev.value is sameas true %}
              Yes
            {% elif ev.value is sameas false %}
              No
            {% else %}
              {{ ev.value }}
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% if not risk_factors %}
        <tr>
          <td colspan="2" class="small">No risk factors recorded</td>
        </tr>
        {% endif %}
      </tbody>
    </table>

    <h2>Evidence Considered</h2>
    <p class="small" style="margin-bottom:8px;">Evidence fields reflect the normalized investigation record used for rule evaluation (booleans and buckets). Raw customer identifiers are not included in this report.</p>
    <table class="break">
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        {% for ev in evidence_used %}
        <tr>
          <td class="mono">{{ ev.field }}</td>
          <td>{{ ev.value }}</td>
        </tr>
        {% endfor %}
        {% if not evidence_used %}
        <tr>
          <td colspan="2" class="small">No evidence recorded</td>
        </tr>
        {% endif %}
      </tbody>
    </table>

    <h2>Auditability &amp; Governance</h2>
    <h3>Decision Provenance</h3>
    <div class="provenance break">
      <div class="kv">
        <div class="label">Decision Hash (SHA-256)</div>
        <div class="value mono hash">{{ decision_id }}</div>
        <div class="label">Input Hash</div>
        <div class="value mono hash">{{ input_hash }}</div>
        <div class="label">Policy Hash</div>
        <div class="value mono hash">{{ policy_hash }}</div>
        <div class="label">Decision Path</div>
        <div class="value mono">{{ decision_path_trace or action or 'N/A' }}</div>
        <div class="label">Primary Trigger</div>
        <div class="value mono">{{ action or 'N/A' }}</div>
      </div>
      <p class="small" style="margin-top:12px;">
        This decision is cryptographically bound to the exact input and policy evaluated at decision time.
      </p>
    </div>

    <div class="statement break">
      <strong>Determinism & Auditability Statement</strong><br><br>
      This decision was produced by a deterministic rule engine operating under CA-FINTRAC regulatory framework.
      Re-evaluation using identical inputs and the same policy version will produce identical results.<br><br>
      The decision may be independently verified using the <code class="mono">/verify</code> endpoint. Complete decision lineage, rule sequencing, and evidentiary artifacts are preserved within the immutable audit record and available for supervisory review.
    </div>

    {% if str_required %}
    <div class="regulatory break">
      <strong>Regulatory Note</strong><br><br>
      A Suspicious Transaction Report (STR) is required under PCMLTFA/FINTRAC guidelines.
      File within applicable statutory timeframe per regulatory guidance (policy version: {{ policy_version }}).
    </div>
    {% endif %}

    <div class="foot">
      <strong>DecisionGraph</strong> — Deterministic - Reproducible - Auditable<br>
      Generated {{ timestamp }}
    </div>
  </div>
</body>
</html>
