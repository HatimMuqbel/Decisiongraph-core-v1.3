<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DecisionGraph - AML/KYC Decision Report</title>
  <style>
    :root{
      --fg:#111827; --muted:#374151; --border:#d1d5db; --bg:#ffffff;
      --chip:#f3f4f6; --ok:#065f46; --warn:#92400e; --bad:#991b1b;
      --okbg:#ecfdf5; --warnbg:#fffbeb; --badbg:#fef2f2;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{ margin:0; padding:24px; font-family:var(--sans); color:var(--fg); background:var(--bg); }
    .page{ max-width:900px; margin:0 auto; }
    .header{ text-align:center; padding-bottom:20px; border-bottom:2px solid var(--fg); margin-bottom:24px; }
    .header h1{ font-size:24px; margin:0 0 4px 0; }
    .header .subtitle{ color:var(--muted); font-size:14px; }
    h2{ font-size:16px; margin:24px 0 12px 0; padding-bottom:6px; border-bottom:1px solid var(--border); }
    h3{ font-size:14px; margin:16px 0 8px 0; }
    .card{ border:1px solid var(--border); border-radius:8px; padding:16px; margin-bottom:16px; }
    .kv{ display:grid; grid-template-columns: 180px 1fr; gap:8px 16px; font-size:14px; }
    .kv .label{ color:var(--muted); }
    .kv .value{ font-weight:600; overflow-wrap:break-word; word-wrap:break-word; }
    .kv .value.mono{ font-family:var(--mono); font-size:13px; }
    table{ width:100%; border-collapse:collapse; font-size:13px; margin:12px 0; }
    th, td{ text-align:left; padding:10px 12px; border:1px solid var(--border); vertical-align:top; overflow-wrap:break-word; word-wrap:break-word; }
    th{ background:#f9fafb; font-size:12px; color:#1f2937; text-transform:uppercase; letter-spacing:0.05em; font-weight:600; }
    .status{ border-radius:8px; padding:16px; margin:12px 0; }
    .status.ok{ background:var(--okbg); border:1px solid #a7f3d0; }
    .status.warn{ background:var(--warnbg); border:1px solid #fcd34d; }
    .status.bad{ background:var(--badbg); border:1px solid #fecaca; }
    .status h3{ margin:0 0 8px 0; font-size:15px; }
    .status p{ margin:0; font-size:14px; color:var(--fg); }
    .status ul{ margin:8px 0 0 0; padding-left:20px; }
    .status li{ margin:4px 0; }
    .pill{ display:inline-block; padding:3px 10px; border-radius:999px; font-size:12px; font-weight:600; }
    .pill.na{ background:#f3f4f6; color:#374151; }
    .pill.req{ background:#fffbeb; color:var(--warn); }
    .pill.trig{ background:#fef2f2; color:var(--bad); }
    .pill.pass{ background:#ecfdf5; color:var(--ok); }
    .mono{ font-family:var(--mono); }
    .small{ font-size:13px; color:var(--muted); }
    .gate-block{ background:#f9fafb; border:1px solid var(--border); border-radius:8px; padding:16px; margin:12px 0; }
    .gate-block h4{ margin:0 0 12px 0; font-size:14px; display:flex; align-items:center; gap:8px; }
    .gate-section{ display:flex; align-items:flex-start; gap:8px; padding:8px 0; border-bottom:1px solid var(--border); }
    .gate-section:last-child{ border-bottom:none; }
    .gate-section .section-name{ font-weight:600; font-size:13px; }
    .gate-section .section-reason{ font-size:13px; color:var(--muted); margin-top:2px; }
    .provenance{ background:#f9fafb; border:1px solid var(--border); border-radius:8px; padding:16px; }
    .provenance .hash{ word-break:break-all; font-size:13px; color:#111827; }
    .statement{ background:#f0f9ff; border:1px solid #bae6fd; border-radius:8px; padding:16px; margin:16px 0; font-size:14px; }
    .regulatory{ background:#fefce8; border:1px solid #fde047; border-radius:8px; padding:16px; margin:16px 0; font-size:14px; }
    .foot{ margin-top:24px; padding-top:16px; border-top:1px solid var(--border); color:#374151; font-size:13px; text-align:center; }
    .break{ break-inside:avoid; page-break-inside:avoid; }
    .bar{ height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
    .bar > span{ display:block; height:100%; background:#1f2937; }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:700; background:#ecfdf5; color:#065f46; }
    .schema-panel{ border:1px solid var(--border); border-radius:8px; padding:12px; background:#f9fafb; font-size:12px; margin:16px 0; }
    .schema-panel ul{ margin:8px 0 0 18px; padding:0; }
    .schema-panel li{ margin:2px 0; }
    /* Precedent match cards */
    .match-grid{ display:grid; gap:12px; margin:12px 0; }
    .match-card{ border:1px solid var(--border); border-radius:8px; padding:16px; break-inside:avoid; }
    .match-card.below-threshold{ opacity:0.85; border-style:dashed; }
    .match-card.below-threshold::after{ content:'Below threshold ‚Äî nearest neighbor'; display:block; text-align:center; font-size:12px; color:#4b5563; margin-top:8px; font-style:italic; }
    .match-card-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .match-card-header .match-id{ font-family:var(--mono); font-size:13px; font-weight:600; }
    .match-card-header .match-sim{ font-size:20px; font-weight:700; }
    .match-meta{ display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; font-size:12px; }
    .match-meta .meta-chip{ background:var(--chip); padding:3px 10px; border-radius:999px; }
    .match-meta .meta-chip.supporting{ background:#ecfdf5; color:#065f46; }
    .match-meta .meta-chip.contrary{ background:#fef2f2; color:#991b1b; }
    .match-meta .meta-chip.neutral{ background:#fffbeb; color:#92400e; }
    .sim-bars{ display:grid; grid-template-columns:100px 1fr 40px; gap:4px 8px; align-items:center; font-size:12px; }
    .sim-bars .sim-label{ color:#1f2937; text-align:right; }
    .sim-bars .sim-track{ height:8px; background:#f3f4f6; border-radius:999px; overflow:hidden; position:relative; }
    .sim-bars .sim-fill{ height:100%; border-radius:999px; min-width:2px; }
    .sim-bars .sim-fill.high{ background:#059669; }
    .sim-bars .sim-fill.med{ background:#d97706; }
    .sim-bars .sim-fill.low{ background:#e5e7eb; }
    .sim-bars .sim-pct{ font-weight:600; font-size:11px; }
    .sim-bars .sim-pct.zero{ color:#94a3b8; }
    .match-codes{ font-family:var(--mono); font-size:12px; color:#374151; margin-top:8px; }
    /* Decision Integrity & Governance Alerts */
    .integrity-alert{ border:2px solid #dc2626; border-radius:8px; padding:16px 20px; margin:16px 0; background:#fef2f2; }
    .integrity-alert.critical{ border-color:#dc2626; background:#fef2f2; }
    .integrity-alert.warning{ border-color:#d97706; background:#fffbeb; }
    .integrity-alert.info{ border-color:#2563eb; background:#eff6ff; }
    .integrity-alert .alert-header{ display:flex; align-items:center; gap:8px; font-weight:700; font-size:14px; margin-bottom:8px; }
    .integrity-alert .alert-header.critical{ color:#dc2626; }
    .integrity-alert .alert-header.warning{ color:#92400e; }
    .integrity-alert .alert-header.info{ color:#1e40af; }
    .integrity-alert .alert-body{ font-size:13px; line-height:1.6; color:#1f2937; }
    .integrity-alert .alert-detail{ font-size:13px; color:#1f2937; margin-top:8px; font-family:var(--mono); }
    .integrity-alert .override-badge{ display:inline-block; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:700; background:#dc2626; color:#fff; margin-left:8px; }
    /* Export toolbar */
    .export-bar{ position:sticky; top:0; z-index:100; background:#fff; border-bottom:1px solid var(--border); padding:10px 0; margin-bottom:16px; display:flex; align-items:center; gap:10px; justify-content:flex-end; }
    .export-bar .brand{ margin-right:auto; font-weight:700; font-size:14px; color:var(--fg); }
    .btn-export{ display:inline-flex; align-items:center; gap:6px; padding:8px 16px; border-radius:6px; font-size:13px; font-weight:600; cursor:pointer; border:1px solid var(--border); background:#fff; color:var(--fg); transition:background .15s; }
    .btn-export:hover{ background:#f3f4f6; }
    .btn-export.primary{ background:#1f2937; color:#fff; border-color:#1f2937; }
    .btn-export.primary:hover{ background:#374151; }
    /* Precedent Intelligence Panel */
    .pi-grid{ display:grid; grid-template-columns:1fr 1fr; gap:16px; margin:12px 0; }
    @media (max-width:640px){ .pi-grid{ grid-template-columns:1fr; } }
    .pi-card{ border:1px solid var(--border); border-radius:8px; padding:16px; }
    .pi-card h4{ margin:0 0 8px 0; font-size:14px; }
    .pi-big{ font-size:28px; font-weight:700; line-height:1.2; }
    .pi-dim-bar{ height:8px; background:#e9ecef; border-radius:3px; overflow:hidden; margin:2px 0; }
    .pi-dim-bar > span{ display:block; height:100%; border-radius:3px; }
    details.pi-case{ border:1px solid var(--border); border-radius:8px; margin:6px 0; }
    details.pi-case summary{ padding:10px 16px; cursor:pointer; font-size:13px; display:flex; align-items:center; gap:8px; }
    details.pi-case summary::-webkit-details-marker{ display:none; }
    details.pi-case summary::before{ content:'‚ñ∏'; font-size:11px; transition:transform .15s; }
    details.pi-case[open] summary::before{ transform:rotate(90deg); }
    details.pi-case .pi-case-body{ padding:0 16px 12px 16px; font-size:13px; }
    .pi-chip{ display:inline-block; padding:2px 8px; margin:2px; border-radius:3px; font-size:11px; }
    .pi-chip.driver{ background:#d8f3dc; color:#2d6a4f; }
    .pi-chip.divergent{ background:#fde8e8; color:#9b2226; }
    .pi-chip.pre-shift{ background:#f3e8ff; color:#7c3aed; }
    /* Regime context panel */
    .regime-panel{ border:2px solid #d97706; border-radius:10px; padding:16px; margin:12px 0; background:#fffbeb; }
    .regime-panel h4{ margin:0 0 8px 0; font-size:14px; color:#92400e; }
    .regime-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:10px 0; }
    @media (max-width:640px){ .regime-grid{ grid-template-columns:1fr; } }
    .regime-card{ border:1px solid var(--border); border-radius:8px; padding:12px; }
    .regime-card.pre{ background:#f8fafc; }
    .regime-card.post{ background:#ecfdf5; border-color:#6ee7b7; }
    .regime-bar{ height:8px; background:#e9ecef; border-radius:3px; overflow:hidden; margin:3px 0; }
    .regime-bar > span{ display:block; height:100%; border-radius:3px; }
    .regime-bar .bar-allow{ background:#10b981; }
    .regime-bar .bar-edd{ background:#f59e0b; }
    .regime-bar .bar-block{ background:#ef4444; }
    .regime-badge{ display:inline-block; padding:2px 8px; border-radius:12px; font-size:10px; font-weight:600; }
    .regime-badge.high{ background:#fef2f2; color:#dc2626; border:1px solid #fca5a5; }
    .regime-badge.moderate{ background:#fffbeb; color:#d97706; border:1px solid #fcd34d; }
    .regime-badge.low{ background:#f8fafc; color:#64748b; border:1px solid #cbd5e1; }
    .pi-case.regime-limited{ border-left:3px solid #7c3aed; }
    .regime-warning{ background:#faf5ff; border:1px solid #c4b5fd; border-radius:6px; padding:8px 12px; margin-bottom:8px; font-size:12px; color:#6d28d9; }
    @media print {
      body { padding: 12px; }
      .page { max-width: 100%; }
      .export-bar { display: none !important; }
      .status, .gate-block, .provenance, .statement, .regulatory, .card, .match-card { break-inside: avoid; }
      h2 { break-after: avoid; }
      @page {
        size: A4;
        margin: 18mm 15mm 20mm 15mm;
        @bottom-center { content: "DecisionGraph ‚Äî Page " counter(page) " of " counter(pages); font-size: 9px; color: #cbd5e1; }
        @bottom-right { content: "Policy: {{ policy_hash[:12] if policy_hash else 'N/A' }}..."; font-size: 8px; color: #cbd5e1; font-family: monospace; }
      }
    }
  </style>
</head>
<body>
  {# Truncation safeguard ‚Äî detects incomplete words and appends "ed." #}
  {% macro safe_text(text) %}{% set t = text | default('') | string %}{% set markers = ['detecte', 'pendin', 'determina', 'indicat', 'transacti', 'investiga', 'escala', 'complia', 'regulato'] %}{% set ns = namespace(fixed=t) %}{% for m in markers %}{% if ns.fixed.rstrip().lower().endswith(m) %}{% set ns.fixed = ns.fixed.rstrip() + 'ed.' %}{% endif %}{% endfor %}{{ ns.fixed }}{% endmacro %}
  <div class="page">
    <div class="export-bar">
      <span class="brand">DecisionGraph Report</span>
      <button class="btn-export" onclick="window.print()" title="Print or save as PDF via browser print dialog">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
        Export PDF
      </button>
      <a class="btn-export primary" href="/report/{{ decision_id }}/export-html" download="decision-report-{{ decision_id_short }}-{{ timestamp[:10] if timestamp else 'unknown' }}.html" title="Download self-contained HTML report file">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
        Export HTML
      </a>
    </div>

    <div class="header">
      <h1>AML/KYC Investigation Report</h1>
      <div class="subtitle">Deterministic Regulatory Decision Engine</div>
    </div>

    <div class="schema-panel break">
      <div><strong>{{ report_schema_version }}</strong></div>
      <div class="small">Engine: {{ engine_version }} ¬∑ Policy: {{ policy_version }}</div>
      <div class="small">Change control: Report schema version v1 (frozen)</div>
      <ul>
        {% for section in report_sections %}
          <li>{{ section }}</li>
        {% endfor %}
      </ul>
    </div>

    {# ‚îÄ‚îÄ GAP-E: Senior Officer Summary ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    {% if senior_summary %}
    <div class="card break" style="border:2px solid #2563eb; border-radius:10px; background:#eff6ff; margin-bottom:16px;">
      <h3 style="margin:0 0 10px 0; font-size:15px; color:#1e40af;">Senior Officer Summary</h3>
      <div class="kv">
        <div class="label">Alert Trigger</div>
        <div class="value">{{ senior_summary.alert_trigger | default('N/A') }}</div>
        <div class="label">Suspicious Elements</div>
        <div class="value">{{ senior_summary.suspicious_elements | default('None') }}</div>
        <div class="label">Not Yet Established</div>
        <div class="value">{{ senior_summary.not_established | default('N/A') }}</div>
        <div class="label">Current Decision</div>
        <div class="value" style="font-weight:700;">{{ senior_summary.current_decision | default('N/A') }}</div>
        <div class="label">STR Pending</div>
        <div class="value">{{ senior_summary.str_pending | default('N/A') }}</div>
        <div class="label">Next Deadline</div>
        <div class="value">{{ senior_summary.next_evidence_deadline | default('N/A') }}</div>
      </div>
    </div>
    {% endif %}

    {% if decision_integrity_alert %}
    <div class="integrity-alert {% if decision_integrity_alert.severity == 'WARNING' %}warning{% elif decision_integrity_alert.severity == 'INFO' %}info{% endif %} break">
      <div class="alert-header {% if decision_integrity_alert.severity == 'CRITICAL' %}critical{% elif decision_integrity_alert.severity == 'WARNING' %}warning{% else %}info{% endif %}">
        ‚ö† Decision Integrity Alert
        {% if decision_integrity_alert.type == 'CLASSIFIER_OVERRIDE' %}<span class="override-badge">OVERRIDE APPLIED</span>{% endif %}
        {% if decision_integrity_alert.type == 'CLASSIFICATION_DISPOSITION_CONFLICT' %}<span class="override-badge">COMPLIANCE REVIEW REQUIRED</span>{% endif %}
      </div>
      <div class="alert-body">{{ decision_integrity_alert.message }}</div>
      {% if decision_integrity_alert.original_verdict %}
      <div class="alert-detail">
        Original verdict: {{ decision_integrity_alert.original_verdict }} ‚Üí Classifier outcome: {{ decision_integrity_alert.classifier_outcome }}
      </div>
      {% endif %}
    </div>
    {% endif %}

    {% if precedent_deviation_alert %}
    <div class="integrity-alert {% if precedent_deviation_alert.severity == 'CRITICAL' %}critical{% elif precedent_deviation_alert.severity == 'WARNING' %}warning{% elif precedent_deviation_alert.severity == 'INFO' %}info{% endif %} break">
      <div class="alert-header {% if precedent_deviation_alert.severity == 'CRITICAL' %}critical{% elif precedent_deviation_alert.severity == 'WARNING' %}warning{% else %}info{% endif %}">
        {% if precedent_deviation_alert.reporting_deviation %}
        üö® Precedent Deviation ‚Äî Defensibility Alert
        {% elif precedent_deviation_alert.disposition_deviation %}
        üìä Precedent Deviation ‚Äî Consistency Warning
        {% else %}
        üìä Precedent Deviation Signal
        {% endif %}
      </div>
      <div class="alert-body">{{ precedent_deviation_alert.message }}</div>
      {% if precedent_deviation_alert.disposition_deviation %}
      <div class="alert-detail">
        Disposition: {{ precedent_deviation_alert.disposition_deviation.case_disposition }} vs majority {{ precedent_deviation_alert.disposition_deviation.majority_disposition }} ({{ precedent_deviation_alert.disposition_deviation.majority_pct }}% of {{ precedent_deviation_alert.disposition_deviation.comparable_count }} comparable)
      </div>
      {% endif %}
      {% if precedent_deviation_alert.reporting_deviation %}
      <div class="alert-detail" style="color:#c62828; font-weight:600;">
        Reporting: {{ precedent_deviation_alert.reporting_deviation.case_reporting }} contradicts {{ precedent_deviation_alert.reporting_deviation.more_severe_pct }}% historical {{ precedent_deviation_alert.reporting_deviation.dominant_precedent_reporting }} filing rate
      </div>
      {% endif %}
      {% if precedent_deviation_alert.supporting is defined %}
      <div class="alert-detail">
        Supporting: {{ precedent_deviation_alert.supporting }} ¬∑ Contrary: {{ precedent_deviation_alert.contrary }} ¬∑ Evaluated: {{ precedent_deviation_alert.evaluated_disposition | default('N/A') }}
      </div>
      {% endif %}
      {% if precedent_deviation_alert.engine_note %}
      <div class="alert-detail" style="font-style:italic; margin-top:4px;">
        {{ precedent_deviation_alert.engine_note }}
      </div>
      {% endif %}
    </div>
    {% endif %}

    <h2>Administrative Details</h2>
    <div class="card break">
      <div class="kv">
        <div class="label">Decision ID</div>
        <div class="value mono">{{ decision_id_short }}...</div>
        <div class="label">Case ID</div>
        <div class="value mono">{{ case_id }}</div>
        <div class="label">Timestamp</div>
        <div class="value mono">{{ timestamp }}</div>
        <div class="label">Jurisdiction</div>
        <div class="value">{{ jurisdiction }}</div>
        <div class="label">Engine Version</div>
        <div class="value mono">{{ engine_version }}</div>
        <div class="label">Policy Version</div>
        <div class="value mono">{{ policy_version }}</div>
        <div class="label">Report Schema</div>
        <div class="value mono">{{ report_schema_version }}</div>
      </div>
    </div>

    <h2>Investigation Outcome Summary</h2>

    <!-- Disposition Ladder: governed is always the headline -->
    <div class="card break" style="border-left:4px solid {% if governed_disposition == 'STR_REQUIRED' %}#dc2626{% elif governed_disposition == 'NO_REPORT' %}#059669{% else %}#d97706{% endif %};">
      <div class="kv">
        <div class="label">Final Disposition</div>
        <div class="value" style="font-size:16px;">{{ governed_disposition | replace('_', ' ') }}</div>
        <div class="label">&nbsp;</div>
        <div class="value small" style="color:var(--muted);">
          {% if classification_outcome and classification_outcome != governed_disposition %}
            {% if classification_outcome == 'STR_REQUIRED' and governed_disposition != 'STR_REQUIRED' %}
              Classifier recommends {{ classification_outcome | replace('_', ' ') }}. Governed: {{ governed_disposition | replace('_', ' ') }} per gate evaluation. Conflict deferred to compliance officer.
            {% elif classification_outcome == 'NO_REPORT' and governed_disposition != 'NO_REPORT' %}
              Classifier recommends {{ classification_outcome | replace('_', ' ') }}. Governed: {{ governed_disposition | replace('_', ' ') }} per governance correction.
            {% else %}
              Governance Corrected ‚Äî {{ governed_disposition | replace('_', ' ') }}
            {% endif %}
          {% else %}
            Classifier Sovereign{% if suspicion_count == 0 %} ¬∑ Tier 1 = 0{% endif %}
          {% endif %}
        </div>
        <div class="label">Engine Output (Rules)</div>
        <div class="value mono" style="{% if engine_disposition != governed_disposition %}color:var(--muted); text-decoration:line-through;{% endif %}">{{ engine_disposition | replace('_', ' ') }}{% if engine_verdict and engine_verdict|lower != 'n/a' %} ‚Äî {{ engine_verdict }}{% endif %}</div>
        {% if verdict != engine_verdict %}
        <div class="label">Governed Verdict</div>
        <div class="value" style="font-size:15px; color:{% if verdict == 'PENDING_REVIEW' %}var(--warn){% elif verdict == 'STR_REQUIRED' %}var(--bad){% else %}var(--ok){% endif %}; font-weight:700;">{{ verdict | replace('_', ' ') }}</div>
        {% endif %}
      </div>
      {% if engine_disposition != governed_disposition %}
      <p class="small" style="margin-top:10px; font-style:italic; color:var(--muted);">
        Engine output differs from governed disposition. Governance correction applied ‚Äî governed outcome is authoritative.
        This correction ensures escalation is consistent with suspicion threshold requirements.
      </p>
      {% endif %}
    </div>

    {# ‚îÄ‚îÄ FIX-034: Required Actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    {% if required_actions and required_actions|length > 0 %}
    <h3>Required Actions</h3>
    <div class="status {% if str_required %}bad{% elif governed_disposition == 'EDD_REQUIRED' or governed_disposition == 'ESCALATE' %}warn{% else %}ok{% endif %} break">
      <ul style="margin:0; padding-left:20px;">
        {% for act in required_actions %}
        <li style="margin:4px 0;">
          {% if act.priority == 'MANDATORY' %}<strong style="color:var(--bad);">[{{ act.priority }}]</strong>
          {% elif act.priority == 'REQUIRED' %}<strong style="color:var(--warn);">[{{ act.priority }}]</strong>
          {% elif act.priority %}<span class="small">[{{ act.priority }}]</span>
          {% endif %}
          {{ act.action }}
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <div class="card break">
      <div class="kv">
        <div class="label">Investigation State</div>
        <div class="value">{{ investigation_state }}</div>
        <div class="label">Primary Typology</div>
        <div class="value">{{ primary_typology }}</div>
        <div class="label">Typology Assessment</div>
        <div class="value">
          {% if typology_stage in ['FORMING', 'EMERGING', 'VALIDATING'] %}
          Typology indicators detected at {{ typology_stage }} stage. Pattern not yet established &mdash; below escalation threshold.
          {% elif typology_stage == 'ESTABLISHED' %}
          Confirmed typology: {{ primary_typology }}. Pattern established &mdash; meets escalation criteria.
          {% elif typology_stage == 'NONE' %}
          No suspicious typology patterns detected.
          {% else %}
          Typology assessment: {{ typology_stage }}.
          {% endif %}
        </div>
        {% if regulatory_obligation %}
        <div class="label">Regulatory Obligation</div>
        <div class="value">{{ regulatory_obligation }}</div>
        {% endif %}
        {% if regulatory_position %}
        <div class="label">Regulatory Position</div>
        <div class="value">{{ regulatory_position }}</div>
        {% endif %}
        {% if decision_confidence %}
        <div class="label">Confidence</div>
        <div class="value">{{ decision_confidence }}{% if decision_confidence_score is defined %} ({{ decision_confidence_score }}%){% endif %}</div>
        {% endif %}
      </div>
      {% if decision_confidence %}
      <h4 style="margin-top:14px; margin-bottom:8px; font-size:13px;">Confidence Metrics</h4>
      <table style="font-size:12px; margin-bottom:8px;">
        <thead>
          <tr><th>Metric</th><th>Value</th><th>Definition</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>Decision Confidence</td>
            <td class="mono">{{ decision_confidence }} ({{ decision_confidence_score | default(0) }}%)</td>
            <td class="small">Composite score reflecting evidence completeness and rule alignment</td>
          </tr>
          <tr>
            <td>Precedent Alignment</td>
            <td class="mono">{{ precedent_alignment_pct | default(0) }}%</td>
            <td class="small">supporting_terminal / count(terminal_precedents) within same basis</td>
          </tr>
          <tr>
            <td>Precedent Match Rate</td>
            <td class="mono">{{ precedent_match_rate | default(0) }}% ({{ scored_precedent_count | default(0) }} / {{ total_comparable_pool | default(0) }})</td>
            <td class="small">Percentage of comparable pool meeting similarity threshold</td>
          </tr>
        </tbody>
      </table>
      {% endif %}
      <p class="small" style="margin-top:10px;">{{ safe_text(decision_explainer) }}</p>
    </div>

    {% if canonical_outcome %}
    <h3>Canonical Outcome</h3>
    <div class="card break">
      <div class="kv">
        <div class="label">Disposition</div>
        <div class="value" style="font-weight:700;">{{ canonical_outcome.disposition | default('N/A') | replace('_', ' ') }}</div>
        <div class="label">Disposition Basis</div>
        <div class="value">{{ canonical_outcome.disposition_basis | default('N/A') | replace('_', ' ') }}</div>
        <div class="label">Reporting</div>
        <div class="value">{{ canonical_outcome.reporting | default('N/A') | replace('_', ' ') }}{% if canonical_outcome.reporting_note %} <span class="small">({{ canonical_outcome.reporting_note }})</span>{% endif %}</div>
      </div>
    </div>
    {% endif %}

    {# ‚îÄ‚îÄ GAP-B: STR Decision Authority ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    {% if str_decision_frame and str_decision_frame.decision_owner %}
    <h3>STR Decision Authority</h3>
    <div class="card break" style="border-left:4px solid #1e40af;">
      <div class="kv">
        <div class="label">Decision Owner</div>
        <div class="value" style="font-weight:700;">{{ str_decision_frame.decision_owner.role }}</div>
        <div class="label">Basis</div>
        <div class="value small">{{ str_decision_frame.decision_owner.basis }}</div>
        <div class="label">Decision Deadline</div>
        <div class="value mono">{{ str_decision_frame.decision_deadline | default('N/A') }}</div>
        <div class="label">Authority</div>
        <div class="value small">{{ str_decision_frame.authority_basis | default('N/A') }}</div>
      </div>
      {% if str_decision_frame.decision_options %}
      <h4 style="margin:14px 0 6px 0; font-size:13px;">Decision Options</h4>
      <table style="font-size:12px;">
        <thead><tr><th>Option</th><th>Conditions</th></tr></thead>
        <tbody>
          {% for opt in str_decision_frame.decision_options %}
          <tr>
            <td style="font-weight:600;">{{ opt.option }}</td>
            <td>{{ opt.conditions }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
      {% if str_decision_frame.minimum_evidence %}
      <h4 style="margin:14px 0 6px 0; font-size:13px;">Minimum Evidence Required</h4>
      <ol style="margin:0; padding-left:20px; font-size:13px;">
        {% for item in str_decision_frame.minimum_evidence %}
        <li style="margin:3px 0;">{{ item }}</li>
        {% endfor %}
      </ol>
      {% endif %}
    </div>
    {% endif %}

    {# ‚îÄ‚îÄ Decision Path (5-step narrative trace) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    {% if decision_path_narrative and decision_path_narrative.steps %}
    <h2>Decision Path</h2>
    <div class="card break" style="border-left:4px solid #1f2937;">
      {% for step in decision_path_narrative.steps %}
      <div style="{% if not loop.first %}margin-top:16px; padding-top:16px; border-top:1px solid var(--border);{% endif %}">
        <div style="font-weight:700; font-size:14px; margin-bottom:6px;">
          {{ step.symbol }} {{ step.title }}
        </div>
        {% for line in step.detail_lines %}
        <div class="small" style="margin-left:24px; margin-bottom:2px;">{{ line }}</div>
        {% endfor %}
        <div style="margin-left:24px; margin-top:6px; font-weight:600; font-size:13px; color:var(--muted);">
          &rarr; {{ step.arrow_line }}
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <h3>Case Facts</h3>
    {# GAP-C: Structured 3-section case facts when available #}
    {% if case_facts_sections and (case_facts_sections.transaction or case_facts_sections.customer or case_facts_sections.screening) %}
      {% for section_key, section_title in [('transaction', 'Transaction Context'), ('customer', 'Customer Context'), ('screening', 'Screening Context')] %}
        {% set items = case_facts_sections[section_key] %}
        {% if items and items|length > 0 %}
        <h4 style="margin:12px 0 6px 0; font-size:13px; color:var(--muted);">{{ section_title }}</h4>
        <table class="break" style="margin-bottom:8px;">
          <thead>
            <tr><th>Field</th><th>Value</th></tr>
          </thead>
          <tbody>
            {% for fact in items %}
            <tr>
              <td>{{ fact.field }}</td>
              <td class="mono">{{ fact.value }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% endif %}
      {% endfor %}
    {% else %}
    <table class="break">
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        {% for fact in transaction_facts %}
        <tr>
          <td>{{ fact.field }}</td>
          <td class="mono">{{ fact.value }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}

    <h2>Case Classification</h2>
    <div class="card break">
      <div class="kv">
        <div class="label">Source</div>
        <div class="value">{{ source_type }}</div>
        {% if is_seed %}
        <div class="label">Seed Category</div>
        <div class="value">{{ seed_category }}</div>
        <div class="label">Scenario Code</div>
        <div class="value mono">{{ scenario_code }}</div>
        {% endif %}
      </div>
      {% if is_seed %}
        <p class="small" style="margin-top:10px;">
          Synthetic training case (seeded).
        </p>
      {% endif %}
    </div>

    <h2>Regulatory Determination</h2>
    {% if is_mandatory_hard_stop %}
      <div class="status bad break" style="border-left:6px solid #991b1b;">
        {% if 'SANCTIONS' in (hard_stop_reason | default('') | upper) %}
        <h3>SANCTIONS MATCH ‚Äî TRANSACTION PROHIBITED</h3>
        <p>Screening match detected against designated sanctions list. Transaction blocked under mandatory regulatory obligation. This is not a discretionary determination.</p>
        {% elif 'ADVERSE_MEDIA' in (hard_stop_reason | default('') | upper) %}
        <h3>HARD STOP ‚Äî ADVERSE MEDIA MLTF</h3>
        <p>Adverse media with confirmed money laundering or terrorist financing link detected. STR filing mandatory under regulatory obligation. This is not a discretionary determination.</p>
        {% else %}
        <h3>HARD STOP ‚Äî {{ hard_stop_reason | default('MANDATORY RULE TRIGGER') | upper }}</h3>
        <p>Hard stop triggered under mandatory regulatory obligation. This is not a discretionary determination.</p>
        {% endif %}
        <p style="margin-top:12px;" class="small"><strong>Required Actions:</strong></p>
        <ul class="small">
          <li>File STR within statutory timeframe ‚Äî mandatory</li>
          {% if 'SANCTIONS' in (hard_stop_reason | default('') | upper) %}
          <li>Freeze transaction pending compliance review</li>
          {% endif %}
          <li>Notify MLRO / Chief Compliance Officer</li>
          <li>Preserve all transaction records for regulatory examination</li>
        </ul>
      </div>
    {% elif governed_disposition == "NO_REPORT" %}
      <div class="status ok break">
        <h3>NO_REPORT ‚Äî Alert Cleared</h3>
        <p>Based on available information at time of review, the totality of indicators does not meet the threshold for reasonable grounds to suspect money laundering or terrorist financing activity.</p>
        <p style="margin-top:12px;" class="small"><strong>Recommended Actions:</strong></p>
        <ul class="small">
          <li>Document clearance rationale</li>
          <li>Return to standard monitoring parameters</li>
          <li>No regulatory filing required at this time</li>
        </ul>
      </div>
    {% elif governed_disposition == "STR_REQUIRED" %}
      <div class="status bad break">
        <h3>FILE_STR ‚Äî Suspicious Transaction Report Required</h3>
        <p>Suspicion threshold met under PCMLTFA/FINTRAC guidance. Reasonable grounds exist to suspect that the transaction or attempted transaction is related to the commission or attempted commission of a money laundering or terrorist financing offence.</p>
        {% if escalation_reasons and escalation_reasons|length > 0 %}
          <p style="margin-top:12px;"><strong>Primary Suspicion Drivers:</strong></p>
          <ul>
            {% for reason in escalation_reasons[:4] %}
              <li>{{ reason }}</li>
            {% endfor %}
          </ul>
        {% endif %}
        <p style="margin-top:12px;" class="small"><strong>Recommended Actions:</strong></p>
        <ul class="small">
          <li>File STR within 30 days of suspicion formation</li>
          <li>Apply Enhanced Due Diligence measures</li>
          <li>Implement ongoing monitoring with elevated parameters</li>
          <li>Document investigative rationale in case file</li>
        </ul>
      </div>
    {% elif governed_disposition == "ESCALATE" %}
      <div class="status bad break">
        <h3>ESCALATE ‚Äî Compliance Review Required</h3>
        <p>Suspicion indicators are present and warrant escalation to senior compliance. Final regulatory determination pending review.</p>
        {% if escalation_reasons and escalation_reasons|length > 0 %}
          <p style="margin-top:12px;"><strong>Escalation Triggers:</strong></p>
          <ul>
            {% for reason in escalation_reasons[:4] %}
              <li>{{ reason }}</li>
            {% endfor %}
          </ul>
        {% endif %}
        <p style="margin-top:12px;" class="small"><strong>Recommended Actions:</strong></p>
        <ul class="small">
          <li>Escalate to Senior Analyst / Compliance Officer</li>
          <li>Apply Enhanced Due Diligence measures</li>
          <li>Document escalation rationale in case file</li>
          <li>Determine if STR filing is warranted after review</li>
        </ul>
      </div>
    {% else %}
      <div class="status warn break">
        <h3>EDD_REQUIRED ‚Äî Enhanced Due Diligence Required</h3>
        {% if decision_integrity_alert and decision_integrity_alert.severity == 'CRITICAL' %}
        <div style="background:#fef2f2; border:1px solid #fca5a5; border-radius:6px; padding:12px; margin-bottom:12px;">
          <strong style="color:#dc2626;">‚ö† {{ decision_integrity_alert.type | replace('_', ' ') }}</strong><br>
          <span class="small" style="color:#1f2937;">{{ decision_integrity_alert.message }}</span>
        </div>
        {% endif %}
        {% if decision_integrity_alert and decision_integrity_alert.type == 'CLASSIFICATION_DISPOSITION_CONFLICT' %}
        <p>Classifier identified Tier 1 suspicion indicators that would ordinarily meet the STR threshold. A compliance officer must review the indicators and make the final STR determination. Until reviewed, Enhanced Due Diligence applies.</p>
        {% else %}
        <p>Additional information required before regulatory determination can be finalized. Current indicators warrant enhanced scrutiny but do not independently establish reasonable grounds to suspect.</p>
        {% endif %}
        {% if engine_disposition != governed_disposition %}
        <p class="small" style="margin-top:8px; font-style:italic;">
          {% if classification_outcome == 'STR_REQUIRED' and governed_disposition != 'STR_REQUIRED' %}
          Engine originally suggested {{ engine_disposition | replace('_', ' ') }}. Classifier determined STR REQUIRED, but Gate 1 blocked escalation ‚Äî governed outcome is {{ governed_disposition | replace('_', ' ') }} pending compliance review.
          {% elif classification_outcome == governed_disposition %}
          Engine originally suggested {{ engine_disposition | replace('_', ' ') }}. Classifier sovereignty applied ‚Äî {{ governed_disposition | replace('_', ' ') }} is the governed outcome.
          {% else %}
          Engine originally suggested {{ engine_disposition | replace('_', ' ') }}. Governance correction applied ‚Äî {{ governed_disposition | replace('_', ' ') }} is the governed outcome.
          {% endif %}
        </p>
        {% endif %}
        <p style="margin-top:12px;" class="small"><strong>Recommended Actions:</strong></p>
        <ul class="small">
          <li>Complete Enhanced Due Diligence review</li>
          {% if decision_integrity_alert and decision_integrity_alert.type == 'CLASSIFICATION_DISPOSITION_CONFLICT' %}
          <li><strong>Compliance officer review of Tier 1 indicators required before final disposition</strong></li>
          {% endif %}
          <li>Obtain additional documentation as required</li>
          <li>Escalate to Senior Analyst / Compliance Officer within 5 business days</li>
        </ul>
      </div>
    {% endif %}

    <div class="card break">
      <h3>Regulatory Escalation Summary</h3>
      <p class="small">{{ safe_text(escalation_summary) }}</p>
      {% if decision_confidence %}
      <p class="small" style="margin-top:10px;"><strong>Decision Confidence:</strong> {{ decision_confidence }}</p>
      <p class="small">{{ decision_confidence_reason }}</p>
      {% endif %}
      {% set _reg_align = enhanced_precedent.governed_alignment_count | default(0) if enhanced_precedent is defined and enhanced_precedent else 0 %}
      {% set _reg_total = enhanced_precedent.governed_alignment_total | default(0) if enhanced_precedent is defined and enhanced_precedent else 0 %}
      {% if _reg_total > 0 %}
      <p class="small" style="margin-top:10px;"><strong>Precedent alignment:</strong> {{ _reg_align }}/{{ _reg_total }} ({{ "%.0f"|format(_reg_align / _reg_total * 100) }}%) of comparable precedents match the governed disposition.</p>
      {% endif %}
    </div>

    {% if analyst_actions and analyst_actions|length > 0 %}
    <h3 style="margin-top:16px;">Analyst Actions</h3>
    <div class="card break" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <span class="small" style="margin-right:8px;">Available for <strong>{{ governed_disposition | replace('_', ' ') }}</strong>:</span>
      {% for act in analyst_actions %}
      {% set is_approval = act.label in ('Approve', 'Confirm Clearance') %}
      {% set block_approval = decision_integrity_alert or display_verdict == 'PENDING_REVIEW' or (precedent_analysis is defined and precedent_analysis and precedent_analysis.available and precedent_analysis.contrary_precedents > precedent_analysis.supporting_precedents and (precedent_analysis.supporting_precedents + precedent_analysis.contrary_precedents) > 0) %}
      {% if not (is_approval and block_approval) %}
      <span style="display:inline-block; padding:8px 16px; border-radius:6px; font-size:13px; font-weight:{% if act.primary %}700{% else %}500{% endif %}; border:1px solid {% if act.primary %}#1f2937{% else %}var(--border){% endif %}; background:{% if act.primary %}#1f2937{% else %}#fff{% endif %}; color:{% if act.primary %}#fff{% else %}var(--fg){% endif %};">{{ act.label }}</span>
      {% endif %}
      {% endfor %}
    </div>
    {% endif %}

    {% if edd_recommendations and edd_recommendations|length > 0 %}
    <h2>Recommended Actions</h2>
    <div class="card break">
      <ol class="small" style="margin:0; padding-left:20px;">
        {% for rec in edd_recommendations %}
        <li style="margin-bottom:8px;">
          <strong>{{ rec.action }}</strong>
          {% if rec.reference %}<br><span class="small" style="font-style:italic;">Ref: {{ rec.reference }}</span>{% endif %}
        </li>
        {% endfor %}
      </ol>
    </div>
    {% endif %}

    {# ‚îÄ‚îÄ FIX-029: Disposition Reconciliation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    {% if disposition_reconciliation %}
    <h2>Disposition Reconciliation</h2>
    {% if disposition_reconciliation.consistent %}
    <div class="status ok break">
      <p>All disposition layers consistent. No override applied.</p>
    </div>
    {% else %}
    <div class="card break">
      <p class="small" style="margin-bottom:12px; font-style:italic;">{{ disposition_reconciliation.summary }}</p>
      {% for diff in disposition_reconciliation.differences %}
      <div style="border-left:3px solid var(--warn); padding-left:12px; margin-bottom:12px;">
        <p style="margin:0 0 4px 0; font-size:13px;">
          <strong>{{ diff.component_a }}</strong> produced <code class="mono">{{ diff.value_a | replace('_', ' ') }}</code>.
          <strong>{{ diff.component_b }}</strong> {% if diff.value_a != diff.value_b %}independently determined{% else %}agrees:{% endif %}
          <code class="mono" style="font-weight:700;">{{ diff.value_b | replace('_', ' ') }}</code>.
        </p>
        <p class="small" style="margin:0 0 2px 0;">{{ diff.reason }}</p>
        <p class="small" style="margin:0; color:var(--muted); font-style:italic;">Authority: {{ diff.authority }}</p>
      </div>
      {% endfor %}
    </div>
    {% endif %}
    {% endif %}

    <h2>Suspicion Classification</h2>
    <div class="card break">
      <div class="kv">
        <div class="label">Classifier Outcome</div>
        <div class="value"><strong>{{ classification_outcome }}</strong></div>
        <div class="label">Classifier Authority</div>
        {% if classification_outcome != governed_disposition %}
        {% set _has_upheld_gate = gate_override_explanations | default([]) | selectattr('upheld', 'defined') | selectattr('upheld') | list | length > 0 %}
        {% if _has_upheld_gate %}
        <div class="value" style="color:#059669; font-weight:600;">GATE AUTHORITY ‚Äî Gate blocked {{ classification_outcome | replace('_', ' ') }}; governed disposition is {{ governed_disposition | replace('_', ' ') }}</div>
        {% else %}
        <div class="value" style="color:var(--warn); font-weight:600;">OVERRIDDEN ‚Äî Classifier recommends {{ classification_outcome | replace('_', ' ') }}, governed disposition is {{ governed_disposition | replace('_', ' ') }}</div>
        {% endif %}
        {% else %}
        <div class="value" style="color:#059669; font-weight:600;">SOVEREIGN ‚Äî Hard Gate</div>
        {% endif %}
        <div class="label">Suspicion Indicators (Tier 1)</div>
        <div class="value">{{ suspicion_count }}</div>
        <div class="label">Investigative Signals (Tier 2)</div>
        <div class="value">{{ investigative_count }}</div>
        <div class="label">Classifier Version</div>
        <div class="value mono">{{ classification.classifier_version }}</div>
      </div>
      <p class="small" style="margin-top:10px;">{{ classification_reason }}</p>
      <p class="small" style="margin-top:6px; color:var(--muted);">
        {% if classification_outcome == 'STR_REQUIRED' and governed_disposition != 'STR_REQUIRED' %}
        Decision Hierarchy: Classifier recommends {{ classification_outcome | replace('_', ' ') }}, but gate evaluation produced {{ governed_disposition | replace('_', ' ') }}. Conflict deferred to compliance officer for final STR determination.
        {% elif suspicion_count == 0 %}
        Decision Hierarchy: Classifier ‚Üí Rules ‚Üí Narrative ‚Üí Governance. STR is impossible when Tier 1 = 0. No rule, gate, or precedent can override this.
        {% elif governed_disposition != classification_outcome %}
        Decision Hierarchy: Classifier recommends {{ classification_outcome | replace('_', ' ') }}. Governed: {{ governed_disposition | replace('_', ' ') }}. Conflict deferred to compliance officer.
        {% else %}
        Decision Hierarchy: Classifier ‚Üí Rules ‚Üí Narrative ‚Üí Governance. Classifier is sovereign ‚Äî final authority on suspicion determination.
        {% endif %}
      </p>
      {% if tier1_signals and tier1_signals|length > 0 %}
      <h4 style="margin-top:14px; margin-bottom:6px; color:#b91c1c;">Tier 1 ‚Äî Suspicion Indicators (RGS Contributors)</h4>
      <table style="font-size:12px;">
        <thead><tr><th>Code</th><th>Source</th><th>Detail</th></tr></thead>
        <tbody>
          {% for sig in tier1_signals %}
          <tr><td class="mono">{{ sig.code }}</td><td>{{ sig.source }}</td><td>{{ sig.detail }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
      {% if tier2_signals and tier2_signals|length > 0 %}
      <h4 style="margin-top:14px; margin-bottom:6px; color:#92400e;">Tier 2 ‚Äî Investigative Signals (EDD Triggers)</h4>
      <table style="font-size:12px;">
        <thead><tr><th>Code</th><th>Source</th><th>Detail</th></tr></thead>
        <tbody>
          {% for sig in tier2_signals %}
          <tr><td class="mono">{{ sig.code }}</td><td>{{ sig.source }}</td><td>{{ sig.detail }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
      {% if classification.mitigation_applied %}
      <div class="status warn" style="margin-top:12px; padding:12px;">
        <strong>Mitigation Applied</strong><br>
        <span class="small">{{ classification.mitigation_reason }}</span>
      </div>
      {% endif %}
      {% if precedent_consistency_alert %}
      <div class="status warn" style="margin-top:12px; padding:12px;">
        <strong>‚ö†Ô∏è PRECEDENT CONSISTENCY ALERT</strong><br>
        <span class="small"><strong style="color:#92400e;">Precedent Consistency:</strong> {{ precedent_consistency_detail }}</span>
      </div>
      {% endif %}
    </div>

    <h2>Decision Drivers</h2>
    <div class="card break">
      {% if decision_drivers and decision_drivers|length > 0 %}
      <ul class="small">
        {% for driver in decision_drivers %}
          <li>{{ driver }}</li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="small">Decision drivers derived from rule evaluation were not available in this record.</p>
      {% endif %}
    </div>

    {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
    {# PRECEDENT INTELLIGENCE PANEL                                 #}
    {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
    {% if precedent_analysis and precedent_analysis.available %}
    <h2>Precedent Intelligence</h2>
    {# GAP-D: Backend-sourced precedent disclaimer #}
    <p class="small"><em>{{ enhanced_precedent.precedent_disclaimer | default('Precedent analysis is non-authoritative; used only for consistency review and peer comparison; never overrides gates, rules, or statutory reporting determinations.') }} Absence of precedent matches does not imply the recommendation is incorrect.</em></p>

    {% if precedent_pool_warning %}
    <div class="integrity-alert warning break">
      <div class="alert-header warning">‚ö† Thin Precedent Pool</div>
      <div class="alert-body">{{ precedent_pool_warning.message }}</div>
      <div class="alert-detail">Pool size: {{ precedent_pool_warning.pool_size }} ¬∑ Minimum required: {{ precedent_pool_warning.minimum_required }}</div>
    </div>
    {% endif %}

    {# ‚îÄ‚îÄ Row 1: Governed Alignment (Two-Axis) + Terminal Confidence ‚îÄ‚îÄ #}
    {% set gov_align = enhanced_precedent.governed_alignment_count | default(precedent_analysis.governed_alignment_count | default(0)) %}
    {% set gov_total = enhanced_precedent.governed_alignment_total | default(precedent_analysis.governed_alignment_total | default(0)) %}
    {% set op_align = enhanced_precedent.op_alignment_count | default(0) %}
    {% set op_total = enhanced_precedent.op_alignment_total | default(0) %}
    {% set reg_align = enhanced_precedent.reg_alignment_count | default(0) %}
    {% set reg_total = enhanced_precedent.reg_alignment_total | default(0) %}
    {% set comb_align = enhanced_precedent.combined_alignment_count | default(0) %}
    <div class="pi-grid">
      <div class="pi-card" style="border-left:4px solid var(--ok);">
        <h4>Governed Disposition Alignment</h4>
        <p class="small" style="margin:0 0 4px 0; color:var(--muted);">Full comparable pool</p>
        {% if gov_total > 0 %}
        {% set gov_pct = (gov_align / gov_total * 100) | round | int %}
        <div class="pi-big" style="color:{% if gov_pct >= 80 %}var(--ok){% elif gov_pct >= 50 %}var(--warn){% else %}var(--bad){% endif %};">
          {{ gov_align }}/{{ gov_total }} <span style="font-size:16px; font-weight:400;">({{ gov_pct }}%)</span>
        </div>
        <div class="bar" style="margin:8px 0;"><span style="width:{{ gov_pct }}%; background:{% if gov_pct >= 80 %}#059669{% elif gov_pct >= 50 %}#d97706{% else %}#dc2626{% endif %};"></span></div>
        {% if op_total > 0 %}
        {% set op_pct = (op_align / op_total * 100) | round | int %}
        {% set reg_pct = (reg_align / reg_total * 100) | round | int if reg_total > 0 else 0 %}
        {% set comb_pct = (comb_align / gov_total * 100) | round | int %}
        <div style="margin-top:8px; font-size:12px; line-height:1.8;">
          <div style="display:flex; justify-content:space-between;">
            <span>Operational alignment:</span>
            <span style="font-weight:600; color:{% if op_pct >= 80 %}var(--ok){% elif op_pct >= 50 %}var(--warn){% else %}var(--bad){% endif %};">{{ op_align }}/{{ op_total }} ({{ op_pct }}%)</span>
          </div>
          <div style="font-size:11px; color:var(--muted); margin:0 0 6px 0; line-height:1.5;">
            What did the bank decide to do? ALLOW the transaction, require Enhanced Due Diligence, or BLOCK/exit. This shows what percentage of comparable past cases the bank made the same operational decision on.
          </div>
          <div style="display:flex; justify-content:space-between;">
            <span>Regulatory alignment:</span>
            <span style="font-weight:600; color:{% if reg_pct >= 80 %}var(--ok){% elif reg_pct >= 50 %}var(--warn){% elif enhanced_precedent.reg_alignment_all_undetermined | default(false) %}var(--muted){% else %}var(--bad){% endif %};">{{ reg_align }}/{{ reg_total }} ({{ reg_pct }}%)</span>
          </div>
          <div style="font-size:11px; color:var(--muted); margin:0 0 6px 0; line-height:1.5;">
            What did the bank decide to report? File an STR with FINTRAC, or no filing required. This shows what percentage of comparable past cases the bank made the same reporting decision on.
          </div>
          {% if reg_pct == 0 and enhanced_precedent.reg_alignment_all_undetermined | default(false) %}
          <div style="font-size:11px; color:var(--muted); margin:2px 0 2px 0; font-style:italic;">
            Current case requires Enhanced Due Diligence before reporting determination. Comparable cases have resolved reporting, but alignment cannot be computed until this case's regulatory posture is determined.
          </div>
          {% endif %}
          <div style="display:flex; justify-content:space-between;">
            <span>Combined alignment:</span>
            <span style="font-weight:600; color:{% if comb_pct >= 80 %}var(--ok){% elif comb_pct >= 50 %}var(--warn){% else %}var(--bad){% endif %};">{{ comb_align }}/{{ gov_total }} ({{ comb_pct }}%)</span>
          </div>
          <div style="font-size:11px; color:var(--muted); margin:0 0 2px 0; line-height:1.5;">
            How many comparable past cases match the current case on both decisions ‚Äî same operational action AND same reporting decision? Only cases where the bank decided the same thing on both fronts count here.
          </div>
        </div>
        {% if enhanced_precedent.two_axis_alignment_narrative %}
        <p class="small" style="margin:6px 0 0 0; font-style:italic;">{{ enhanced_precedent.two_axis_alignment_narrative }}</p>
        {% endif %}
        {% else %}
        <p class="small" style="margin:4px 0 0 0;">
          {% if gov_align == gov_total %}All comparable precedents match the governed disposition.
          {% elif gov_align > gov_total / 2 %}Majority match ({{ gov_align }}/{{ gov_total }}).
          {% else %}Minority match ‚Äî review advised.{% endif %}
        </p>
        {% endif %}
        {% else %}
        <div class="pi-big" style="color:var(--muted);">N/A</div>
        <p class="small">No comparable precedents in pool.</p>
        {% endif %}
      </div>

      <div class="pi-card" style="border-left:4px solid #2563eb;">
        <h4>Terminal Confidence</h4>
        {% if is_mandatory_hard_stop %}
        <div class="pi-big" style="color:#059669;">CERTAIN</div>
        <p class="small" style="margin:2px 0 8px 0;">Mandatory determination ‚Äî no discretion applicable.</p>
        {% elif enhanced_precedent.confidence_dimensions is defined and enhanced_precedent.confidence_dimensions %}
        {% set cl = enhanced_precedent.confidence_level | default('NONE') | upper %}
        {% set cl_color = {'VERY_HIGH': '#059669', 'HIGH': '#28a745', 'MODERATE': '#d97706', 'LOW': '#fd7e14', 'NONE': '#dc2626'}.get(cl, '#6c757d') %}
        <div class="pi-big" style="color:{{ cl_color }};">{{ cl | replace('_', ' ') }}</div>
        {% if enhanced_precedent.confidence_bottleneck %}
        <p class="small" style="margin:2px 0 8px 0;">Bottleneck: {{ enhanced_precedent.confidence_bottleneck | replace('_', ' ') | title }}</p>
        {% endif %}
        {% if enhanced_precedent.confidence_hard_rule %}
        <p class="small" style="color:var(--bad); margin:0 0 8px 0;"><em>{{ enhanced_precedent.confidence_hard_rule }}</em></p>
        {% endif %}
        {% for dim in enhanced_precedent.confidence_dimensions %}
        <div style="margin-bottom:4px;">
          <div style="display:flex; justify-content:space-between; font-size:11px;">
            <span>{{ dim.name | replace('_', ' ') | title }}</span>
            <span style="font-weight:600;">{{ dim.level | replace('_', ' ') }}{% if dim.bottleneck %} ‚òÖ{% endif %}</span>
          </div>
          {% set bp = {'NONE': 0, 'LOW': 25, 'MODERATE': 50, 'HIGH': 75, 'VERY_HIGH': 95}.get(dim.level | upper, 0) %}
          {% set bc = {'NONE': '#dc3545', 'LOW': '#fd7e14', 'MODERATE': '#ffc107', 'HIGH': '#28a745', 'VERY_HIGH': '#20c997'}.get(dim.level | upper, '#6c757d') %}
          <div class="pi-dim-bar"><span style="width:{{ bp }}%; background:{{ bc }};"></span></div>
          {% if dim.note %}<div class="small" style="color:#64748b; margin-top:1px;">{{ dim.note }}</div>{% endif %}
        </div>
        {% endfor %}
        {% else %}
        {% set decisive_total = precedent_analysis.decisive_total | default(-1) %}
        {% if decisive_total == 0 %}
        <div class="pi-big" style="color:var(--muted);">N/A</div>
        <p class="small">No terminal precedents in pool.</p>
        {% else %}
        <div class="pi-big">{{ "%.0f"|format(precedent_analysis.precedent_confidence * 100) }}%</div>
        {% endif %}
        {% endif %}
      </div>
    </div>

    {# ‚îÄ‚îÄ Row 2: Institutional Posture ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    {% if enhanced_precedent and (enhanced_precedent.pattern_summary or enhanced_precedent.institutional_posture) %}
    <div class="statement break" style="margin-top:12px;">
      {% if enhanced_precedent.pattern_summary %}
      <strong style="color:#1e40af;">Institutional Pattern</strong>
      <p style="font-size:14px; line-height:1.6; margin:4px 0 0 0;">{{ enhanced_precedent.pattern_summary }}</p>
      {% endif %}
      {% if enhanced_precedent.suspicion_posture is defined and enhanced_precedent.suspicion_posture %}
      <div style="margin-top:10px; padding-top:10px; border-top:1px solid var(--border);">
        {% for line in enhanced_precedent.suspicion_posture %}
        <p style="font-size:14px; line-height:1.6; margin:{% if loop.first %}0{% else %}4px{% endif %} 0 0 0;{% if line.startswith('\u26a0') %} color:var(--bad); font-weight:600;{% endif %}">{{ line }}</p>
        {% endfor %}
      </div>
      {% endif %}
      {% if enhanced_precedent.institutional_posture %}
      <strong style="color:#1e40af; {% if enhanced_precedent.pattern_summary %}margin-top:10px; display:block;{% endif %}">Institutional Posture</strong>
      <p style="font-size:14px; line-height:1.6; margin:4px 0 0 0;">{{ enhanced_precedent.institutional_posture }}</p>
      {% endif %}
      {% if enhanced_precedent.first_impression_alert is defined and enhanced_precedent.first_impression_alert %}
      <div style="margin-top:10px; padding:10px 12px; background:rgba(220,38,38,0.08); border-left:3px solid var(--bad); border-radius:4px;">
        <p style="font-size:13px; font-weight:600; color:var(--bad); margin:0;">&#9888; FIRST-OF-KIND DETERMINATION</p>
        <p class="small" style="margin:4px 0 0 0;">{{ enhanced_precedent.first_impression_alert }}</p>
      </div>
      {% endif %}
      {% if enhanced_precedent.regime_analysis and enhanced_precedent.regime_analysis.shifts_detected %}
      {% set _ra = enhanced_precedent.regime_analysis %}
      {% set _shift0 = _ra.shifts_detected[0] %}
      <div style="margin-top:10px; padding-top:10px; border-top:1px solid var(--border);">
        <p class="small" style="color:#d97706; font-style:italic;">Note: Historical practice spans two policy regimes. Under current policy (post {{ _shift0.effective_date }}), {{ _ra.post_shift_count }} comparable cases available. {{ _ra.pct_regime_limited }}% of pool decided under prior policy. Current posture reflects {{ _shift0.name }}.</p>
      </div>
      {% endif %}
    </div>
    {% endif %}

    {# ‚îÄ‚îÄ Row 1.5: Policy Regime Context (only when shifts detected) ‚îÄ‚îÄ #}
    {% if enhanced_precedent and enhanced_precedent.regime_analysis and enhanced_precedent.regime_analysis.shifts_detected %}
    {% set ra = enhanced_precedent.regime_analysis %}
    <div class="regime-panel break">
      <h4>&#9888; Policy Regime Context
        <span class="regime-badge {{ ra.magnitude }}" style="margin-left:8px;">{{ ra.magnitude | upper }} IMPACT</span>
      </h4>
      {% for shift in ra.shifts_detected %}
      <p style="font-size:14px; font-weight:600; margin:8px 0 2px 0;">Active shift: {{ shift.name }}</p>
      <p class="small" style="color:var(--muted);">Effective: {{ shift.effective_date }} &middot; {{ shift.description }}</p>
      <div class="regime-grid">
        <div class="regime-card pre">
          <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
            <strong class="small" style="text-transform:uppercase; letter-spacing:0.5px;">Pre-Shift</strong>
            <span class="small" style="color:var(--muted);">Superseded policy</span>
          </div>
          <div style="font-size:20px; font-weight:700; margin-bottom:6px;">{{ ra.pre_shift_count }} <span class="small" style="font-weight:400;">cases</span></div>
          {% for disp, count in ra.pre_shift_distribution.items() %}
          {% set pct = (count / ra.pre_shift_count * 100) | round | int if ra.pre_shift_count else 0 %}
          <div style="display:flex; justify-content:space-between;" class="small"><span>{{ disp }}</span><span>{{ count }} ({{ pct }}%)</span></div>
          <div class="regime-bar"><span class="bar-{{ disp | lower }}" style="width:{{ [pct, 3] | max }}%;"></span></div>
          {% endfor %}
        </div>
        <div class="regime-card post">
          <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
            <strong class="small" style="text-transform:uppercase; letter-spacing:0.5px; color:#059669;">Post-Shift</strong>
            <span class="small" style="color:#059669;">Current policy &#10003;</span>
          </div>
          <div style="font-size:20px; font-weight:700; margin-bottom:6px;">{{ ra.post_shift_count }} <span class="small" style="font-weight:400;">cases</span></div>
          {% for disp, count in ra.post_shift_distribution.items() %}
          {% set pct = (count / ra.post_shift_count * 100) | round | int if ra.post_shift_count else 0 %}
          <div style="display:flex; justify-content:space-between;" class="small"><span>{{ disp }}</span><span>{{ count }} ({{ pct }}%)</span></div>
          <div class="regime-bar"><span class="bar-{{ disp | lower }}" style="width:{{ [pct, 3] | max }}%;"></span></div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
      <div style="margin-top:10px; padding-top:10px; border-top:1px solid #fcd34d;">
        <p class="small"><strong style="color:#d97706;">{{ ra.pct_regime_limited }}%</strong> of comparable pool decided under superseded policy. Post-shift pool: <strong>{{ ra.post_shift_count }}</strong> cases (effective pool for confidence).</p>
        {% if ra.guidance %}
        <p class="small" style="color:var(--muted); font-style:italic; margin-top:4px;">{{ ra.guidance }}</p>
        {% endif %}
      </div>
    </div>
    {% endif %}

    {# ‚îÄ‚îÄ Row 2: Policy Simulation Pointer (minimal C2.7) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    {% if enhanced_precedent and enhanced_precedent.regime_analysis and enhanced_precedent.regime_analysis.shifts_detected %}
    <div style="margin-top:8px; padding:10px 14px; border:1px dashed rgba(52,211,153,0.3); border-radius:8px; background:rgba(16,185,129,0.05);">
      <p class="small" style="margin:0; color:#34d399; font-weight:600;">&#9881; POLICY SIMULATION AVAILABLE</p>
      <p class="small" style="margin:4px 0 0; color:var(--muted);">3 draft policies can be simulated via the dashboard. Visit <strong>/sandbox</strong> to run simulations before enacting changes.</p>
    </div>
    {% endif %}

    {# ‚îÄ‚îÄ Row 3: Top 5 Comparable Cases ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    {% if enhanced_precedent and enhanced_precedent.case_thumbnails and enhanced_precedent.case_thumbnails|length > 0 %}
    <h3 style="margin-top:16px;">Top Comparable Cases</h3>
    {% for thumb in enhanced_precedent.case_thumbnails %}
    <details class="pi-case break{% if thumb.regime_limited is defined and thumb.regime_limited %} regime-limited{% endif %}" {% if loop.first %}open{% endif %}>
      <summary>
        <span class="mono" style="font-weight:600; min-width:80px;">{{ thumb.precedent_id }}</span>
        <span style="font-weight:700; font-size:16px; margin:0 4px;">{{ thumb.similarity_pct }}%</span>
        {% set is_aligned = thumb.classification == 'supporting' and thumb.disposition not in ['ALLOW', 'BLOCK'] %}
        <span class="pill {% if thumb.classification == 'supporting' and not is_aligned %}pass{% elif is_aligned %}req{% elif thumb.classification == 'contrary' %}trig{% else %}req{% endif %}" style="margin-left:auto;{% if is_aligned %} background:rgba(59,130,246,0.15); color:#60a5fa; border-color:rgba(59,130,246,0.3);{% endif %}">{{ 'ALIGNED' if is_aligned else thumb.outcome_label }}</span>
        {% if thumb.regime_limited is defined and thumb.regime_limited %}
        <span class="pi-chip pre-shift" style="margin-left:4px;">PRE-SHIFT</span>
        {% endif %}
      </summary>
      <div class="pi-case-body">
        {% if thumb.regime_limited is defined and thumb.regime_limited %}
        <div class="regime-warning">&#9888; Decided under superseded policy. Outcome may not reflect current institutional posture.</div>
        {% endif %}
        {% if thumb.two_axis is defined and thumb.two_axis %}
        {% set ta = thumb.two_axis %}
        <div style="margin:0 0 8px 0; padding:6px 10px; background:rgba(30,64,175,0.06); border-radius:4px; font-size:12px; line-height:1.7;">
          <div style="display:flex; gap:16px;">
            <span>Operational: <strong style="color:{% if ta.op_alignment == 'ALIGNED' %}var(--ok){% elif ta.op_alignment == 'CONTRARY' %}var(--bad){% else %}var(--warn){% endif %};">{{ ta.op_alignment }}</strong></span>
            {% if ta.suspicion_alignment == 'UNDETERMINED' %}
            <span>Regulatory: <strong style="color:var(--muted);">PENDING</strong> <span style="color:var(--muted);">(reporting not yet determined)</span></span>
            {% else %}
            <span>Regulatory: <strong style="color:{% if ta.suspicion_alignment == 'ALIGNED' %}var(--ok){% elif ta.suspicion_alignment == 'CONTRARY' %}var(--bad){% else %}var(--muted){% endif %};">{{ ta.suspicion_alignment }}</strong></span>
            {% endif %}
          </div>
          {% if thumb.composite_description %}<div style="margin-top:2px; color:#475569;">&#9656; {{ thumb.composite_description }}</div>{% endif %}
        </div>
        {% endif %}
        <p style="margin:0 0 6px 0;">{{ thumb.description }}</p>
        {% if thumb.key_matches %}
        <div style="margin-bottom:4px;"><span class="small" style="color:var(--ok); font-weight:600;">Matching:</span> <span class="small" style="color:var(--ok);">{{ thumb.key_matches | join(', ') }}</span></div>
        {% endif %}
        {% if thumb.key_differences %}
        <div style="margin-bottom:4px;"><span class="small" style="color:var(--bad); font-weight:600;">Differs:</span> <span class="small" style="color:var(--bad);">{{ thumb.key_differences | join(', ') }}</span></div>
        {% endif %}
        {% if thumb.matched_drivers is defined and thumb.matched_drivers %}
        <div style="margin-top:4px;">{% for d in thumb.matched_drivers %}<span class="pi-chip driver">{{ d }}</span>{% endfor %}</div>
        {% endif %}
        {% if thumb.mismatched_drivers is defined and thumb.mismatched_drivers %}
        <div style="margin-top:2px;">{% for d in thumb.mismatched_drivers %}<span class="pi-chip divergent">{{ d }}</span>{% endfor %}</div>
        {% endif %}
        {% if thumb.reporting_rationale %}
        <div style="margin-top:6px; padding:6px 10px; background:rgba(30,64,175,0.04); border-left:2px solid #93c5fd; border-radius:2px; font-size:12px; color:#334155; line-height:1.5;">
          <span style="font-weight:600;">Reporting rationale:</span> {{ thumb.reporting_rationale }}
        </div>
        {% endif %}
      </div>
    </details>
    {% endfor %}
    {% if enhanced_precedent.pool_composite_finding is defined and enhanced_precedent.pool_composite_finding %}
    <div class="statement break" style="margin-top:8px; padding:8px 12px; background:rgba(30,64,175,0.05); border-left:3px solid #3b82f6; border-radius:4px;">
      <p class="small" style="margin:0; font-style:italic; color:#1e40af;">{{ enhanced_precedent.pool_composite_finding }}</p>
    </div>
    {% endif %}
    {% endif %}

    {# ‚îÄ‚îÄ Row 4: Divergence Justification + Sign-Off ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    {% if enhanced_precedent and enhanced_precedent.divergence_justification %}
    {% set dj = enhanced_precedent.divergence_justification %}
    <div class="card break" style="border-left:4px solid var(--warn); margin-top:16px; padding:12px 16px;">
      <h3 style="margin:0 0 8px 0; font-size:15px;">Divergence Justification</h3>
      {% if dj.statement %}
      <p style="font-weight:600; margin:0 0 10px 0;">{{ dj.statement }}</p>
      {% endif %}
      {% if dj.contrary_details and dj.contrary_details|length > 0 %}
      <table style="width:100%; font-size:13px; border-collapse:collapse;">
        <thead>
          <tr style="background:var(--bg); text-align:left;">
            <th style="padding:4px 8px;">Contrary Precedent</th>
            <th style="padding:4px 8px;">Outcome</th>
            <th style="padding:4px 8px;">Similarity</th>
            <th style="padding:4px 8px;">Distinguishing Factors</th>
          </tr>
        </thead>
        <tbody>
          {% for cd in dj.contrary_details %}
          <tr style="border-bottom:1px solid #e5e7eb;">
            <td style="padding:4px 8px;" class="mono">{{ cd.precedent_id }}</td>
            <td style="padding:4px 8px;">{{ cd.outcome }}</td>
            <td style="padding:4px 8px;">{{ cd.similarity_pct }}%</td>
            <td style="padding:4px 8px; font-size:12px;">{{ cd.distinguishing_factors | join('; ') }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
      {% if enhanced_precedent.override_statement %}
      <blockquote style="border-left:3px solid var(--bad); padding:8px 12px; margin:12px 0; font-style:italic; background:#fef2f2;">
        {{ enhanced_precedent.override_statement }}
      </blockquote>
      {% endif %}
      <div style="margin-top:12px; padding:12px; background:#f9fafb; border:1px solid var(--border); border-radius:6px;">
        <strong style="font-size:13px;">Compliance Officer Sign-Off</strong>
        <div style="display:grid; grid-template-columns:100px 1fr; gap:6px 12px; font-size:13px; margin-top:8px;">
          <div style="font-weight:600;">Reviewer</div>
          <div style="border-bottom:1px solid #999; min-width:200px;">&nbsp;</div>
          <div style="font-weight:600;">Date</div>
          <div style="border-bottom:1px solid #999; min-width:200px;">&nbsp;</div>
          <div style="font-weight:600;">Rationale</div>
          <div style="border-bottom:1px solid #999; min-width:200px;">&nbsp;</div>
        </div>
      </div>
    </div>
    {% endif %}

    {# ‚îÄ‚îÄ Decision Driver Analysis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    {% if enhanced_precedent.driver_causality is defined and enhanced_precedent.driver_causality %}
    {% set dc = enhanced_precedent.driver_causality %}
    {% if dc.shared_drivers or dc.divergent_drivers %}
    <div style="margin-top:16px; padding:12px; background:#f0f4f8; border-radius:6px; border:1px solid #c8d6e5;">
      <div style="font-weight:600; margin-bottom:8px;">Decision Driver Analysis</div>
      {% if dc.shared_drivers %}
      <div style="margin-bottom:8px;">
        <span class="small" style="color:#2d6a4f; font-weight:600;">Shared Drivers:</span>
        <div style="margin-top:4px;">{% for d in dc.shared_drivers %}<span class="pi-chip driver">{{ d | replace('_', ' ') | replace('.', ' ‚Ä∫ ') }}</span>{% endfor %}</div>
      </div>
      {% endif %}
      {% if dc.divergent_drivers %}
      <div>
        <span class="small" style="color:#9b2226; font-weight:600;">Divergent Drivers:</span>
        <div style="margin-top:4px;">{% for d in dc.divergent_drivers %}<span class="pi-chip divergent">{{ d | replace('_', ' ') | replace('.', ' ‚Ä∫ ') }}</span>{% endfor %}</div>
      </div>
      {% endif %}
    </div>
    {% endif %}
    {% endif %}

    {# ‚îÄ‚îÄ Non-Transferable Precedents ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    {% if enhanced_precedent.non_transferable_explanations is defined and enhanced_precedent.non_transferable_explanations | length > 0 %}
    <div class="status warn" style="margin-top:12px; padding:12px;">
      <strong>Non-Transferable Precedents ({{ enhanced_precedent.non_transferable_explanations | length }})</strong>
      <ul class="small" style="margin-top:6px;">
        {% for nt in enhanced_precedent.non_transferable_explanations[:3] %}
        <li>{{ nt.precedent_id }}: {{ nt.reasons | join('; ') }}</li>
        {% endfor %}
      </ul>
      <span class="small">These precedents were scored but cannot be classified as "supporting" due to driver mismatches.</span>
    </div>
    {% endif %}

    {# ‚îÄ‚îÄ Temporal Context ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    {% if enhanced_precedent and enhanced_precedent.temporal_context and enhanced_precedent.temporal_context|length > 0 %}
    {% set contrary_ts = [] %}
    {% for t in enhanced_precedent.temporal_context if t.classification == 'contrary' and t.timestamp %}
      {% if contrary_ts.append(t) %}{% endif %}
    {% endfor %}
    {% if contrary_ts|length > 0 %}
    <div style="margin-top:12px;">
      <h4 style="margin-bottom:4px; font-size:14px;">Temporal Context</h4>
      <p class="small" style="margin-bottom:6px;"><em>Contrary precedent dates ‚Äî older cases may reflect superseded guidance.</em></p>
      <ul style="font-size:13px; margin:0; padding-left:20px;">
        {% for t in contrary_ts[:5] %}
        <li><span class="mono">{{ t.precedent_id }}</span>: {{ t.timestamp }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    {% endif %}

    {# ‚îÄ‚îÄ FIX-030: Precedent Divergence Narrative ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    {% if precedent_divergence %}
    <div class="status {% if precedent_divergence.severity == 'high' %}bad{% else %}warn{% endif %}" style="margin-top:12px; padding:12px;">
      <strong>Precedent Divergence Analysis</strong>
      <p class="small" style="margin:8px 0 4px;">{{ precedent_divergence.narrative }}</p>
      {% if precedent_divergence.pool_distribution %}
      <div style="margin-top:8px; font-size:13px;">
        <span style="font-weight:600;">Pool Distribution:</span>
        {% for outcome, count in precedent_divergence.pool_distribution.items() %}
        <span class="pi-chip {% if outcome == governed_disposition %}driver{% else %}divergent{% endif %}">{{ outcome | replace('_', ' ') }}: {{ count }}</span>
        {% endfor %}
      </div>
      {% endif %}
      {% if precedent_divergence.divergence_reasons %}
      <ul class="small" style="margin-top:6px;">
        {% for reason in precedent_divergence.divergence_reasons %}
        <li>{{ reason }}</li>
        {% endfor %}
      </ul>
      {% endif %}
    </div>
    {% endif %}

    {# ‚îÄ‚îÄ FIX-032: Policy Regime Exception ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    {% if policy_regime_exception %}
    <div class="status warn" style="margin-top:12px; padding:12px;">
      <strong>Policy Regime Exception</strong>
      <p class="small" style="margin:8px 0 4px;">{{ policy_regime_exception.narrative }}</p>
      {% if policy_regime_exception.pre_shift_pattern %}
      <div style="font-size:13px; margin-top:6px;">
        <span style="font-weight:600;">Pre-Shift Pattern:</span> {{ policy_regime_exception.pre_shift_pattern }}
      </div>
      {% endif %}
      {% if policy_regime_exception.post_shift_pattern %}
      <div style="font-size:13px;">
        <span style="font-weight:600;">Post-Shift Pattern:</span> {{ policy_regime_exception.post_shift_pattern }}
      </div>
      {% endif %}
      {% if policy_regime_exception.exception_basis %}
      <div style="font-size:13px; margin-top:4px;">
        <span style="font-weight:600;">Exception Basis:</span> {{ policy_regime_exception.exception_basis }}
      </div>
      {% endif %}
    </div>
    {% endif %}

    {% elif precedent_analysis %}
    <h2>Precedent Intelligence</h2>
    <div class="status warn" style="margin-top:12px; padding:12px;">
      <strong>Precedent Analysis Unavailable</strong><br>
      <span class="small">{{ precedent_analysis.message or precedent_analysis.error or 'Precedent analysis unavailable.' }}</span>
    </div>
    {% endif %}

    <h2>Gate Evaluation</h2>
    <h3>Gate 1: Zero-False-Escalation Check</h3>
    <div class="gate-block break">
      <h4>
        {% if gate1_passed %}
          <span class="pill pass">REVIEW PERMITTED</span>
        {% else %}
          <span class="pill trig">REVIEW BLOCKED</span>
        {% endif %}
      </h4>
      <p class="small" style="margin-bottom:12px;">
        {% if gate1_passed %}
          Sufficient regulatory basis exists to permit enhanced review if warranted by suspicion indicators.
        {% elif governed_disposition in ['EDD_REQUIRED', 'ESCALATE'] %}
          Insufficient basis for automatic escalation. Enhanced review required ‚Äî case remains open.
        {% else %}
          Insufficient lawful basis to escalate. No regulatory reporting required at this time.
        {% endif %}
      </p>
      {% if gate1_sections and gate1_sections|length > 0 %}
        {% for section in gate1_sections %}
        <div class="gate-section">
          {% if section.passed %}
            <span class="pill pass">PASS</span>
          {% else %}
            <span class="pill trig">FAIL</span>
          {% endif %}
          <div>
            <div class="section-name">{{ section.name }}</div>
            <div class="section-reason">{{ section.reason }}</div>
            {% if not section.passed and gate1_passed %}
            <div class="small" style="color:var(--muted); margin-top:2px; font-style:italic;">
              Sub-check failed but overall gate PERMITTED ‚Äî hard stop or classifier sovereignty overrides this check.
            </div>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p class="small">No sections evaluated</p>
      {% endif %}
    </div>

    <h3>Gate 2: STR Threshold</h3>
    {% if is_mandatory_hard_stop %}
    <div class="gate-block break">
      <h4><span class="pill na">NOT APPLICABLE</span></h4>
      <p class="small" style="margin-bottom:12px;">
        Sanctions hard stop supersedes suspicion threshold assessment. STR is mandatory under regulatory obligation, not suspicion-based.
      </p>
    </div>
    {% else %}
    <div class="gate-block break">
      <h4>
        STR Required:
        {% if str_required %}
          <span class="pill trig">YES ‚Äî FILE STR</span>
        {% else %}
          <span class="pill pass">NO</span>
        {% endif %}
      </h4>
      {% if not gate1_passed %}
        <p class="small" style="margin-bottom:12px; font-style:italic;">
          Gate 2 evaluation skipped ‚Äî escalation not permitted by Gate 1.
        </p>
      {% endif %}
      {% if gate2_sections and gate2_sections|length > 0 %}
        {% for section in gate2_sections %}
        <div class="gate-section" {% if not gate1_passed %}style="opacity:0.8;"{% endif %}>
          {% if not gate1_passed %}
            <span class="pill na">SKIPPED</span>
          {% elif section.passed %}
            <span class="pill pass">PASS</span>
          {% else %}
            <span class="pill req">REVIEW</span>
          {% endif %}
          <div>
            <div class="section-name">{{ section.name }}</div>
            <div class="section-reason">
              {% if not gate1_passed %}
                Skipped ‚Äî escalation not permitted
              {% else %}
                {{ section.reason }}
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p class="small">No sections evaluated</p>
      {% endif %}
    </div>
    {% endif %}

    {# ‚îÄ‚îÄ FIX-028: Gate Override Analysis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    {% if gate_override_explanations %}
    <h3>Gate Override Analysis</h3>
    {% set has_gate_conflict = gate_override_explanations | selectattr('conflict') | list | length > 0 %}
    {% if has_gate_conflict %}
    {% for g in gate_override_explanations if g.conflict %}
    <div class="status {% if 'correction' in (g.override_mechanism|default('')|lower) %}warn{% else %}bad{% endif %} break">
      <h3 style="margin-bottom:8px;">{{ g.gate }}</h3>
      <div class="kv" style="font-size:13px;">
        <div class="label">Gate Result</div>
        <div class="value mono">{{ g.gate_result }}</div>
        <div class="label">Final Disposition</div>
        <div class="value" style="font-weight:700;">{{ g.final_disposition | replace('_', ' ') }}</div>
        <div class="label">Override Mechanism</div>
        <div class="value">{{ g.override_mechanism }}</div>
        <div class="label">Authority</div>
        <div class="value small">{{ g.authority }}</div>
      </div>
      {% if g.override_basis %}
      <p class="small" style="font-weight:600; margin:8px 0 4px 0;">Override Basis:</p>
      <ul style="margin:0; padding-left:20px; font-size:13px;">
        {% for basis in g.override_basis %}
        <li>{{ basis }}</li>
        {% endfor %}
      </ul>
      {% endif %}
    </div>
    {% endfor %}
    {% else %}
    {% set has_upheld = gate_override_explanations | selectattr('upheld') | list | length > 0 %}
    {% if has_upheld %}
    {% for g in gate_override_explanations if g.upheld %}
    <div class="status ok break">
      <h3 style="margin-bottom:8px;">{{ g.gate }} ‚Äî UPHELD</h3>
      <p class="small">{{ g.upheld_detail }}</p>
      {% if g.upheld_basis %}
      <p class="small" style="font-weight:600; margin:8px 0 4px;">Gate Basis:</p>
      <ul style="margin:0; padding-left:20px; font-size:13px;">
        {% for basis in g.upheld_basis %}
        <li>{{ basis }}</li>
        {% endfor %}
      </ul>
      {% endif %}
    </div>
    {% endfor %}
    {% else %}
    <div class="status ok break">
      <p>All gates consistent with final disposition.</p>
    </div>
    {% endif %}
    {% endif %}
    {% endif %}

    <h2>Rules Evaluated</h2>
    {% set rule_evidence_map = {
      'AML_ESC_HR_COUNTRY': ['txn.destination_country', 'txn.cross_border'],
      'AML_ESC_PEP_SCREEN': ['flag.pep', 'customer.pep_flag'],
      'AML_ESC_PEP': ['flag.pep', 'customer.pep_flag'],
      'AML_ESC_STRUCT': ['flag.structuring_suspected', 'txn.amount_band'],
      'AML_BLOCK_SANCTIONS': ['flag.sanctions_proximity'],
      'AML_INV_STRUCT': ['flag.structuring_suspected', 'txn.amount_band'],
      'AML_STR_LAYER': ['flag.rapid_movement', 'txn.method'],
      'AML_ESC_ADVERSE_MEDIA': ['flag.adverse_media']
    } %}
    {% set ev_lookup = {} %}
    {% for ev in evidence_used %}
      {% if ev.field %}{% set _ = ev_lookup.update({ev.field: ev.value}) %}{% endif %}
    {% endfor %}
    <table class="break">
      <thead>
        <tr>
          <th style="width:140px;">Rule Code</th>
          <th style="width:120px;">Result</th>
          <th>Reason</th>
        </tr>
      </thead>
      <tbody>
        {% for rule in rules_fired %}
        <tr>
          <td class="mono">{{ rule.code }}</td>
          <td>
            {% if rule.result in ['CLEAR', 'NOT_APPLICABLE', 'APPLIED'] %}
              <span class="pill pass">{{ rule.result }}</span>
            {% elif rule.result == 'TRIGGERED' or rule.result == 'ACTIVATED' %}
              <span class="pill trig">{{ rule.result }}</span>
            {% else %}
              <span class="pill na">{{ rule.result }}</span>
            {% endif %}
          </td>
          <td class="small">
            {{ rule.reason }}
            {% if rule.result in ['TRIGGERED', 'ACTIVATED', 'WARN', 'FAIL', 'FAILED'] %}
              {% set mapped = rule_evidence_map.get(rule.code | upper, []) %}
              {% set ns = namespace(active=[]) %}
              {% for f in mapped %}
                {% if f in ev_lookup %}
                  {% set ns.active = ns.active + [f ~ ' = ' ~ ev_lookup[f]] %}
                {% endif %}
              {% endfor %}
              {% if ns.active %}
                <br><span style="color:#374151; font-size:12px;">Triggered by: {{ ns.active[:3] | join(', ') }}</span>
              {% endif %}
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% if not rules_fired %}
        <tr>
          <td colspan="3" class="small">No rules evaluated</td>
        </tr>
        {% endif %}
      </tbody>
    </table>

    {# ‚îÄ‚îÄ Precedent Technical Detail (collapsible) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    {% if precedent_analysis and precedent_analysis.available %}
    <details style="margin-top:16px;">
      <summary style="cursor:pointer; font-size:14px; font-weight:600; padding:8px 0;">Precedent Technical Detail</summary>
      <div style="padding-top:8px;">

      <h3>Precedent Classification</h3>
      <div class="card break">
        <div class="kv">
          <div class="label">Supporting Precedents</div>
          <div class="value" style="color: var(--ok);">{{ precedent_analysis.supporting_precedents }} <span class="small">(same outcome)</span></div>
          <div class="label">Contrary Precedents</div>
          <div class="value" style="color: var(--bad);">{{ precedent_analysis.contrary_precedents }} <span class="small">(different outcome)</span></div>
          <div class="label">Neutral / Procedural</div>
          <div class="value" style="color: var(--muted);">{{ precedent_analysis.neutral_precedents | default(0) }} <span class="small">(enhanced review)</span></div>
          <div class="label">Comparable Matches</div>
          <div class="value">{{ precedent_analysis.match_count }}</div>
          <div class="label">Raw Overlaps</div>
          <div class="value">{{ precedent_analysis.raw_overlap_count | default(0) }}</div>
          <div class="label">Exact Matches</div>
          <div class="value">{{ precedent_analysis.exact_match_count | default(0) }}</div>
        </div>
        {% if precedent_analysis.neutral_precedents | default(0) > 0 and precedent_analysis.supporting_precedents + precedent_analysis.contrary_precedents == 0 %}
        {% set cls_gov_align = enhanced_precedent.governed_alignment_count | default(0) %}
        {% set cls_gov_total = enhanced_precedent.governed_alignment_total | default(0) %}
        <p class="small" style="margin-top:8px; border-left:3px solid var(--ok); padding-left:8px;">
          <strong>Note:</strong> All {{ precedent_analysis.neutral_precedents }} precedents are non-terminal (EDD/review).
          {% if cls_gov_align > 0 %}
          However, {{ cls_gov_align }} of {{ cls_gov_total }} match the governed disposition.
          {% endif %}
        </p>
        {% endif %}
      </div>

      <h3>Scored Match Outcome Distribution</h3>
      {% set scored_distribution = precedent_analysis.match_outcome_distribution or precedent_analysis.outcome_distribution %}
      {% set outcome_total = scored_distribution.values()|sum %}
      <table class="break">
        <thead><tr><th>Outcome</th><th>Count</th><th style="width:220px;">Distribution</th></tr></thead>
        <tbody>
          {% for outcome, count in scored_distribution.items() %}
          {% set pct = (count / outcome_total * 100) if outcome_total else 0 %}
          <tr>
            <td>{{ outcome|upper }}</td>
            <td class="mono">{{ count }}</td>
            <td><div class="bar"><span style="width: {{ "%.0f"|format(pct) }}%;"></span></div></td>
          </tr>
          {% endfor %}
          {% if not scored_distribution %}<tr><td colspan="3" class="small">No data</td></tr>{% endif %}
        </tbody>
      </table>

      <h3>Raw Overlap Outcome Distribution</h3>
      {% set overlap_distribution = precedent_analysis.raw_outcome_distribution or precedent_analysis.overlap_outcome_distribution | default({}) %}
      {% set overlap_total = overlap_distribution.values()|sum %}
      <table class="break">
        <thead><tr><th>Outcome</th><th>Count</th><th style="width:220px;">Distribution</th></tr></thead>
        <tbody>
          {% for outcome, count in overlap_distribution.items() %}
          {% set pct = (count / overlap_total * 100) if overlap_total else 0 %}
          <tr>
            <td>{{ outcome|upper }}</td>
            <td class="mono">{{ count }}</td>
            <td><div class="bar"><span style="width: {{ "%.0f"|format(pct) }}%;"></span></div></td>
          </tr>
          {% endfor %}
          {% if not overlap_distribution %}<tr><td colspan="3" class="small">No data</td></tr>{% endif %}
        </tbody>
      </table>

      <h3>Precedent Evidence (Top Matches)</h3>
      {% set threshold_pct = ((precedent_analysis.threshold_used|default(0.5)) * 100)|int %}
      <p class="small" style="margin-bottom:8px;"><em>Similarity threshold: ‚â•{{ threshold_pct }}%.</em></p>
      <div class="match-grid">
        {% for match in precedent_analysis.sample_cases %}
        {% set sc = match.similarity_components %}
        {% set below_threshold = match.similarity_pct < threshold_pct %}
        <div class="match-card break{% if below_threshold %} below-threshold{% endif %}">
          <div class="match-card-header">
            <span class="match-id">{{ match.precedent_id }}</span>
            <span class="match-sim">{{ match.similarity_pct }}%
              {% if match.exact_match %}<span class="badge">EXACT</span>{% endif %}
              {% if below_threshold %}<span class="badge" style="background:#4b5563; color:#fff;">BELOW THRESHOLD</span>{% endif %}
            </span>
          </div>
          <div class="match-meta">
            <span class="meta-chip {{ match.classification | default('neutral') }}">{{ match.outcome_label }}</span>
            <span class="meta-chip">{{ match.decision_level | default('N/A') }}</span>
            {% if match.appealed %}<span class="meta-chip contrary">Appealed{% if match.appeal_outcome %} ¬∑ {{ match.appeal_outcome }}{% endif %}</span>{% endif %}
          </div>
          {% if match.two_axis is defined and match.two_axis %}
          {% set mta = match.two_axis %}
          <div style="margin:0 0 8px 0; padding:4px 10px; background:rgba(30,64,175,0.06); border-radius:4px; font-size:11px; line-height:1.6;">
            <span>Operational: <strong style="color:{% if mta.op_alignment == 'ALIGNED' %}var(--ok){% elif mta.op_alignment == 'CONTRARY' %}var(--bad){% else %}var(--warn){% endif %};">{{ mta.op_alignment }}</strong></span>
            &nbsp;
            {% if mta.suspicion_alignment == 'UNDETERMINED' %}
            <span>Regulatory: <strong style="color:var(--muted);">PENDING</strong> <span style="color:var(--muted);">(reporting not yet determined)</span></span>
            {% else %}
            <span>Regulatory: <strong style="color:{% if mta.suspicion_alignment == 'ALIGNED' %}var(--ok){% elif mta.suspicion_alignment == 'CONTRARY' %}var(--bad){% else %}var(--muted){% endif %};">{{ mta.suspicion_alignment }}</strong></span>
            {% endif %}
          </div>
          {% endif %}
          <div class="sim-bars">
            {% set drivers = [
              ("Rules", sc.rules_overlap|default(0), 30),
              ("Gates", sc.gate_match|default(0), 25),
              ("Typology", sc.typology_overlap|default(0), 15),
              ("Amount", sc.amount_bucket|default(0), 10),
              ("Corridor", sc.corridor_match|default(0), 8),
              ("Channel", sc.channel_method|default(0), 7),
              ("PEP", sc.pep_match|default(0), 5),
              ("Customer", sc.customer_profile|default(0), 5),
              ("Geo Risk", sc.geo_risk|default(0), 5)
            ] %}
            {% for label, pct, weight in drivers %}
            <span class="sim-label">{{ label }}</span>
            <span class="sim-track"><span class="sim-fill {% if pct >= 80 %}high{% elif pct >= 40 %}med{% else %}low{% endif %}" style="width:{{ pct }}%"></span></span>
            <span class="sim-pct {% if pct == 0 %}zero{% endif %}">{% if pct > 0 %}{{ pct }}%{% else %}‚Äî{% endif %}</span>
            {% endfor %}
          </div>
          <div class="match-codes">{{ match.reason_codes | join(' ¬∑ ') }}</div>
          {% if match.reporting_rationale %}
          <div style="margin-top:6px; padding:6px 10px; background:rgba(30,64,175,0.04); border-left:2px solid #93c5fd; border-radius:2px; font-size:11px; color:#334155; line-height:1.5;">
            <span style="font-weight:600;">Reporting rationale:</span> {{ match.reporting_rationale }}
          </div>
          {% endif %}
        </div>
        {% endfor %}
        {% if not precedent_analysis.sample_cases %}
        <div class="card small">No precedent matches available</div>
        {% endif %}
      </div>

      <h3>Appeal Statistics</h3>
      <div class="card break">
        <div class="kv">
          <div class="label">Total Appealed</div>
          <div class="value">{{ precedent_analysis.appeal_statistics.total_appealed }}</div>
          <div class="label">Upheld</div>
          <div class="value">{{ precedent_analysis.appeal_statistics.upheld }}</div>
          <div class="label">Overturned</div>
          <div class="value">{{ precedent_analysis.appeal_statistics.overturned }}</div>
          <div class="label">Upheld Rate</div>
          <div class="value">{% if precedent_analysis.appeal_statistics.total_appealed > 0 %}{{ "%.0f"|format(precedent_analysis.appeal_statistics.upheld_rate * 100) }}%{% else %}N/A{% endif %}</div>
        </div>
      </div>

      {% if precedent_analysis.caution_precedents and precedent_analysis.caution_precedents|length > 0 %}
      <h3>Caution Precedents (Overturned Cases)</h3>
      <div class="status warn break">
        <p><strong>{{ precedent_analysis.caution_precedents|length }}</strong> similar cases were later overturned on appeal.</p>
        <ul>
          {% for prec in precedent_analysis.caution_precedents[:5] %}
          <li><strong>{{ prec.case_ref }}</strong> ‚Äî {{ prec.outcome|upper }}{% if prec.appeal_result %} <span class="small">({{ prec.appeal_result }})</span>{% endif %}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      {% set threshold_used = precedent_analysis.threshold_used if precedent_analysis.threshold_used is defined else (precedent_analysis.min_similarity_pct | default(50)) / 100 %}
      {% set avg_similarity = precedent_analysis.avg_top_k_similarity | default(0) %}
      {% set show_why = (precedent_analysis.match_count == 0) or (precedent_analysis.precedent_confidence < 0.4) or (avg_similarity < threshold_used) %}
      {% if show_why and precedent_analysis.why_low_match and precedent_analysis.why_low_match|length > 0 %}
      <div class="status warn" style="margin-top:12px; padding:12px;">
        <strong>Why precedent confidence is limited</strong>
        <ul class="small">
          {% set ns = namespace(missing=[], gate=[], rule=[], typo=[]) %}
          {% for item in precedent_analysis.why_low_match %}
            {% if item.missing_features is defined %}{% set ns.missing = item.missing_features %}{% endif %}
            {% if item.gate_mismatch is defined %}{% set ns.gate = item.gate_mismatch %}{% endif %}
            {% if item.rule_mismatch is defined %}{% set ns.rule = item.rule_mismatch %}{% endif %}
            {% if item.typology_mismatch is defined %}{% set ns.typo = item.typology_mismatch %}{% endif %}
          {% endfor %}
          {% if ns.missing|length > 0 %}<li>Missing features: {{ ns.missing | join(', ') | replace('_', ' ') }}</li>{% endif %}
          {% if ns.gate|length > 0 %}<li>Gate mismatch: {{ ns.gate | join(', ') }}</li>{% endif %}
          {% if ns.rule|length > 0 %}<li>Rule mismatch: {{ ns.rule | join(', ') | replace('_', ' ') }}</li>{% endif %}
          {% if ns.typo|length > 0 %}<li>Typology mismatch: {{ ns.typo | join(', ') | replace('_', ' ') }}</li>{% endif %}
        </ul>
      </div>
      {% endif %}

      </div>
    </details>
    {% endif %}

    {% if defensibility_check %}
    <h2>Defensibility Check</h2>
    <div class="card break">
      <div class="kv">
        <div class="label">Status</div>
        <div class="value" style="font-weight:700; {% if defensibility_check.status == 'PASS' %}color:#059669;{% elif defensibility_check.status == 'DEFERRED' %}color:#d97706;{% else %}color:#dc2626;{% endif %}">
          {% if defensibility_check.status == 'PASS' %}‚úÖ{% elif defensibility_check.status == 'DEFERRED' %}‚è≥{% else %}üö®{% endif %}
          {{ defensibility_check.status | default('UNKNOWN') }} ‚Äî {{ defensibility_check.message | default('') }}
        </div>
        {% if defensibility_check.action %}
        <div class="label">Action</div>
        <div class="value">{{ defensibility_check.action }}</div>
        {% endif %}
        {% if defensibility_check.note %}
        <div class="label">Note</div>
        <div class="value small">{{ defensibility_check.note }}</div>
        {% endif %}
        {% if defensibility_check.requires_documented_rationale %}
        <div class="label" style="color:#dc2626; font-weight:600;">INV-009</div>
        <div class="value small" style="color:#dc2626;">{{ defensibility_check.inv_009_note }}</div>
        <div class="label">Rationale Status</div>
        <div class="value" style="font-weight:600; color:#d97706;">{{ defensibility_check.rationale_status | default('PENDING') }}</div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    {# ‚îÄ‚îÄ FIX-031: Unmapped Indicator Independence Check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    {% if unmapped_indicator_checks %}
    <div class="status {% if unmapped_indicator_checks | selectattr('independent') | list | length == unmapped_indicator_checks | length %}ok{% else %}warn{% endif %}" style="margin-top:12px; padding:12px;">
      <strong>Unmapped Indicator Independence Check</strong>
      <p class="small" style="margin:8px 0 6px;">Verifies that mapped Tier 1 indicators independently support the outcome without relying on unmapped signals.</p>
      <table style="width:100%; font-size:13px; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:4px 8px; border-bottom:1px solid var(--border);">Indicator</th>
            <th style="text-align:left; padding:4px 8px; border-bottom:1px solid var(--border);">Source</th>
            <th style="text-align:center; padding:4px 8px; border-bottom:1px solid var(--border);">Independent?</th>
          </tr>
        </thead>
        <tbody>
          {% for check in unmapped_indicator_checks %}
          <tr>
            <td class="mono" style="padding:4px 8px;">{{ check.indicator_code }}</td>
            <td class="small" style="padding:4px 8px;">{{ check.indicator_source | default('‚Äî') }}</td>
            <td style="text-align:center; padding:4px 8px;">
              {% if check.independent %}
                <span style="color:#059669; font-weight:700;">Yes</span> ‚Äî {{ check.basis | default('') }}
              {% else %}
                <span style="color:#dc2626; font-weight:700;">No</span> ‚Äî {{ check.basis | default('') }}
              {% endif %}
              {% if check.gate_narrative %}
              <br><span class="small" style="color:var(--muted);">{{ check.gate_narrative }}</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

    <h2>Risk Factors</h2>
    <table class="break">
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        {% for ev in risk_factors %}
        <tr>
          <td class="mono">{{ ev.field }}</td>
          <td>
            {% if ev.value is sameas true %}
              Yes
            {% elif ev.value is sameas false %}
              No
            {% else %}
              {{ ev.value }}
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% if not risk_factors %}
        <tr>
          <td colspan="2" class="small">No risk factors recorded</td>
        </tr>
        {% endif %}
      </tbody>
    </table>

    {# ‚îÄ‚îÄ FIX-033: Risk Heatmap Context ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    {% if risk_heatmap_context %}
    <div class="status {% if risk_heatmap_context.severity_mismatch %}warn{% else %}ok{% endif %}" style="margin-top:12px; padding:12px;">
      <strong>Risk Severity Context</strong>
      <div style="font-size:13px; margin-top:6px;">
        <span style="font-weight:600;">Expected Severity:</span>
        <span class="pill {% if risk_heatmap_context.expected_severity == 'HIGH' %}trig{% elif risk_heatmap_context.expected_severity == 'MEDIUM' %}req{% else %}pass{% endif %}">
          {{ risk_heatmap_context.expected_severity }}
        </span>
      </div>
      {% if risk_heatmap_context.severity_mismatch %}
      <p class="small" style="margin-top:6px;">{{ risk_heatmap_context.mismatch_narrative }}</p>
      {% endif %}
      {% if risk_heatmap_context.elevated_factors %}
      <div style="margin-top:6px; font-size:13px;">
        <span style="font-weight:600;">Elevated Factors:</span>
        {% for f in risk_heatmap_context.elevated_factors %}<span class="pi-chip divergent">{{ f | replace('_', ' ') }}</span>{% endfor %}
      </div>
      {% endif %}
      {% if risk_heatmap_context.mitigating_factors %}
      <div style="margin-top:4px; font-size:13px;">
        <span style="font-weight:600;">Mitigating Factors:</span>
        {% for f in risk_heatmap_context.mitigating_factors %}<span class="pi-chip driver">{{ f | replace('_', ' ') }}</span>{% endfor %}
      </div>
      {% endif %}
    </div>
    {% endif %}

    <h2>Evidence Considered</h2>
    <p class="small" style="margin-bottom:8px;">Evidence fields reflect the normalized investigation record used for rule evaluation (booleans and buckets). Raw customer identifiers are not included in this report.</p>
    {% set scope_labels = {
      'risk.high_risk_jurisdiction': 'Customer domicile jurisdiction risk',
      'txn.destination_country': 'Transaction destination jurisdiction',
      'txn.cross_border': 'Transaction cross-border indicator',
      'flag.cross_border': 'Cross-border flag (transaction-level)',
      'customer.type': 'Customer entity type',
      'customer.pep_flag': 'Customer PEP status',
      'flag.pep': 'PEP flag (customer-level)',
      'txn.amount_band': 'Transaction amount band',
      'txn.method': 'Payment method',
      'flag.structuring_suspected': 'Structuring indicator (transaction pattern)',
      'flag.sanctions_proximity': 'Sanctions screening proximity',
      'flag.adverse_media': 'Adverse media indicator',
      'flag.rapid_movement': 'Rapid fund movement indicator',
      'flag.shell_entity': 'Shell entity indicator',
      'risk.risk_score': 'Overall risk score'
    } %}
    <table class="break">
      <thead>
        <tr>
          <th>Field</th>
          <th>Scope</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        {% for ev in evidence_used %}
        <tr>
          <td class="mono">{{ ev.field }}</td>
          <td class="small">{{ scope_labels.get(ev.field, ev.field) }}</td>
          <td>{% if ev.value is sameas true %}Yes{% elif ev.value is sameas false %}No{% else %}{{ ev.value }}{% endif %}</td>
        </tr>
        {% endfor %}
        {% if not evidence_used %}
        <tr>
          <td colspan="3" class="small">No evidence recorded</td>
        </tr>
        {% endif %}
      </tbody>
    </table>

    {% if sla_timeline %}
    <h2>Timeline</h2>
    <div class="card break">
      <div class="kv">
        <div class="label">Case Created</div>
        <div class="value mono">{{ sla_timeline.case_created | default('N/A') }}</div>
        <div class="label">EDD Deadline</div>
        <div class="value mono">{{ sla_timeline.edd_deadline | default('N/A') }}</div>
        <div class="label">Final Disposition Due</div>
        <div class="value">{{ sla_timeline.final_disposition_due | default('N/A') }}</div>
        <div class="label">STR Filing Window</div>
        <div class="value">{{ sla_timeline.str_filing_window | default('N/A') }}</div>
      </div>
    </div>
    {% endif %}

    {# ‚îÄ‚îÄ FIX-035: Related Activity ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    {% if related_activity and (related_activity.prior_sars or related_activity.account_closures or related_activity.pep_connections or related_activity.screening_alerts) %}
    <h2>Related Activity</h2>
    <div class="card break">
      {% if related_activity.prior_sars %}
      <div style="margin-bottom:10px;">
        <span style="font-weight:600; font-size:13px;">Prior SARs:</span>
        <span class="pill trig" style="margin-left:6px;">{{ related_activity.prior_sars | length }}</span>
        <ul class="small" style="margin-top:4px;">
          {% for sar in related_activity.prior_sars[:5] %}
          <li>{{ sar }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      {% if related_activity.account_closures %}
      <div style="margin-bottom:10px;">
        <span style="font-weight:600; font-size:13px;">Account Closures:</span>
        <span class="pill req" style="margin-left:6px;">{{ related_activity.account_closures | length }}</span>
        <ul class="small" style="margin-top:4px;">
          {% for ac in related_activity.account_closures[:5] %}
          <li>{{ ac }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      {% if related_activity.pep_connections %}
      <div style="margin-bottom:10px;">
        <span style="font-weight:600; font-size:13px;">PEP Connections:</span>
        <ul class="small" style="margin-top:4px;">
          {% for pep in related_activity.pep_connections[:5] %}
          <li>{{ pep }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      {% if related_activity.screening_alerts %}
      <div>
        <span style="font-weight:600; font-size:13px;">Screening Alerts:</span>
        <span class="pill {% if related_activity.screening_alerts | length > 2 %}trig{% else %}req{% endif %}" style="margin-left:6px;">{{ related_activity.screening_alerts | length }}</span>
        <ul class="small" style="margin-top:4px;">
          {% for alert in related_activity.screening_alerts[:5] %}
          <li>{{ alert }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <h2>Auditability &amp; Governance</h2>
    <h3>Decision Provenance</h3>
    <div class="provenance break">
      <div class="kv">
        <div class="label">Decision Hash (SHA-256)</div>
        <div class="value mono hash">{{ decision_id }}</div>
        <div class="label">Input Hash</div>
        <div class="value mono hash">{{ input_hash }}</div>
        <div class="label">Policy Hash</div>
        <div class="value mono hash">{{ policy_hash }}</div>
        <div class="label">Decision Path</div>
        <div class="value mono">{{ decision_path_trace or action or 'N/A' }}</div>
        <div class="label">Engine Verdict (Raw)</div>
        <div class="value mono" style="{% if verdict != engine_verdict %}color:var(--muted); text-decoration:line-through;{% endif %}">{{ engine_verdict or action or 'N/A' }}</div>
        <div class="label">Governed Verdict</div>
        <div class="value mono" style="font-weight:700;">{{ verdict or 'N/A' }}</div>
        <div class="label">Engine Disposition</div>
        <div class="value mono" style="{% if engine_disposition != governed_disposition %}color:var(--muted);{% endif %}">{{ engine_disposition or 'N/A' }}</div>
        <div class="label">Governed Disposition</div>
        <div class="value mono" style="font-weight:700;">{{ governed_disposition or 'N/A' }}</div>
      </div>
      <p class="small" style="margin-top:12px;">
        This decision is cryptographically bound to the exact input and policy evaluated at decision time.
      </p>
    </div>

    <div class="statement break">
      <strong>Determinism & Auditability Statement</strong><br><br>
      This decision was produced by a deterministic rule engine operating under CA-FINTRAC regulatory framework.
      Re-evaluation using identical inputs and the same policy version will produce identical results.<br><br>
      The decision may be independently verified using the <code class="mono">/verify</code> endpoint. Complete decision lineage, rule sequencing, and evidentiary artifacts are preserved within the immutable audit record and available for supervisory review.
    </div>

    {% if str_required %}
    <div class="regulatory break">
      <strong>Regulatory Note</strong><br><br>
      A Suspicious Transaction Report (STR) is required under PCMLTFA/FINTRAC guidelines.
      File within applicable statutory timeframe per regulatory guidance (policy version: {{ policy_version }}).
    </div>
    {% endif %}

    <div class="foot">
      <strong>DecisionGraph</strong> ‚Äî Deterministic - Reproducible - Auditable<br>
      Generated {{ timestamp }}
    </div>
  </div>
</body>
</html>
