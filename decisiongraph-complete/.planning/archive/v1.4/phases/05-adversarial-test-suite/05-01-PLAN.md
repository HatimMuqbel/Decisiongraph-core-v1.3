---
phase: 05-adversarial-test-suite
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/test_adversarial_injection.py
  - tests/test_adversarial_traversal.py
autonomous: true

must_haves:
  truths:
    - "Predicate injection payloads fail with DG_INPUT_INVALID before reaching Scholar"
    - "Namespace traversal patterns fail with DG_INPUT_INVALID at RFA entry point"
    - "All attack vectors test both exception type AND error code"
    - "Existing 342 tests remain passing"
  artifacts:
    - path: "tests/test_adversarial_injection.py"
      provides: "SEC-01 predicate/subject injection tests"
      min_lines: 80
    - path: "tests/test_adversarial_traversal.py"
      provides: "SEC-02 namespace traversal tests"
      min_lines: 60
  key_links:
    - from: "tests/test_adversarial_injection.py"
      to: "decisiongraph.validators"
      via: "validate_predicate_field, validate_subject_field imports"
      pattern: "from decisiongraph.*import.*validate"
    - from: "tests/test_adversarial_traversal.py"
      to: "decisiongraph.engine"
      via: "process_rfa import for end-to-end testing"
      pattern: "from decisiongraph.*import.*process_rfa"
---

<objective>
Create adversarial test files for input validation attack vectors (SEC-01, SEC-02).

Purpose: Prove that injection and traversal attacks are rejected with deterministic error codes at the validation layer, before malicious input reaches the core engine.

Output: Two test files with parametrized attack vectors verifying DG_INPUT_INVALID error codes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-adversarial-test-suite/05-RESEARCH.md

# Source files being tested
@src/decisiongraph/validators.py
@src/decisiongraph/engine.py
@src/decisiongraph/cell.py

# Existing test patterns
@tests/test_validators.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SEC-01 predicate/subject injection tests</name>
  <files>tests/test_adversarial_injection.py</files>
  <action>
Create test_adversarial_injection.py with comprehensive injection attack tests.

Structure:
```python
"""
Adversarial Test Suite: Injection Attacks (SEC-01)

Tests that predicate and subject injection payloads return DG_INPUT_INVALID
before reaching the Scholar query engine.
"""

import pytest
from decisiongraph import (
    InputInvalidError,
    create_chain,
    process_rfa
)
from decisiongraph.validators import (
    validate_predicate_field,
    validate_subject_field
)
```

Class TestPredicateInjection:
- Use @pytest.mark.parametrize with attack vectors:
  - SQL-style: "can;drop table", "can' OR '1'='1", "can--comment", "can/**/admin"
  - Null byte: "can\x00drop"
  - Newline: "can\nDROP TABLE"
  - Space: "can access" (from success criteria)
  - Case bypass: "CAN_ACCESS"
  - Hyphen: "can-access"
  - Special chars: "can@admin", "can#anchor", "can$var"
- Each test asserts:
  1. InputInvalidError is raised
  2. error.code == "DG_INPUT_INVALID"
  3. error.details contains "field": "predicate"

Class TestSubjectInjection:
- Similar parametrized tests for subject field
- Attack vectors: semicolon, null byte, SQL quotes, case bypass, forbidden chars

Class TestInjectionAtEngineLevel:
- Test that injections through process_rfa() fail at validation layer
- Uses create_chain() and process_rfa() to test end-to-end
- Verifies malicious predicates in RFA dict are rejected with DG_INPUT_INVALID

Include docstrings explaining each attack type for documentation value.
  </action>
  <verify>pytest tests/test_adversarial_injection.py -v passes with all tests green</verify>
  <done>
    - test_adversarial_injection.py exists with 3 test classes
    - Predicate injection payloads (semicolon, quotes, null byte, space, etc.) all fail with DG_INPUT_INVALID
    - Subject injection payloads fail with DG_INPUT_INVALID
    - End-to-end injection through process_rfa() fails at validation layer
    - All tests verify both exception type AND error code
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SEC-02 namespace traversal tests</name>
  <files>tests/test_adversarial_traversal.py</files>
  <action>
Create test_adversarial_traversal.py with namespace traversal attack tests.

Structure:
```python
"""
Adversarial Test Suite: Namespace Traversal (SEC-02)

Tests that namespace traversal patterns return DG_INPUT_INVALID
at the RFA entry point.
"""

import pytest
from decisiongraph import (
    InputInvalidError,
    create_chain,
    process_rfa
)
from decisiongraph.cell import validate_namespace
```

Class TestNamespaceTraversalPatterns:
- Test validate_namespace() directly with traversal patterns:
  - Double-dot: "corp..hr" (from success criteria)
  - Slash: "corp/hr" (from success criteria)
  - Unix traversal: "corp/../admin", "../etc/passwd"
  - Windows: "corp\\hr"
  - Absolute path: "/etc/passwd"
  - Trailing dot: "corp.hr."
  - Leading dot: ".hidden"
  - Multiple dots: "corp...hr"
  - Null byte: "corp.hr\x00admin"
  - Semicolon: "corp.hr;admin"
- Assert validate_namespace() returns False for all attack patterns

Class TestNamespaceTraversalAtRFALevel:
- Test that traversal through process_rfa() raises InputInvalidError
- Uses create_chain() and process_rfa() with malicious namespace
- Attack vectors in RFA dict:
  - "namespace": "corp..hr" -> DG_INPUT_INVALID
  - "namespace": "corp/hr" -> DG_INPUT_INVALID
  - "requester_namespace": "corp/../admin" -> DG_INPUT_INVALID
- Each test asserts:
  1. InputInvalidError is raised
  2. error.code == "DG_INPUT_INVALID"
  3. "namespace" appears in error message or details

Include tests for both "namespace" and "requester_namespace" fields to ensure complete coverage.
  </action>
  <verify>pytest tests/test_adversarial_traversal.py -v passes with all tests green</verify>
  <done>
    - test_adversarial_traversal.py exists with 2 test classes
    - Namespace "corp..hr" fails validation (double-dot traversal)
    - Namespace "corp/hr" fails validation (slash instead of dot)
    - All traversal patterns (Unix, Windows, absolute path, etc.) fail
    - End-to-end traversal through process_rfa() fails with DG_INPUT_INVALID
    - Both namespace and requester_namespace fields are tested
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify full test suite passes</name>
  <files>tests/test_adversarial_injection.py, tests/test_adversarial_traversal.py</files>
  <action>
Run the complete test suite to verify:
1. All new adversarial tests pass
2. Existing 342 tests remain passing
3. No regressions introduced

Commands:
```bash
# Run full test suite
pytest tests/ -v --tb=short

# Verify test count increased (should be 342 + new adversarial tests)
pytest tests/ --collect-only | tail -5
```

If any existing tests fail, investigate and fix without modifying the new adversarial tests (the existing tests should continue to work).
  </action>
  <verify>
    - pytest tests/ passes with 0 failures
    - Test count > 342 (new tests added)
    - Output shows both test_adversarial_*.py files ran
  </verify>
  <done>
    - Full test suite passes (342+ tests, 0 failures)
    - New adversarial tests integrated without regressions
    - SEC-01 and SEC-02 requirements satisfied
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. SEC-01 verification:
   - `pytest tests/test_adversarial_injection.py -v` shows all injection tests pass
   - Predicate "can;drop table" fails with DG_INPUT_INVALID
   - Predicate "can access" (space) fails with DG_INPUT_INVALID

2. SEC-02 verification:
   - `pytest tests/test_adversarial_traversal.py -v` shows all traversal tests pass
   - Namespace "corp..hr" fails with DG_INPUT_INVALID
   - Namespace "corp/hr" fails with DG_INPUT_INVALID

3. Regression check:
   - `pytest tests/ --tb=short` shows all 342+ tests pass
</verification>

<success_criteria>
- [ ] test_adversarial_injection.py created with SEC-01 tests
- [ ] test_adversarial_traversal.py created with SEC-02 tests
- [ ] Predicate injection attacks return DG_INPUT_INVALID (not passed to Scholar)
- [ ] Namespace traversal attacks return DG_INPUT_INVALID (no path traversal)
- [ ] All tests verify both exception type AND error code
- [ ] Existing 342 tests remain passing
- [ ] Total test count > 342
</success_criteria>

<output>
After completion, create `.planning/phases/05-adversarial-test-suite/05-01-SUMMARY.md`
</output>
