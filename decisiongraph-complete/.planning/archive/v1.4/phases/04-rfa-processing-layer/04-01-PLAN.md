---
phase: 04-rfa-processing-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/decisiongraph/engine.py
  - src/decisiongraph/__init__.py
  - tests/test_engine.py
autonomous: true

must_haves:
  truths:
    - "process_rfa() with valid RFA returns ProofPacket containing decision and proof bundle"
    - "process_rfa() with missing required field returns DG_SCHEMA_INVALID"
    - "process_rfa() with invalid subject/predicate/object returns DG_INPUT_INVALID"
    - "RFA input is canonicalized before validation (sorted keys, stripped whitespace)"
    - "ProofPacket includes proof_bundle from Scholar query"
  artifacts:
    - path: "src/decisiongraph/engine.py"
      provides: "Engine class with process_rfa() method"
      exports: ["Engine", "process_rfa"]
    - path: "tests/test_engine.py"
      provides: "Engine tests for happy path, schema validation, field validation"
      contains: "TestEngineHappyPath, TestEngineSchemaValidation, TestEngineFieldValidation"
  key_links:
    - from: "src/decisiongraph/engine.py"
      to: "src/decisiongraph/scholar.py"
      via: "Scholar.query_facts()"
      pattern: "self\\.scholar\\.query_facts"
    - from: "src/decisiongraph/engine.py"
      to: "src/decisiongraph/validators.py"
      via: "validate_subject_field, validate_predicate_field, validate_object_field"
      pattern: "validate_.*_field"
    - from: "src/decisiongraph/engine.py"
      to: "src/decisiongraph/exceptions.py"
      via: "SchemaInvalidError, InputInvalidError"
      pattern: "raise Schema|raise Input"
---

<objective>
Create the Engine class with process_rfa() method that provides a single validated entry point for querying DecisionGraph.

Purpose: External developers can call `engine.process_rfa(rfa_dict)` and receive either a ProofPacket on success or a DecisionGraphError on failure. This is the core API boundary for v1.4.

Output:
- `src/decisiongraph/engine.py` with Engine class and process_rfa()
- `tests/test_engine.py` with comprehensive tests
- Updated `__init__.py` exports
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-rfa-processing-layer/04-RESEARCH.md

# Prior phase summaries for dependencies
@.planning/phases/01-error-foundation/01-01-SUMMARY.md
@.planning/phases/02-input-validation/02-01-SUMMARY.md
@.planning/phases/03-signing-utilities/03-01-SUMMARY.md

# Relevant source files
@src/decisiongraph/scholar.py
@src/decisiongraph/validators.py
@src/decisiongraph/exceptions.py
@src/decisiongraph/cell.py
@src/decisiongraph/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Engine class with process_rfa() pipeline</name>
  <files>src/decisiongraph/engine.py</files>
  <action>
Create a new file `src/decisiongraph/engine.py` implementing:

1. **Engine class** with constructor:
   ```python
   def __init__(
       self,
       chain: Chain,
       signing_key: Optional[bytes] = None,
       public_key: Optional[bytes] = None,
       verify_cell_signatures: bool = False
   ):
       self.chain = chain
       self.scholar = create_scholar(chain)  # Initialize Scholar for query_facts()
       self.signing_key = signing_key
       self.public_key = public_key
       self.verify_cell_signatures = verify_cell_signatures
   ```

2. **process_rfa(self, rfa_dict: dict) -> dict** implementing 7-step pipeline:
   - Step 1: `_canonicalize_rfa(rfa_dict)` - Sort keys alphabetically, strip whitespace from strings, remove None values (RFA-03)
   - Step 2: `_validate_rfa_schema(canonical_rfa)` - Check required fields: namespace, requester_namespace, requester_id (RFA-02)
   - Step 3: `_validate_rfa_fields(canonical_rfa)` - Use validators.py for subject/predicate/object (VAL-01/02/03)
   - Step 4: Call `self.scholar.query_facts()` with parameters from canonical_rfa
   - Step 5: Call `result.to_proof_bundle()` to get canonical proof
   - Step 6: Wrap in ProofPacket dict with: packet_version="1.4", packet_id=uuid4, generated_at=timestamp, graph_id, proof_bundle, signature=None
   - Step 7: Return ProofPacket (signing handled in Plan 02)

3. **Helper methods:**
   - `_canonicalize_rfa(rfa_dict: dict) -> dict`: Use `json.dumps(sort_keys=True)` then parse back, strip string whitespace, remove None values
   - `_validate_rfa_schema(rfa: dict) -> None`: Check required fields exist and are strings, raise SchemaInvalidError if not
   - `_validate_rfa_fields(rfa: dict) -> None`: Validate namespace with validate_namespace(), validate subject/predicate/object if present using validators.py

4. **Exception handling:**
   - Catch DecisionGraphError subclasses and re-raise as-is
   - Catch internal exceptions (ChainError, NamespaceError, GenesisError) and wrap using wrap_internal_exception()
   - Catch unexpected exceptions and wrap as InternalError

5. **Convenience function:**
   - `process_rfa(chain, rfa_dict, signing_key=None, public_key=None) -> dict`: Creates Engine and calls process_rfa()

6. **Imports:**
   - json, uuid, typing (Optional, Dict, Any)
   - from .chain import Chain
   - from .scholar import create_scholar
   - from .validators import validate_subject_field, validate_predicate_field, validate_object_field
   - from .cell import validate_namespace, get_current_timestamp
   - from .exceptions import (all DecisionGraphError subclasses, wrap_internal_exception, EXCEPTION_MAP)

Key implementation details from research:
- RFA required fields: namespace, requester_namespace, requester_id
- RFA optional fields: subject, predicate, object, at_valid_time, as_of_system_time
- ProofPacket structure: packet_version, packet_id, generated_at, graph_id, proof_bundle, signature
- Access denial is NOT an exception - return ProofPacket with authorization.allowed=False for auditing
  </action>
  <verify>
Run `python -c "from decisiongraph.engine import Engine, process_rfa; print('Import successful')"` - should print success message
  </verify>
  <done>
Engine class exists with process_rfa() method implementing 7-step pipeline. All helper methods implemented. Convenience function process_rfa() exported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Engine tests for happy path and validation</name>
  <files>tests/test_engine.py</files>
  <action>
Create a new file `tests/test_engine.py` with comprehensive tests:

**1. TestEngineHappyPath** (4 tests):
- `test_process_rfa_valid_query_returns_proof_packet()`: Valid RFA returns dict with packet_version, packet_id, proof_bundle
- `test_process_rfa_includes_scholar_results()`: ProofPacket includes facts, authorization basis
- `test_process_rfa_unsigned_packet_has_null_signature()`: When Engine has no signing key, signature field is None
- `test_process_rfa_deterministic_proof_bundle()`: Same RFA produces identical proof_bundle (excluding packet_id/generated_at)

**2. TestEngineSchemaValidation** (4 tests):
- `test_process_rfa_missing_namespace_raises_schema_invalid()`: Missing 'namespace' raises SchemaInvalidError with code DG_SCHEMA_INVALID
- `test_process_rfa_missing_requester_namespace_raises_schema_invalid()`: Missing 'requester_namespace' raises SchemaInvalidError
- `test_process_rfa_missing_requester_id_raises_schema_invalid()`: Missing 'requester_id' raises SchemaInvalidError
- `test_process_rfa_wrong_type_raises_schema_invalid()`: Integer for 'namespace' raises SchemaInvalidError

**3. TestEngineFieldValidation** (4 tests):
- `test_process_rfa_invalid_subject_raises_input_invalid()`: Subject 'USER:alice' (uppercase) raises InputInvalidError
- `test_process_rfa_invalid_predicate_raises_input_invalid()`: Predicate 'has salary' (space) raises InputInvalidError
- `test_process_rfa_invalid_object_raises_input_invalid()`: Object with control char raises InputInvalidError
- `test_process_rfa_invalid_namespace_raises_input_invalid()`: Namespace 'CORP.HR' (uppercase) raises InputInvalidError

**4. TestEngineCanonicalization** (3 tests):
- `test_canonicalize_rfa_sorts_keys()`: Output dict has alphabetically sorted keys
- `test_canonicalize_rfa_strips_whitespace()`: Leading/trailing whitespace removed from string values
- `test_canonicalize_rfa_removes_none_values()`: None values removed from output

**5. Fixtures:**
- `@pytest.fixture` for test_chain: Create chain with genesis + some fact cells
- `@pytest.fixture` for test_engine: Engine(test_chain)
- `@pytest.fixture` for valid_rfa: Dict with namespace, requester_namespace, requester_id

Test each error case verifies:
1. Exception type is correct (SchemaInvalidError, InputInvalidError)
2. Error code is correct (DG_SCHEMA_INVALID, DG_INPUT_INVALID)
3. Details dict contains helpful information (missing_fields, field, value)
  </action>
  <verify>
Run `pytest tests/test_engine.py -v` - all tests pass
  </verify>
  <done>
15 tests covering happy path, schema validation, field validation, and canonicalization. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Export Engine from package and run full test suite</name>
  <files>src/decisiongraph/__init__.py</files>
  <action>
1. Update `src/decisiongraph/__init__.py`:

Add import section after signing utilities:
```python
# Engine (v1.4)
from .engine import (
    Engine,
    process_rfa
)
```

Add to __all__ list:
```python
    # Engine (v1.4)
    'Engine', 'process_rfa',
```

2. Run full test suite to verify no regressions:
- All 313 existing tests must pass
- All new engine tests must pass
- Total should be ~328 tests (313 + 15 new)

3. Verify imports work from top-level:
```python
from decisiongraph import Engine, process_rfa
```
  </action>
  <verify>
Run `pytest --tb=short` - all tests pass (313+ existing + new tests)
  </verify>
  <done>
Engine and process_rfa exported from package. Full test suite passes with no regressions. Engine can be imported directly from decisiongraph package.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from decisiongraph import Engine, process_rfa"` succeeds
2. `pytest tests/test_engine.py -v` - all 15 tests pass
3. `pytest --tb=short` - all 328+ tests pass
4. No linting errors in new files
</verification>

<success_criteria>
- Engine class exists at src/decisiongraph/engine.py
- process_rfa() implements 7-step validation pipeline
- Valid RFA returns ProofPacket with proof_bundle from Scholar
- Missing required field raises SchemaInvalidError (DG_SCHEMA_INVALID)
- Invalid field format raises InputInvalidError (DG_INPUT_INVALID)
- Input is canonicalized before validation (RFA-03)
- All 313 existing tests pass
- 15 new engine tests pass
- RFA-01, RFA-02, RFA-03 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-rfa-processing-layer/04-01-SUMMARY.md`
</output>
