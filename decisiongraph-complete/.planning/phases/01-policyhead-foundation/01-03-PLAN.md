---
phase: 01-policyhead-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/decisiongraph/genesis.py
  - src/decisiongraph/policyhead.py
  - tests/test_bootstrap.py
autonomous: true

must_haves:
  truths:
    - "Genesis cell can include initial WitnessSet without circular dependency"
    - "Bootstrap mode (1-of-1 threshold) allows single witness operation"
    - "Production mode requires minimum 2-of-N threshold"
    - "Threshold validation enforces 1 <= threshold <= len(witnesses)"
    - "WitnessSet is extracted from Genesis via parse_genesis_witness_set()"
  artifacts:
    - path: "src/decisiongraph/genesis.py"
      provides: "Enhanced Genesis with WitnessSet embedding"
      exports: ["create_genesis_cell_with_witness_set", "parse_genesis_witness_set"]
    - path: "src/decisiongraph/policyhead.py"
      provides: "Threshold validation function"
      exports: ["validate_threshold"]
    - path: "tests/test_bootstrap.py"
      provides: "Bootstrap and threshold validation tests"
      min_lines: 150
  key_links:
    - from: "src/decisiongraph/genesis.py"
      to: "src/decisiongraph/policyhead.py"
      via: "imports validate_threshold"
      pattern: "from.*policyhead.*import.*validate_threshold"
    - from: "tests/test_bootstrap.py"
      to: "src/decisiongraph/genesis.py"
      via: "tests witness set embedding"
      pattern: "create_genesis_cell_with_witness_set|parse_genesis_witness_set"
---

<objective>
Implement Genesis WitnessSet embedding and threshold validation for bootstrap and production modes.

Purpose: Solves the bootstrap paradox (BOT-01) by embedding initial WitnessSet in Genesis, enabling both development (1-of-1) and production (2-of-N) operational modes.

Output: Genesis cells that include initial WitnessSet data, with proper threshold validation for both bootstrap and production modes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-policyhead-foundation/01-RESEARCH.md

# Depends on Plan 01 completion (CellType.POLICY_HEAD, compute_policy_hash)
@.planning/phases/01-policyhead-foundation/01-01-SUMMARY.md

@src/decisiongraph/genesis.py
@src/decisiongraph/policyhead.py
@tests/test_core.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add threshold validation to policyhead.py</name>
  <files>src/decisiongraph/policyhead.py</files>
  <action>
Add threshold validation function to src/decisiongraph/policyhead.py (at the beginning, after imports):

```python
def validate_threshold(threshold: int, witnesses: List[str]) -> Tuple[bool, str]:
    """
    Validate that a threshold value is valid for a witness set.

    Rules:
    - threshold must be >= 1 (at least one signature required)
    - threshold must be <= len(witnesses) (can't require more than available)
    - witnesses list cannot be empty

    Args:
        threshold: Number of signatures required
        witnesses: List of witness IDs

    Returns:
        Tuple of (is_valid, error_message)
        error_message is empty string if valid

    Examples:
        >>> validate_threshold(1, ["alice"])  # Bootstrap: (True, "")
        >>> validate_threshold(2, ["alice", "bob"])  # Production: (True, "")
        >>> validate_threshold(0, ["alice"])  # Invalid: (False, "...")
        >>> validate_threshold(2, ["alice"])  # Invalid: (False, "...")
    """
    if not witnesses:
        return False, "Witness list cannot be empty"

    if threshold < 1:
        return False, f"Threshold must be >= 1, got {threshold}"

    if threshold > len(witnesses):
        return False, (
            f"Threshold ({threshold}) cannot exceed number of witnesses "
            f"({len(witnesses)})"
        )

    return True, ""


def is_bootstrap_threshold(threshold: int, witnesses: List[str]) -> bool:
    """
    Check if a threshold configuration is bootstrap mode (1-of-1).

    Bootstrap mode allows a single witness to approve promotions,
    useful for development and initial deployment.

    Args:
        threshold: Number of signatures required
        witnesses: List of witness IDs

    Returns:
        True if this is bootstrap mode (1-of-1)
    """
    return threshold == 1 and len(witnesses) == 1


def is_production_threshold(threshold: int, witnesses: List[str]) -> bool:
    """
    Check if a threshold configuration meets production requirements.

    Production mode requires:
    - At least 2 witnesses
    - Threshold of at least 2

    This ensures no single point of failure for policy promotion.

    Args:
        threshold: Number of signatures required
        witnesses: List of witness IDs

    Returns:
        True if this meets production requirements
    """
    return len(witnesses) >= 2 and threshold >= 2
```

Update __all__ to include new exports:
```python
__all__ = [
    # Threshold validation
    'validate_threshold',
    'is_bootstrap_threshold',
    'is_production_threshold',

    # Creation
    'create_policy_head',

    # Query
    'get_current_policy_head',
    'get_policy_head_chain',
    'get_policy_head_at_time',

    # Parsing/verification
    'parse_policy_data',
    'verify_policy_hash',
    'validate_policy_head_chain',

    # Constants
    'POLICY_PROMOTION_RULE',
    'POLICY_PROMOTION_RULE_HASH',
    'POLICYHEAD_SCHEMA_VERSION'
]
```

CRITICAL: Test boundary conditions carefully:
- threshold=0 is INVALID (must be >= 1)
- threshold=1 with 1 witness is VALID (bootstrap)
- threshold=N with N witnesses is VALID (unanimous)
- threshold=N+1 with N witnesses is INVALID
  </action>
  <verify>
Run: `python -c "from decisiongraph.policyhead import validate_threshold, is_bootstrap_threshold, is_production_threshold; print(validate_threshold(1, ['alice'])); print(is_bootstrap_threshold(1, ['alice'])); print(is_production_threshold(2, ['alice', 'bob']))"`
Expected: `(True, '')`, `True`, `True`
  </verify>
  <done>
- validate_threshold() enforces 1 <= threshold <= len(witnesses)
- is_bootstrap_threshold() identifies 1-of-1 configuration
- is_production_threshold() identifies 2-of-N configuration
- All edge cases handled correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Add WitnessSet embedding to Genesis</name>
  <files>src/decisiongraph/genesis.py</files>
  <action>
Add WitnessSet embedding functions to src/decisiongraph/genesis.py.

First, add imports at the top:
```python
from .policyhead import validate_threshold
```

Add these functions after the existing create_genesis_cell function:

```python
def create_genesis_cell_with_witness_set(
    graph_name: str = "UniversalDecisionGraph",
    root_namespace: str = DEFAULT_ROOT_NAMESPACE,
    witnesses: List[str] = None,
    threshold: int = 1,
    graph_id: Optional[str] = None,
    creator: Optional[str] = None,
    creator_key_id: Optional[str] = None,
    system_time: Optional[str] = None,
    bootstrap_mode: bool = True
) -> DecisionCell:
    """
    Create a Genesis cell with embedded WitnessSet.

    This solves the bootstrap paradox: the initial WitnessSet is embedded
    in Genesis rather than being a separate cell that would need approval.
    Genesis is the trusted root - it establishes the initial authority.

    The WitnessSet is stored in fact.object as JSON, alongside the graph_name.

    Args:
        graph_name: Human-readable name for this graph instance
        root_namespace: The root namespace (no dots, e.g., "corp", "acme")
        witnesses: List of witness IDs who can approve promotions
                   Default: [creator or "system:bootstrap"] for bootstrap mode
        threshold: Number of witnesses required to approve (1-of-N)
                   Default: 1 (bootstrap mode)
        graph_id: Optional specific graph_id (auto-generated if not provided)
        creator: Optional identifier of who/what created this graph
        creator_key_id: Optional reference to signing key
        system_time: Optional timestamp (defaults to now, must be ISO 8601 UTC)
        bootstrap_mode: If True, signature is not required (initial deployment)

    Returns:
        Genesis DecisionCell with embedded WitnessSet

    Raises:
        GenesisError: If namespace, graph_id, or threshold is invalid

    Example:
        >>> # Bootstrap mode: single witness for development
        >>> genesis = create_genesis_cell_with_witness_set(
        ...     graph_name="DevGraph",
        ...     root_namespace="dev",
        ...     witnesses=["dev:admin"],
        ...     threshold=1
        ... )

        >>> # Production mode: 2-of-3 witnesses
        >>> genesis = create_genesis_cell_with_witness_set(
        ...     graph_name="ProdGraph",
        ...     root_namespace="prod",
        ...     witnesses=["witness:alice", "witness:bob", "witness:charlie"],
        ...     threshold=2,
        ...     bootstrap_mode=False
        ... )
    """
    # Default witnesses if not provided
    if witnesses is None:
        default_witness = creator or "system:bootstrap"
        witnesses = [default_witness]

    # Validate threshold
    is_valid, error_msg = validate_threshold(threshold, witnesses)
    if not is_valid:
        raise GenesisError(f"Invalid threshold configuration: {error_msg}")

    # Validate root namespace
    if not validate_root_namespace(root_namespace):
        raise GenesisError(
            f"Invalid root namespace: '{root_namespace}'. "
            f"Must be lowercase letter followed by alphanumeric/underscore, "
            f"2-64 chars, no dots, no trailing underscores."
        )

    # Generate or validate graph_id
    gid = graph_id or generate_graph_id()
    if not validate_graph_id(gid):
        raise GenesisError(
            f"Invalid graph_id format: '{gid}'. "
            f"Must be 'graph:<uuid-v4>' format."
        )

    # Use provided system_time or current time
    ts = system_time or get_current_timestamp()
    if not validate_timestamp(ts):
        raise GenesisError(
            f"Invalid system_time format: '{ts}'. "
            f"Must be ISO 8601 with UTC timezone (e.g., '2026-01-26T15:00:00Z')"
        )

    # Build Genesis object with embedded WitnessSet
    # This is the key innovation: WitnessSet is part of Genesis, not a separate cell
    genesis_data = {
        "graph_name": graph_name,
        "initial_witness_set": {
            "namespace": root_namespace,
            "witnesses": sorted(witnesses),  # Deterministic ordering
            "threshold": threshold
        }
    }

    # Create the Genesis header
    header = Header(
        version=SCHEMA_VERSION,
        graph_id=gid,
        cell_type=CellType.GENESIS,
        system_time=ts,
        prev_cell_hash=NULL_HASH
    )

    # Create the Genesis fact with WitnessSet in object
    fact = Fact(
        namespace=root_namespace,
        subject="graph:root",
        predicate="instance_of",
        object=json.dumps(genesis_data, sort_keys=True),  # JSON with WitnessSet
        confidence=1.0,
        source_quality=SourceQuality.VERIFIED,
        valid_from=ts,
        valid_to=None
    )

    # Create the Logic Anchor
    logic_anchor = LogicAnchor(
        rule_id="system:genesis_boot_v1.3",
        rule_logic_hash=GENESIS_RULE_HASH,
        interpreter="system:v1.3"
    )

    # Create the proof
    proof = Proof(
        signer_id=creator or "system:genesis",
        signer_key_id=creator_key_id,
        signature=None,
        merkle_root=None,
        signature_required=not bootstrap_mode
    )

    return DecisionCell(
        header=header,
        fact=fact,
        logic_anchor=logic_anchor,
        evidence=[],
        proof=proof
    )


def parse_genesis_witness_set(genesis: DecisionCell) -> Optional[dict]:
    """
    Extract the initial WitnessSet from a Genesis cell.

    Genesis cells created with create_genesis_cell_with_witness_set()
    have a WitnessSet embedded in fact.object. This function extracts it.

    Args:
        genesis: A Genesis DecisionCell

    Returns:
        Dict with keys: namespace, witnesses, threshold
        Or None if Genesis doesn't have embedded WitnessSet

    Raises:
        ValueError: If cell is not a Genesis cell

    Example:
        >>> ws = parse_genesis_witness_set(genesis)
        >>> print(f"Threshold: {ws['threshold']}/{len(ws['witnesses'])}")
    """
    if genesis.header.cell_type != CellType.GENESIS:
        raise ValueError(
            f"Expected GENESIS cell, got {genesis.header.cell_type.value}"
        )

    try:
        data = json.loads(genesis.fact.object)
        return data.get("initial_witness_set")
    except json.JSONDecodeError:
        # Legacy Genesis with simple string object
        return None


def has_witness_set(genesis: DecisionCell) -> bool:
    """
    Check if a Genesis cell has an embedded WitnessSet.

    Args:
        genesis: A Genesis DecisionCell

    Returns:
        True if Genesis has embedded WitnessSet
    """
    return parse_genesis_witness_set(genesis) is not None
```

Add import for json at the top if not already present:
```python
import json
```

Update __all__ to include new exports:
```python
__all__ = [
    # Main functions
    'create_genesis_cell',
    'create_genesis_cell_with_witness_set',  # NEW
    'verify_genesis',
    'verify_genesis_strict',
    'is_genesis',

    # WitnessSet extraction
    'parse_genesis_witness_set',  # NEW
    'has_witness_set',  # NEW

    # Validation
    'validate_graph_id',

    # Rule access
    'get_genesis_rule',
    'get_genesis_rule_hash',
    'get_canonicalized_genesis_rule',

    # Exceptions
    'GenesisError',
    'GenesisValidationError',

    # Constants
    'GENESIS_RULE',
    'GENESIS_RULE_HASH',
    'DEFAULT_ROOT_NAMESPACE',
    'SCHEMA_VERSION',
    'GRAPH_ID_PATTERN'
]
```

IMPORTANT: The WitnessSet is embedded in fact.object as JSON. This maintains backward compatibility - old Genesis cells with simple string objects still work (parse_genesis_witness_set returns None for them).
  </action>
  <verify>
Run: `python -c "from decisiongraph.genesis import create_genesis_cell_with_witness_set, parse_genesis_witness_set; g = create_genesis_cell_with_witness_set('Test', 'corp', ['alice', 'bob'], 2); ws = parse_genesis_witness_set(g); print(f'Threshold: {ws[\"threshold\"]}, Witnesses: {ws[\"witnesses\"]}')"`
Expected: `Threshold: 2, Witnesses: ['alice', 'bob']`
  </verify>
  <done>
- create_genesis_cell_with_witness_set() creates Genesis with embedded WitnessSet
- parse_genesis_witness_set() extracts WitnessSet from Genesis
- has_witness_set() checks if Genesis has embedded WitnessSet
- Backward compatible with legacy Genesis cells
  </done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive bootstrap and threshold tests</name>
  <files>tests/test_bootstrap.py</files>
  <action>
Create new file tests/test_bootstrap.py with comprehensive tests:

```python
"""
DecisionGraph: Bootstrap and Threshold Test Suite (v1.5)

Tests for:
1. Threshold validation (BOT-02, BOT-03)
2. Genesis WitnessSet embedding (BOT-01)
3. Bootstrap mode (1-of-1) operation
4. Production mode (2-of-N) operation
5. Edge cases and boundary conditions

Requirements covered:
- BOT-01: Genesis includes initial WitnessSet
- BOT-02: Bootstrap mode allows 1-of-1 witness set
- BOT-03: Production mode requires minimum 2-of-N threshold
"""

import pytest
import json
import sys
import os
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'src'))

from decisiongraph import (
    CellType,
    Chain,
    create_chain
)

from decisiongraph.genesis import (
    create_genesis_cell,
    create_genesis_cell_with_witness_set,
    parse_genesis_witness_set,
    has_witness_set,
    GenesisError
)

from decisiongraph.policyhead import (
    validate_threshold,
    is_bootstrap_threshold,
    is_production_threshold
)

# Import test time constants
from test_utils import T0, T1


class TestValidateThreshold:
    """Tests for validate_threshold function"""

    def test_valid_bootstrap_threshold(self):
        """1-of-1 threshold should be valid (bootstrap mode)"""
        is_valid, error = validate_threshold(1, ["alice"])
        assert is_valid is True
        assert error == ""

    def test_valid_production_threshold_2_of_2(self):
        """2-of-2 threshold should be valid"""
        is_valid, error = validate_threshold(2, ["alice", "bob"])
        assert is_valid is True

    def test_valid_production_threshold_2_of_3(self):
        """2-of-3 threshold should be valid"""
        is_valid, error = validate_threshold(2, ["alice", "bob", "charlie"])
        assert is_valid is True

    def test_valid_unanimous_threshold(self):
        """N-of-N threshold should be valid (unanimous)"""
        is_valid, error = validate_threshold(3, ["alice", "bob", "charlie"])
        assert is_valid is True

    def test_invalid_zero_threshold(self):
        """Threshold of 0 should be invalid"""
        is_valid, error = validate_threshold(0, ["alice"])
        assert is_valid is False
        assert ">= 1" in error

    def test_invalid_negative_threshold(self):
        """Negative threshold should be invalid"""
        is_valid, error = validate_threshold(-1, ["alice"])
        assert is_valid is False
        assert ">= 1" in error

    def test_invalid_threshold_exceeds_witnesses(self):
        """Threshold > len(witnesses) should be invalid"""
        is_valid, error = validate_threshold(2, ["alice"])
        assert is_valid is False
        assert "cannot exceed" in error

    def test_invalid_empty_witnesses(self):
        """Empty witness list should be invalid"""
        is_valid, error = validate_threshold(1, [])
        assert is_valid is False
        assert "cannot be empty" in error

    def test_threshold_equal_to_witnesses(self):
        """Threshold == len(witnesses) should be valid"""
        is_valid, error = validate_threshold(5, ["a", "b", "c", "d", "e"])
        assert is_valid is True


class TestIsBootstrapThreshold:
    """Tests for is_bootstrap_threshold function (BOT-02)"""

    def test_1_of_1_is_bootstrap(self):
        """1-of-1 is bootstrap mode"""
        assert is_bootstrap_threshold(1, ["alice"]) is True

    def test_1_of_2_is_not_bootstrap(self):
        """1-of-2 is NOT bootstrap mode (multiple witnesses)"""
        assert is_bootstrap_threshold(1, ["alice", "bob"]) is False

    def test_2_of_2_is_not_bootstrap(self):
        """2-of-2 is NOT bootstrap mode"""
        assert is_bootstrap_threshold(2, ["alice", "bob"]) is False


class TestIsProductionThreshold:
    """Tests for is_production_threshold function (BOT-03)"""

    def test_2_of_2_is_production(self):
        """2-of-2 meets production requirements"""
        assert is_production_threshold(2, ["alice", "bob"]) is True

    def test_2_of_3_is_production(self):
        """2-of-3 meets production requirements"""
        assert is_production_threshold(2, ["alice", "bob", "charlie"]) is True

    def test_3_of_5_is_production(self):
        """3-of-5 meets production requirements"""
        witnesses = ["a", "b", "c", "d", "e"]
        assert is_production_threshold(3, witnesses) is True

    def test_1_of_1_is_not_production(self):
        """1-of-1 does NOT meet production requirements"""
        assert is_production_threshold(1, ["alice"]) is False

    def test_1_of_2_is_not_production(self):
        """1-of-2 does NOT meet production (threshold too low)"""
        assert is_production_threshold(1, ["alice", "bob"]) is False

    def test_2_of_1_is_not_production(self):
        """2-of-1 is invalid (would fail threshold validation anyway)"""
        # This is an invalid config, but the function should return False
        assert is_production_threshold(2, ["alice"]) is False


class TestCreateGenesisWithWitnessSet:
    """Tests for create_genesis_cell_with_witness_set function (BOT-01)"""

    def test_creates_valid_genesis(self):
        """Should create a valid Genesis cell"""
        genesis = create_genesis_cell_with_witness_set(
            graph_name="TestGraph",
            root_namespace="corp",
            witnesses=["alice"],
            threshold=1,
            system_time=T0
        )

        assert genesis.header.cell_type == CellType.GENESIS
        assert genesis.verify_integrity()

    def test_witness_set_in_fact_object(self):
        """WitnessSet should be embedded in fact.object"""
        genesis = create_genesis_cell_with_witness_set(
            graph_name="TestGraph",
            root_namespace="corp",
            witnesses=["alice", "bob"],
            threshold=2,
            system_time=T0
        )

        data = json.loads(genesis.fact.object)
        assert "graph_name" in data
        assert "initial_witness_set" in data

        ws = data["initial_witness_set"]
        assert ws["namespace"] == "corp"
        assert ws["witnesses"] == ["alice", "bob"]  # Should be sorted
        assert ws["threshold"] == 2

    def test_witnesses_are_sorted(self):
        """Witnesses should be stored in sorted order (deterministic)"""
        genesis = create_genesis_cell_with_witness_set(
            graph_name="TestGraph",
            root_namespace="corp",
            witnesses=["charlie", "alice", "bob"],  # Unsorted input
            threshold=2,
            system_time=T0
        )

        ws = parse_genesis_witness_set(genesis)
        assert ws["witnesses"] == ["alice", "bob", "charlie"]  # Sorted

    def test_invalid_threshold_raises(self):
        """Invalid threshold should raise GenesisError"""
        with pytest.raises(GenesisError, match="Invalid threshold"):
            create_genesis_cell_with_witness_set(
                graph_name="TestGraph",
                root_namespace="corp",
                witnesses=["alice"],
                threshold=2,  # Invalid: exceeds witness count
                system_time=T0
            )

    def test_invalid_namespace_raises(self):
        """Invalid namespace should raise GenesisError"""
        with pytest.raises(GenesisError, match="Invalid root namespace"):
            create_genesis_cell_with_witness_set(
                graph_name="TestGraph",
                root_namespace="INVALID",  # Uppercase not allowed
                witnesses=["alice"],
                threshold=1,
                system_time=T0
            )

    def test_default_witnesses_uses_creator(self):
        """Default witnesses should use creator if not provided"""
        genesis = create_genesis_cell_with_witness_set(
            graph_name="TestGraph",
            root_namespace="corp",
            creator="admin:alice",
            system_time=T0
        )

        ws = parse_genesis_witness_set(genesis)
        assert ws["witnesses"] == ["admin:alice"]
        assert ws["threshold"] == 1

    def test_bootstrap_mode_creation(self):
        """Bootstrap mode (1-of-1) should create valid Genesis"""
        genesis = create_genesis_cell_with_witness_set(
            graph_name="BootstrapGraph",
            root_namespace="dev",
            witnesses=["dev:admin"],
            threshold=1,
            bootstrap_mode=True,
            system_time=T0
        )

        ws = parse_genesis_witness_set(genesis)
        assert is_bootstrap_threshold(ws["threshold"], ws["witnesses"])

    def test_production_mode_creation(self):
        """Production mode (2-of-N) should create valid Genesis"""
        genesis = create_genesis_cell_with_witness_set(
            graph_name="ProdGraph",
            root_namespace="prod",
            witnesses=["witness:alice", "witness:bob", "witness:charlie"],
            threshold=2,
            bootstrap_mode=False,
            system_time=T0
        )

        ws = parse_genesis_witness_set(genesis)
        assert is_production_threshold(ws["threshold"], ws["witnesses"])


class TestParseGenesisWitnessSet:
    """Tests for parse_genesis_witness_set function"""

    def test_extracts_witness_set(self):
        """Should extract WitnessSet from Genesis"""
        genesis = create_genesis_cell_with_witness_set(
            graph_name="TestGraph",
            root_namespace="corp",
            witnesses=["alice", "bob"],
            threshold=2,
            system_time=T0
        )

        ws = parse_genesis_witness_set(genesis)

        assert ws is not None
        assert ws["namespace"] == "corp"
        assert ws["witnesses"] == ["alice", "bob"]
        assert ws["threshold"] == 2

    def test_returns_none_for_legacy_genesis(self):
        """Should return None for Genesis without WitnessSet"""
        # Create legacy Genesis (simple string object)
        genesis = create_genesis_cell(
            graph_name="LegacyGraph",
            root_namespace="corp",
            system_time=T0
        )

        ws = parse_genesis_witness_set(genesis)
        assert ws is None

    def test_raises_for_non_genesis(self):
        """Should raise ValueError for non-Genesis cell"""
        from decisiongraph.policyhead import create_policy_head

        chain = create_chain("Test", "corp", system_time=T0)
        policy_head = create_policy_head(
            namespace="corp.hr",
            promoted_rule_ids=["rule:test"],
            graph_id=chain.graph_id,
            prev_cell_hash=chain.head.cell_id,
            system_time=T1
        )

        with pytest.raises(ValueError, match="Expected GENESIS"):
            parse_genesis_witness_set(policy_head)


class TestHasWitnessSet:
    """Tests for has_witness_set function"""

    def test_true_for_genesis_with_witness_set(self):
        """Should return True for Genesis with WitnessSet"""
        genesis = create_genesis_cell_with_witness_set(
            graph_name="TestGraph",
            root_namespace="corp",
            witnesses=["alice"],
            threshold=1,
            system_time=T0
        )

        assert has_witness_set(genesis) is True

    def test_false_for_legacy_genesis(self):
        """Should return False for Genesis without WitnessSet"""
        genesis = create_genesis_cell(
            graph_name="LegacyGraph",
            root_namespace="corp",
            system_time=T0
        )

        assert has_witness_set(genesis) is False


class TestGenesisChainIntegration:
    """Tests for Genesis with WitnessSet in Chain"""

    def test_genesis_with_witness_set_appendable(self):
        """Genesis with WitnessSet should be appendable to empty Chain"""
        genesis = create_genesis_cell_with_witness_set(
            graph_name="TestGraph",
            root_namespace="corp",
            witnesses=["alice"],
            threshold=1,
            system_time=T0
        )

        chain = Chain()
        chain.append(genesis)

        assert chain.has_genesis()
        assert chain.genesis == genesis

    def test_chain_validation_passes(self):
        """Chain with Genesis WitnessSet should pass validation"""
        genesis = create_genesis_cell_with_witness_set(
            graph_name="TestGraph",
            root_namespace="corp",
            witnesses=["alice", "bob"],
            threshold=2,
            system_time=T0
        )

        chain = Chain()
        chain.append(genesis)

        result = chain.validate()
        assert result.is_valid is True


class TestBackwardCompatibility:
    """Tests to ensure backward compatibility with existing code"""

    def test_create_genesis_cell_still_works(self):
        """Original create_genesis_cell should still work"""
        genesis = create_genesis_cell(
            graph_name="LegacyGraph",
            root_namespace="corp",
            system_time=T0
        )

        assert genesis.header.cell_type == CellType.GENESIS
        assert genesis.verify_integrity()

    def test_chain_create_chain_still_works(self):
        """create_chain convenience function should still work"""
        chain = create_chain(
            graph_name="TestGraph",
            root_namespace="corp",
            system_time=T0
        )

        assert chain.has_genesis()
        # Legacy Genesis should not have WitnessSet
        assert has_witness_set(chain.genesis) is False

    def test_existing_tests_not_broken(self):
        """Verify basic operations still work"""
        chain = create_chain("Test", "corp", system_time=T0)

        # Basic chain operations
        assert chain.length == 1
        assert chain.graph_id is not None
        assert chain.root_namespace == "corp"
```

CRITICAL: Test all boundary conditions:
- threshold=0 (invalid)
- threshold=1 with 1 witness (valid, bootstrap)
- threshold=N with N witnesses (valid, unanimous)
- threshold=N+1 with N witnesses (invalid)
- empty witnesses list (invalid)
  </action>
  <verify>
Run: `cd /workspaces/Decisiongraph-core-v1.3/decisiongraph-complete && python -m pytest tests/test_bootstrap.py -v`
Expected: All tests pass (35+ tests).
  </verify>
  <done>
- tests/test_bootstrap.py exists with 35+ test cases
- Tests cover BOT-01 (Genesis WitnessSet), BOT-02 (bootstrap mode), BOT-03 (production mode)
- All boundary conditions tested (0, 1, N, N+1 thresholds)
- Backward compatibility verified (legacy Genesis still works)
- All new tests pass
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. All bootstrap tests pass:
   ```bash
   python -m pytest tests/test_bootstrap.py -v
   ```

2. Threshold validation works correctly:
   ```python
   from decisiongraph.policyhead import validate_threshold, is_bootstrap_threshold, is_production_threshold

   # Bootstrap mode
   assert validate_threshold(1, ["alice"]) == (True, "")
   assert is_bootstrap_threshold(1, ["alice"]) == True

   # Production mode
   assert validate_threshold(2, ["alice", "bob"]) == (True, "")
   assert is_production_threshold(2, ["alice", "bob"]) == True

   # Invalid
   assert validate_threshold(0, ["alice"])[0] == False
   assert validate_threshold(2, ["alice"])[0] == False
   ```

3. Genesis with WitnessSet works:
   ```python
   from decisiongraph.genesis import create_genesis_cell_with_witness_set, parse_genesis_witness_set

   genesis = create_genesis_cell_with_witness_set(
       graph_name="Test",
       root_namespace="corp",
       witnesses=["alice", "bob"],
       threshold=2
   )
   ws = parse_genesis_witness_set(genesis)
   print(f"WitnessSet: {ws['threshold']}-of-{len(ws['witnesses'])}")
   ```

4. All existing tests still pass:
   ```bash
   python -m pytest tests/ -v --tb=short
   ```
</verification>

<success_criteria>
- Genesis cell can include initial WitnessSet without circular dependency
- Bootstrap mode (1-of-1 threshold) allows single witness operation
- Production mode requires minimum 2-of-N threshold
- Threshold validation enforces 1 <= threshold <= len(witnesses)
- WitnessSet extractable via parse_genesis_witness_set()
- Backward compatible with legacy Genesis cells
- All tests pass (existing + new)
</success_criteria>

<output>
After completion, create `.planning/phases/01-policyhead-foundation/01-03-SUMMARY.md`
</output>
