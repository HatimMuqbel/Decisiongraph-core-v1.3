---
phase: 04-promotion-workflow
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/decisiongraph/engine.py
  - tests/test_engine_promotion.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can call engine.finalize_promotion(promotion_id) when THRESHOLD_MET"
    - "finalize_promotion creates PolicyHead cell and appends to chain"
    - "finalize_promotion returns cell_id of created PolicyHead"
    - "finalize_promotion updates status to FINALIZED"
    - "Finalization fails with DG_UNAUTHORIZED if threshold not met"
  artifacts:
    - path: "src/decisiongraph/engine.py"
      provides: "finalize_promotion() method on Engine class"
      contains: "def finalize_promotion"
    - path: "tests/test_engine_promotion.py"
      provides: "Integration tests for full promotion workflow including finalization"
      min_tests: 15
  key_links:
    - from: "src/decisiongraph/engine.py"
      to: "src/decisiongraph/policyhead.py"
      via: "create_policy_head(), get_current_policy_head()"
      pattern: "create_policy_head"
    - from: "src/decisiongraph/engine.py"
      to: "self.chain.append"
      via: "atomic PolicyHead append"
      pattern: "self\\.chain\\.append"
---

<objective>
Implement Engine.finalize_promotion() to complete the promotion workflow (PRO-04), creating PolicyHead cell when threshold is met.

Purpose: finalize_promotion() is the final step that atomically creates a PolicyHead cell and appends it to the chain, making the promoted rules the active policy. This completes the Submit -> Collect -> Finalize workflow.

Output: Engine.finalize_promotion() method, comprehensive end-to-end tests verifying full promotion workflow from submit through finalize.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-promotion-workflow/04-RESEARCH.md
@.planning/phases/04-promotion-workflow/04-01-SUMMARY.md
@.planning/phases/04-promotion-workflow/04-02-SUMMARY.md

# Implementation references
@src/decisiongraph/engine.py (Engine with submit/collect from Plan 02)
@src/decisiongraph/policyhead.py (create_policy_head, get_current_policy_head)
@tests/test_engine_promotion.py (existing tests from Plan 02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Engine.finalize_promotion()</name>
  <files>src/decisiongraph/engine.py</files>
  <action>
Add finalize_promotion() method to Engine class:

1. **Add import at top** (if not already present):
   ```python
   from .policyhead import create_policy_head, get_current_policy_head
   ```

2. **Add Engine.finalize_promotion() method**:
   ```python
   def finalize_promotion(self, promotion_id: str) -> str:
       """
       Finalize promotion and create PolicyHead cell (PRO-04).

       Creates a PolicyHead cell for the promoted rules and appends
       it to the chain. This is atomic - either the PolicyHead is
       created and appended, or an error is raised.

       Requires promotion status to be THRESHOLD_MET. After finalization,
       status is updated to FINALIZED.

       Args:
           promotion_id: ID of the promotion to finalize

       Returns:
           cell_id of the created PolicyHead

       Raises:
           InputInvalidError: If promotion_id not found
           UnauthorizedError: If threshold not met (status != THRESHOLD_MET)

       Example:
           >>> # After collecting enough signatures...
           >>> cell_id = engine.finalize_promotion(promotion_id)
           >>> # PolicyHead now on chain, rules are promoted
       """
       # Get promotion
       promotion = self._promotions.get(promotion_id)
       if not promotion:
           raise InputInvalidError(
               message=f"Promotion not found: {promotion_id}",
               details={"promotion_id": promotion_id}
           )

       # Check threshold is met
       if promotion.status != PromotionStatus.THRESHOLD_MET:
           raise UnauthorizedError(
               message=f"Cannot finalize: status is {promotion.status.value}, need THRESHOLD_MET",
               details={
                   "current_status": promotion.status.value,
                   "signatures_collected": len(promotion.signatures),
                   "threshold_required": promotion.required_threshold
               }
           )

       # Get previous PolicyHead for linking (may be None for first promotion)
       prev_policy_head = get_current_policy_head(self.chain, promotion.namespace)
       prev_policy_head_id = prev_policy_head.cell_id if prev_policy_head else None

       # Create PolicyHead cell
       policy_head = create_policy_head(
           namespace=promotion.namespace,
           promoted_rule_ids=list(promotion.rule_ids),
           graph_id=self.chain.graph_id,
           prev_cell_hash=self.chain.head.cell_id,
           prev_policy_head=prev_policy_head_id,
           system_time=get_current_timestamp(),
           creator=promotion.submitter_id,
           bootstrap_mode=True  # Signature enforcement is via WitnessSet, not cell-level
       )

       # Append to chain (atomic)
       self.chain.append(policy_head)

       # Update promotion status
       promotion.status = PromotionStatus.FINALIZED

       return policy_head.cell_id
   ```

IMPORTANT: prev_policy_head links the new PolicyHead to the previous one for this namespace.
IMPORTANT: Use list(promotion.rule_ids) to convert tuple back to list for create_policy_head.
  </action>
  <verify>
python -c "from decisiongraph import Engine; print(Engine.finalize_promotion.__doc__[:50])"
  </verify>
  <done>
Engine.finalize_promotion() creates PolicyHead and appends to chain when THRESHOLD_MET.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add finalization tests and end-to-end workflow tests</name>
  <files>tests/test_engine_promotion.py</files>
  <action>
Add new test class to tests/test_engine_promotion.py:

```python
from decisiongraph.policyhead import get_current_policy_head, parse_policy_data


class TestFinalizePromotion:
    """Tests for Engine.finalize_promotion() (PRO-04)"""

    def test_finalize_creates_policy_head(self):
        """finalize_promotion creates PolicyHead on chain."""
        chain = create_test_chain_with_witnesses(["alice"], 1)
        engine = Engine(chain)
        priv, pub = generate_ed25519_keypair()

        # Submit and collect
        promotion_id = engine.submit_promotion("corp", ["rule:a", "rule:b"], "alice")
        promotion = engine._promotions[promotion_id]
        sig = sign_bytes(priv, promotion.canonical_payload)
        engine.collect_witness_signature(promotion_id, "alice", sig, pub)

        # Finalize
        cell_id = engine.finalize_promotion(promotion_id)

        # Verify PolicyHead exists
        assert cell_id is not None
        policy_head = get_current_policy_head(chain, "corp")
        assert policy_head is not None
        assert policy_head.cell_id == cell_id

    def test_finalize_policy_head_has_correct_data(self):
        """PolicyHead contains correct promoted_rule_ids."""
        chain = create_test_chain_with_witnesses(["alice"], 1)
        engine = Engine(chain)
        priv, pub = generate_ed25519_keypair()

        promotion_id = engine.submit_promotion("corp", ["rule:b", "rule:a"], "alice")
        promotion = engine._promotions[promotion_id]
        sig = sign_bytes(priv, promotion.canonical_payload)
        engine.collect_witness_signature(promotion_id, "alice", sig, pub)
        engine.finalize_promotion(promotion_id)

        policy_head = get_current_policy_head(chain, "corp")
        policy_data = parse_policy_data(policy_head)
        # Rule IDs should be sorted
        assert policy_data["promoted_rule_ids"] == ["rule:a", "rule:b"]

    def test_finalize_updates_status_to_finalized(self):
        """Status updates to FINALIZED after finalization."""
        chain = create_test_chain_with_witnesses(["alice"], 1)
        engine = Engine(chain)
        priv, pub = generate_ed25519_keypair()

        promotion_id = engine.submit_promotion("corp", ["rule:a"], "alice")
        promotion = engine._promotions[promotion_id]
        sig = sign_bytes(priv, promotion.canonical_payload)
        engine.collect_witness_signature(promotion_id, "alice", sig, pub)
        engine.finalize_promotion(promotion_id)

        assert promotion.status == PromotionStatus.FINALIZED

    def test_finalize_requires_threshold_met(self):
        """Finalization fails if threshold not met (INT-04)."""
        chain = create_test_chain_with_witnesses(["alice", "bob"], 2)
        engine = Engine(chain)
        priv, pub = generate_ed25519_keypair()

        promotion_id = engine.submit_promotion("corp", ["rule:a"], "alice")
        promotion = engine._promotions[promotion_id]
        # Only one signature, need two
        sig = sign_bytes(priv, promotion.canonical_payload)
        engine.collect_witness_signature(promotion_id, "alice", sig, pub)

        with pytest.raises(UnauthorizedError) as exc_info:
            engine.finalize_promotion(promotion_id)
        assert "THRESHOLD_MET" in exc_info.value.message
        assert exc_info.value.code == "DG_UNAUTHORIZED"

    def test_finalize_promotion_not_found(self):
        """Unknown promotion_id raises InputInvalidError."""
        chain = create_test_chain_with_witnesses(["alice"], 1)
        engine = Engine(chain)

        with pytest.raises(InputInvalidError) as exc_info:
            engine.finalize_promotion("nonexistent-id")
        assert "not found" in exc_info.value.message


class TestEndToEndPromotionWorkflow:
    """End-to-end tests for complete promotion workflow (PRO-01 through PRO-06)"""

    def test_full_workflow_single_witness(self):
        """Complete workflow: submit -> collect -> finalize (1-of-1)."""
        chain = create_test_chain_with_witnesses(["alice"], 1)
        engine = Engine(chain)
        priv, pub = generate_ed25519_keypair()

        # PRO-01: Submit
        promotion_id = engine.submit_promotion(
            namespace="corp",
            rule_ids=["rule:salary_v2"],
            submitter_id="admin"
        )
        assert promotion_id is not None

        # PRO-02 + PRO-03: Collect (PENDING -> THRESHOLD_MET)
        promotion = engine._promotions[promotion_id]
        assert promotion.status == PromotionStatus.PENDING

        sig = sign_bytes(priv, promotion.canonical_payload)
        status = engine.collect_witness_signature(promotion_id, "alice", sig, pub)
        assert status == PromotionStatus.THRESHOLD_MET  # 1-of-1

        # PRO-04: Finalize
        cell_id = engine.finalize_promotion(promotion_id)
        assert cell_id is not None
        assert promotion.status == PromotionStatus.FINALIZED

        # Verify on chain
        policy_head = get_current_policy_head(chain, "corp")
        assert policy_head.cell_id == cell_id

    def test_full_workflow_multi_witness(self):
        """Complete workflow with 2-of-3 threshold."""
        chain = create_test_chain_with_witnesses(["alice", "bob", "charlie"], 2)
        engine = Engine(chain)
        alice_priv, alice_pub = generate_ed25519_keypair()
        bob_priv, bob_pub = generate_ed25519_keypair()

        # Submit
        promotion_id = engine.submit_promotion(
            namespace="corp",
            rule_ids=["rule:a", "rule:b"],
            submitter_id="admin"
        )
        promotion = engine._promotions[promotion_id]

        # First signature: PENDING -> COLLECTING
        sig1 = sign_bytes(alice_priv, promotion.canonical_payload)
        status1 = engine.collect_witness_signature(promotion_id, "alice", sig1, alice_pub)
        assert status1 == PromotionStatus.COLLECTING

        # Second signature: COLLECTING -> THRESHOLD_MET
        sig2 = sign_bytes(bob_priv, promotion.canonical_payload)
        status2 = engine.collect_witness_signature(promotion_id, "bob", sig2, bob_pub)
        assert status2 == PromotionStatus.THRESHOLD_MET

        # Finalize
        cell_id = engine.finalize_promotion(promotion_id)
        assert promotion.status == PromotionStatus.FINALIZED

        # Verify rules in PolicyHead
        policy_head = get_current_policy_head(chain, "corp")
        policy_data = parse_policy_data(policy_head)
        assert policy_data["promoted_rule_ids"] == ["rule:a", "rule:b"]

    def test_multiple_promotions_chain_correctly(self):
        """Multiple promotions create linked PolicyHead chain."""
        chain = create_test_chain_with_witnesses(["alice"], 1)
        engine = Engine(chain)
        priv, pub = generate_ed25519_keypair()

        # First promotion
        pid1 = engine.submit_promotion("corp", ["rule:v1"], "admin")
        pr1 = engine._promotions[pid1]
        sig1 = sign_bytes(priv, pr1.canonical_payload)
        engine.collect_witness_signature(pid1, "alice", sig1, pub)
        cell_id1 = engine.finalize_promotion(pid1)

        # Second promotion
        pid2 = engine.submit_promotion("corp", ["rule:v1", "rule:v2"], "admin")
        pr2 = engine._promotions[pid2]
        sig2 = sign_bytes(priv, pr2.canonical_payload)
        engine.collect_witness_signature(pid2, "alice", sig2, pub)
        cell_id2 = engine.finalize_promotion(pid2)

        # Verify chain linkage
        policy_head = get_current_policy_head(chain, "corp")
        assert policy_head.cell_id == cell_id2
        policy_data = parse_policy_data(policy_head)
        assert policy_data["prev_policy_head"] == cell_id1
```

Add import at top of test file:
```python
from decisiongraph.policyhead import get_current_policy_head, parse_policy_data
```
  </action>
  <verify>
cd /workspaces/Decisiongraph-core-v1.3/decisiongraph-complete && python -m pytest tests/test_engine_promotion.py -v
  </verify>
  <done>
All tests pass including finalization and end-to-end workflow tests (15+ total).
  </done>
</task>

</tasks>

<verification>
```bash
# Run all engine promotion tests
cd /workspaces/Decisiongraph-core-v1.3/decisiongraph-complete && python -m pytest tests/test_engine_promotion.py -v

# Test full workflow manually
python -c "
from decisiongraph import Engine, create_chain, PromotionStatus
from decisiongraph.genesis import create_genesis_cell_with_witness_set
from decisiongraph.signing import generate_ed25519_keypair, sign_bytes
from decisiongraph.policyhead import get_current_policy_head, parse_policy_data

chain = create_chain()
genesis = create_genesis_cell_with_witness_set('G', 'corp', ['alice'], 1)
chain.append(genesis)
engine = Engine(chain)
priv, pub = generate_ed25519_keypair()

# Full workflow
pid = engine.submit_promotion('corp', ['rule:a'], 'admin')
pr = engine._promotions[pid]
sig = sign_bytes(priv, pr.canonical_payload)
engine.collect_witness_signature(pid, 'alice', sig, pub)
cell_id = engine.finalize_promotion(pid)
print(f'PolicyHead created: {cell_id[:16]}...')

ph = get_current_policy_head(chain, 'corp')
print(f'Rules: {parse_policy_data(ph)[\"promoted_rule_ids\"]}')
"

# Run ALL tests (existing 682 + new ~15 promotion tests)
cd /workspaces/Decisiongraph-core-v1.3/decisiongraph-complete && python -m pytest --tb=short -q
```
</verification>

<success_criteria>
1. Engine.finalize_promotion() creates PolicyHead when THRESHOLD_MET
2. finalize_promotion() returns cell_id of created PolicyHead
3. Finalization fails with DG_UNAUTHORIZED if threshold not met
4. PolicyHead links to previous PolicyHead via prev_policy_head
5. Full workflow works: submit -> collect signatures -> finalize
6. All new tests pass (15+ total in test_engine_promotion.py)
7. All existing tests still pass (682+)
8. Requirements PRO-01 through PRO-06 complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-promotion-workflow/04-03-SUMMARY.md`
</output>
