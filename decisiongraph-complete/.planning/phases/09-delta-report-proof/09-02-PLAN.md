---
phase: 09-delta-report-proof
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/decisiongraph/engine.py
  - tests/test_simulation.py
autonomous: true

must_haves:
  truths:
    - "Engine.simulate_rfa() returns SimulationResult with delta_report field populated"
    - "Engine.simulate_rfa() returns SimulationResult with proof_bundle containing tagged base/shadow and attestation"
    - "Proof bundle nodes tagged with origin ('BASE' or 'SHADOW')"
    - "Proof bundle includes no_contamination_attestation with chain head before/after"
    - "Same RFA + same simulation_spec always produces identical SimulationResult (deterministic)"
    - "anchors field is empty dict (populated in Phase 10)"
  artifacts:
    - path: "src/decisiongraph/engine.py"
      provides: "Updated simulate_rfa() with delta computation and proof bundling"
      contains: "compute_delta_report"
    - path: "tests/test_simulation.py"
      provides: "Phase 9 requirement tests"
      min_lines: 700
  key_links:
    - from: "src/decisiongraph/engine.py"
      to: "simulation.compute_delta_report"
      via: "import and call"
      pattern: "compute_delta_report"
    - from: "src/decisiongraph/engine.py"
      to: "simulation.tag_proof_bundle_origin"
      via: "import and call"
      pattern: "tag_proof_bundle_origin"
    - from: "src/decisiongraph/engine.py"
      to: "simulation.create_contamination_attestation"
      via: "import and call"
      pattern: "create_contamination_attestation"
---

<objective>
Integrate DeltaReport and proof bundling into Engine.simulate_rfa() with comprehensive tests.

Purpose: Complete Phase 9 by connecting the dataclasses and helpers (from 09-01) to the simulation engine. This satisfies all Phase 9 requirements: SIM-04, SIM-05, SIM-06, SHD-03, SHD-06.

Output: Updated Engine.simulate_rfa() that returns fully-populated SimulationResult with delta_report, proof_bundle, and contamination attestation. Comprehensive tests covering all Phase 9 requirements.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-delta-report-proof/09-RESEARCH.md
@.planning/phases/09-delta-report-proof/09-01-SUMMARY.md

# Key source files
@src/decisiongraph/engine.py
@src/decisiongraph/simulation.py
@tests/test_simulation.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Engine.simulate_rfa() to compute delta and build proof bundle</name>
  <files>src/decisiongraph/engine.py</files>
  <action>
Modify Engine.simulate_rfa() to integrate Phase 9 functionality:

1. Add imports at top of engine.py (extend existing simulation import):
   ```python
   from .simulation import (
       SimulationContext,
       SimulationResult,
       DeltaReport,
       ContaminationAttestation,
       compute_delta_report,
       tag_proof_bundle_origin,
       create_contamination_attestation
   )
   ```

2. Modify simulate_rfa() method to:
   a. Capture chain head BEFORE simulation (for SHD-06 attestation)
   b. After shadow query, capture chain head AFTER simulation
   c. Compute delta_report using compute_delta_report()
   d. Tag proof bundles with origin using tag_proof_bundle_origin()
   e. Create contamination attestation using create_contamination_attestation()
   f. Assemble proof_bundle dict
   g. Return SimulationResult with all Phase 9 fields

Updated simulate_rfa() structure (inside the try block):
```python
def simulate_rfa(
    self,
    rfa_dict: dict,
    simulation_spec: dict,
    at_valid_time: str,
    as_of_system_time: str
) -> SimulationResult:
    """
    Simulate an RFA against shadow reality (SIM-01 through SIM-06, SHD-03, SHD-05, SHD-06).

    Phase 8: Creates isolated simulation, returns base/shadow results.
    Phase 9 additions:
    - delta_report: Structured comparison of base vs shadow (SIM-04)
    - proof_bundle: Tagged bundles with contamination attestation (SIM-05, SHD-06)
    - anchors: Empty dict placeholder (populated in Phase 10)
    - Deterministic outputs (SIM-06)

    [existing docstring continues...]
    """
    try:
        # Step 1: Capture chain head BEFORE simulation (SHD-06)
        chain_head_before = self.chain.head.cell_id

        # Step 2: Canonicalize RFA (reuse existing method)
        canonical_rfa = self._canonicalize_rfa(rfa_dict)

        # Step 3: Validate RFA schema and fields (reuse existing)
        self._validate_rfa_schema(canonical_rfa)
        self._validate_rfa_fields(canonical_rfa)

        # Step 4: Query base reality at frozen coordinates (SIM-02, SHD-05)
        base_query_result = self.scholar.query_facts(
            requester_namespace=canonical_rfa['requester_namespace'],
            namespace=canonical_rfa['namespace'],
            subject=canonical_rfa.get('subject'),
            predicate=canonical_rfa.get('predicate'),
            object_value=canonical_rfa.get('object'),
            at_valid_time=at_valid_time,
            as_of_system_time=as_of_system_time,
            requester_id=canonical_rfa['requester_id']
        )
        base_result = base_query_result.to_proof_bundle()

        # Step 5: Build OverlayContext from simulation_spec
        overlay_ctx = self._build_overlay_context(simulation_spec)

        # Step 6: Run shadow query in context manager (SIM-03, cleanup guaranteed)
        with SimulationContext(
            self.chain, overlay_ctx, at_valid_time, as_of_system_time
        ) as sim_ctx:
            shadow_query_result = sim_ctx.shadow_scholar.query_facts(
                requester_namespace=canonical_rfa['requester_namespace'],
                namespace=canonical_rfa['namespace'],
                subject=canonical_rfa.get('subject'),
                predicate=canonical_rfa.get('predicate'),
                object_value=canonical_rfa.get('object'),
                at_valid_time=at_valid_time,
                as_of_system_time=as_of_system_time,
                requester_id=canonical_rfa['requester_id']
            )
            shadow_result = shadow_query_result.to_proof_bundle()
        # Context manager __exit__ called here - shadow_chain discarded

        # Step 7: Capture chain head AFTER simulation (SHD-06)
        chain_head_after = self.chain.head.cell_id

        # Step 8: Generate simulation_id for this run
        simulation_id = str(uuid4())

        # Step 9: Compute delta report (SIM-04, SIM-06)
        delta_report = compute_delta_report(base_result, shadow_result)

        # Step 10: Tag proof bundles with origin (SIM-05)
        tagged_base = tag_proof_bundle_origin(base_result, "BASE")
        tagged_shadow = tag_proof_bundle_origin(shadow_result, "SHADOW")

        # Step 11: Create contamination attestation (SHD-06)
        attestation = create_contamination_attestation(
            chain_head_before, chain_head_after, simulation_id
        )

        # Step 12: Assemble proof_bundle (SIM-05, SHD-06)
        proof_bundle = {
            "base": tagged_base,
            "shadow": tagged_shadow,
            "contamination_attestation": {
                "chain_head_before": attestation.chain_head_before,
                "chain_head_after": attestation.chain_head_after,
                "attestation_hash": attestation.attestation_hash,
                "contamination_detected": attestation.contamination_detected
            }
        }

        # Step 13: Create immutable SimulationResult (SHD-03)
        return SimulationResult(
            simulation_id=simulation_id,
            rfa_dict=canonical_rfa,
            simulation_spec=simulation_spec,
            base_result=base_result,
            shadow_result=shadow_result,
            at_valid_time=at_valid_time,
            as_of_system_time=as_of_system_time,
            delta_report=delta_report,
            anchors={},  # Empty until Phase 10 (CTF-03)
            proof_bundle=proof_bundle
        )

    except DecisionGraphError:
        raise
    except (ValueError, TypeError, KeyError) as e:
        raise wrap_internal_exception(
            e, details={"operation": "simulate_rfa"}
        ) from e
    except Exception as e:
        raise wrap_internal_exception(
            e, details={"operation": "simulate_rfa"}
        ) from e
```

IMPORTANT:
- Chain head capture BEFORE any simulation work
- Chain head capture AFTER context manager exits
- simulation_id generated ONCE and used for attestation AND result
- proof_bundle contains both tagged bundles AND attestation
- anchors is empty dict (Phase 10)
  </action>
  <verify>
Run quick smoke test:
```python
python -c "
from decisiongraph import Chain
from decisiongraph.genesis import create_genesis_cell
from decisiongraph.engine import Engine

# Create minimal chain
chain = Chain('test-graph')
genesis = create_genesis_cell('test-graph', bootstrap_mode=True)
chain.append(genesis)

# Create engine and run simulation
engine = Engine(chain)
result = engine.simulate_rfa(
    rfa_dict={'namespace': 'test', 'requester_namespace': 'test', 'requester_id': 'tester'},
    simulation_spec={},
    at_valid_time='2025-01-01T00:00:00Z',
    as_of_system_time='2025-01-01T00:00:00Z'
)

# Verify Phase 9 fields
assert result.delta_report is not None, 'delta_report missing'
assert result.proof_bundle is not None, 'proof_bundle missing'
assert 'base' in result.proof_bundle, 'base missing from proof_bundle'
assert 'shadow' in result.proof_bundle, 'shadow missing from proof_bundle'
assert 'contamination_attestation' in result.proof_bundle, 'attestation missing'
assert result.anchors == {}, 'anchors should be empty dict'
print('Engine.simulate_rfa() Phase 9 integration: PASS')
"
```
  </verify>
  <done>Engine.simulate_rfa() computes delta_report, tags proof bundles, creates contamination attestation, and returns fully-populated SimulationResult.</done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive Phase 9 tests</name>
  <files>tests/test_simulation.py</files>
  <action>
Add new test classes to tests/test_simulation.py for Phase 9 requirements:

1. Add imports at top (if not present):
   ```python
   from decisiongraph.simulation import (
       SimulationContext,
       SimulationResult,
       DeltaReport,
       ContaminationAttestation,
       compute_delta_report,
       tag_proof_bundle_origin,
       create_contamination_attestation
   )
   ```

2. Add test classes after existing tests:

```python
# ============================================================================
# PHASE 9 TESTS - Delta Report and Proof
# ============================================================================

class TestDeltaReportDataclass:
    """Tests for DeltaReport frozen dataclass (SIM-04)."""

    def test_delta_report_is_frozen(self):
        """DeltaReport should be immutable (frozen dataclass)."""
        delta = DeltaReport(
            verdict_changed=True,
            status_before="ALLOWED",
            status_after="DENIED",
            score_delta=0.0,
            facts_diff={"added": [], "removed": ["x"]},
            rules_diff={"added": [], "removed": []}
        )
        with pytest.raises(Exception):  # FrozenInstanceError
            delta.verdict_changed = False

    def test_delta_report_has_all_required_fields(self):
        """DeltaReport should have all SIM-04 required fields."""
        delta = DeltaReport(
            verdict_changed=False,
            status_before="DENIED",
            status_after="ALLOWED",
            score_delta=0.5,
            facts_diff={"added": ["a"], "removed": []},
            rules_diff={"added": [], "removed": ["r1"]}
        )
        assert hasattr(delta, 'verdict_changed')
        assert hasattr(delta, 'status_before')
        assert hasattr(delta, 'status_after')
        assert hasattr(delta, 'score_delta')
        assert hasattr(delta, 'facts_diff')
        assert hasattr(delta, 'rules_diff')


class TestContaminationAttestationDataclass:
    """Tests for ContaminationAttestation frozen dataclass (SHD-06)."""

    def test_attestation_is_frozen(self):
        """ContaminationAttestation should be immutable."""
        att = ContaminationAttestation(
            chain_head_before="abc",
            chain_head_after="abc",
            attestation_hash="hash123",
            contamination_detected=False
        )
        with pytest.raises(Exception):
            att.contamination_detected = True

    def test_attestation_has_all_required_fields(self):
        """ContaminationAttestation should have all SHD-06 required fields."""
        att = ContaminationAttestation(
            chain_head_before="before",
            chain_head_after="after",
            attestation_hash="hash",
            contamination_detected=True
        )
        assert hasattr(att, 'chain_head_before')
        assert hasattr(att, 'chain_head_after')
        assert hasattr(att, 'attestation_hash')
        assert hasattr(att, 'contamination_detected')


class TestComputeDeltaReport:
    """Tests for compute_delta_report() function (SIM-04, SIM-06)."""

    def test_verdict_changed_when_fact_count_differs(self):
        """verdict_changed should be True when fact counts differ."""
        base = {"results": {"fact_cell_ids": ["a", "b"], "fact_count": 2},
                "authorization_basis": {"allowed": True}}
        shadow = {"results": {"fact_cell_ids": ["a", "b", "c"], "fact_count": 3},
                  "authorization_basis": {"allowed": True}}
        delta = compute_delta_report(base, shadow)
        assert delta.verdict_changed is True

    def test_verdict_unchanged_when_fact_count_same(self):
        """verdict_changed should be False when fact counts equal."""
        base = {"results": {"fact_cell_ids": ["a", "b"], "fact_count": 2},
                "authorization_basis": {"allowed": True}}
        shadow = {"results": {"fact_cell_ids": ["a", "c"], "fact_count": 2},
                  "authorization_basis": {"allowed": True}}
        delta = compute_delta_report(base, shadow)
        assert delta.verdict_changed is False

    def test_status_before_after_extracted(self):
        """status_before/after should reflect authorization.allowed."""
        base = {"results": {"fact_cell_ids": [], "fact_count": 0},
                "authorization_basis": {"allowed": True}}
        shadow = {"results": {"fact_cell_ids": [], "fact_count": 0},
                  "authorization_basis": {"allowed": False}}
        delta = compute_delta_report(base, shadow)
        assert delta.status_before == "ALLOWED"
        assert delta.status_after == "DENIED"

    def test_facts_diff_computed_correctly(self):
        """facts_diff should show added and removed fact cell IDs."""
        base = {"results": {"fact_cell_ids": ["a", "b", "c"], "fact_count": 3},
                "authorization_basis": {"allowed": True}}
        shadow = {"results": {"fact_cell_ids": ["b", "d", "e"], "fact_count": 3},
                  "authorization_basis": {"allowed": True}}
        delta = compute_delta_report(base, shadow)
        assert sorted(delta.facts_diff["added"]) == ["d", "e"]
        assert sorted(delta.facts_diff["removed"]) == ["a", "c"]

    def test_deterministic_output_same_inputs(self):
        """Same inputs should always produce identical DeltaReport (SIM-06)."""
        base = {"results": {"fact_cell_ids": ["z", "a", "m"], "fact_count": 3},
                "authorization_basis": {"allowed": True}}
        shadow = {"results": {"fact_cell_ids": ["a", "x", "b"], "fact_count": 3},
                  "authorization_basis": {"allowed": False}}
        delta1 = compute_delta_report(base, shadow)
        delta2 = compute_delta_report(base, shadow)
        assert delta1 == delta2
        # Verify sorted output
        assert delta1.facts_diff["added"] == ["b", "x"]
        assert delta1.facts_diff["removed"] == ["m", "z"]

    def test_handles_empty_results(self):
        """Should handle empty or missing results gracefully."""
        base = {"results": {}, "authorization_basis": {"allowed": False}}
        shadow = {"results": {"fact_cell_ids": ["a"], "fact_count": 1},
                  "authorization_basis": {"allowed": True}}
        delta = compute_delta_report(base, shadow)
        assert delta.verdict_changed is True
        assert delta.facts_diff["added"] == ["a"]
        assert delta.facts_diff["removed"] == []


class TestTagProofBundleOrigin:
    """Tests for tag_proof_bundle_origin() function (SIM-05)."""

    def test_adds_origin_to_top_level(self):
        """Should add origin field to top level of proof bundle."""
        bundle = {"results": {"fact_cell_ids": ["x"]}}
        tagged = tag_proof_bundle_origin(bundle, "BASE")
        assert tagged["origin"] == "BASE"

    def test_does_not_mutate_original(self):
        """Original bundle should remain unchanged."""
        bundle = {"results": {"fact_cell_ids": ["x"]}, "proof": {"candidate_cell_ids": ["y"]}}
        original_str = str(bundle)
        tagged = tag_proof_bundle_origin(bundle, "SHADOW")
        assert str(bundle) == original_str
        assert "origin" not in bundle

    def test_tags_fact_cell_ids_with_origin(self):
        """Should add fact_cell_ids_with_origin list."""
        bundle = {"results": {"fact_cell_ids": ["a", "b"]}}
        tagged = tag_proof_bundle_origin(bundle, "BASE")
        assert "fact_cell_ids_with_origin" in tagged["results"]
        assert tagged["results"]["fact_cell_ids_with_origin"] == [
            {"cell_id": "a", "origin": "BASE"},
            {"cell_id": "b", "origin": "BASE"}
        ]

    def test_tags_candidate_cell_ids(self):
        """Should add candidate_cell_ids_with_origin list."""
        bundle = {"proof": {"candidate_cell_ids": ["c1", "c2"]}}
        tagged = tag_proof_bundle_origin(bundle, "SHADOW")
        assert "candidate_cell_ids_with_origin" in tagged["proof"]
        assert tagged["proof"]["candidate_cell_ids_with_origin"][0]["origin"] == "SHADOW"

    def test_tags_bridges_used(self):
        """Should add bridges_used_with_origin list."""
        bundle = {"proof": {"bridges_used": ["br1"]}}
        tagged = tag_proof_bundle_origin(bundle, "BASE")
        assert "bridges_used_with_origin" in tagged["proof"]
        assert tagged["proof"]["bridges_used_with_origin"][0] == {"cell_id": "br1", "origin": "BASE"}


class TestCreateContaminationAttestation:
    """Tests for create_contamination_attestation() function (SHD-06)."""

    def test_no_contamination_when_heads_match(self):
        """contamination_detected should be False when heads match."""
        att = create_contamination_attestation("head1", "head1", "sim-123")
        assert att.contamination_detected is False

    def test_contamination_detected_when_heads_differ(self):
        """contamination_detected should be True when heads differ."""
        att = create_contamination_attestation("head1", "head2", "sim-123")
        assert att.contamination_detected is True

    def test_attestation_hash_is_sha256(self):
        """attestation_hash should be 64 hex characters (SHA-256)."""
        att = create_contamination_attestation("before", "after", "sim-id")
        assert len(att.attestation_hash) == 64
        # Verify it's hex
        int(att.attestation_hash, 16)

    def test_deterministic_hash_same_inputs(self):
        """Same inputs should produce same attestation_hash."""
        att1 = create_contamination_attestation("h1", "h2", "sim-x")
        att2 = create_contamination_attestation("h1", "h2", "sim-x")
        assert att1.attestation_hash == att2.attestation_hash

    def test_different_simulation_id_different_hash(self):
        """Different simulation_id should produce different hash."""
        att1 = create_contamination_attestation("h1", "h1", "sim-1")
        att2 = create_contamination_attestation("h1", "h1", "sim-2")
        assert att1.attestation_hash != att2.attestation_hash


class TestSimulationResultPhase9Fields:
    """Tests for SimulationResult Phase 9 fields (SHD-03)."""

    def test_simulation_result_has_delta_report(self):
        """SimulationResult should have delta_report field."""
        delta = DeltaReport(
            verdict_changed=False,
            status_before="ALLOWED",
            status_after="ALLOWED",
            score_delta=0.0,
            facts_diff={"added": [], "removed": []},
            rules_diff={"added": [], "removed": []}
        )
        result = SimulationResult(
            simulation_id="test",
            rfa_dict={},
            simulation_spec={},
            base_result={},
            shadow_result={},
            at_valid_time="2025-01-01T00:00:00Z",
            as_of_system_time="2025-01-01T00:00:00Z",
            delta_report=delta
        )
        assert result.delta_report is not None
        assert result.delta_report.verdict_changed is False

    def test_simulation_result_has_anchors(self):
        """SimulationResult should have anchors field (empty dict for Phase 9)."""
        result = SimulationResult(
            simulation_id="test",
            rfa_dict={},
            simulation_spec={},
            base_result={},
            shadow_result={},
            at_valid_time="2025-01-01T00:00:00Z",
            as_of_system_time="2025-01-01T00:00:00Z",
            anchors={}
        )
        assert result.anchors == {}

    def test_simulation_result_has_proof_bundle(self):
        """SimulationResult should have proof_bundle field."""
        result = SimulationResult(
            simulation_id="test",
            rfa_dict={},
            simulation_spec={},
            base_result={},
            shadow_result={},
            at_valid_time="2025-01-01T00:00:00Z",
            as_of_system_time="2025-01-01T00:00:00Z",
            proof_bundle={"base": {}, "shadow": {}}
        )
        assert "base" in result.proof_bundle
        assert "shadow" in result.proof_bundle

    def test_to_dict_includes_delta_report(self):
        """to_dict() should include delta_report when present."""
        delta = DeltaReport(
            verdict_changed=True,
            status_before="ALLOWED",
            status_after="DENIED",
            score_delta=1.5,
            facts_diff={"added": ["x"], "removed": []},
            rules_diff={"added": [], "removed": []}
        )
        result = SimulationResult(
            simulation_id="test",
            rfa_dict={},
            simulation_spec={},
            base_result={},
            shadow_result={},
            at_valid_time="t1",
            as_of_system_time="t2",
            delta_report=delta
        )
        d = result.to_dict()
        assert "delta_report" in d
        assert d["delta_report"]["verdict_changed"] is True
        assert d["delta_report"]["status_after"] == "DENIED"

    def test_backward_compatibility_delta_report_none(self):
        """SimulationResult should work without delta_report (backward compat)."""
        result = SimulationResult(
            simulation_id="test",
            rfa_dict={},
            simulation_spec={},
            base_result={},
            shadow_result={},
            at_valid_time="t1",
            as_of_system_time="t2"
        )
        assert result.delta_report is None
        assert result.anchors == {}


class TestEngineSimulateRfaPhase9:
    """Tests for Engine.simulate_rfa() Phase 9 integration."""

    @pytest.fixture
    def engine_with_facts(self):
        """Create Engine with test facts for simulation."""
        from decisiongraph import Chain
        from decisiongraph.genesis import create_genesis_cell
        from decisiongraph.cell import DecisionCell, Header, Fact, CellType, SourceQuality

        chain = Chain("test-graph")
        genesis = create_genesis_cell("test-graph", bootstrap_mode=True)
        chain.append(genesis)

        # Add a fact cell
        now = "2025-01-15T00:00:00Z"
        fact_cell = DecisionCell(
            header=Header(
                version=1,
                graph_id="test-graph",
                cell_type=CellType.FACT,
                prev_cell_hash=genesis.cell_id,
                creator="test",
                system_time=now,
                signature=None,
                bootstrap_mode=True
            ),
            fact=Fact(
                namespace="test.ns",
                subject="user:alice",
                predicate="has_role",
                object="admin",
                confidence=1.0,
                source_quality=SourceQuality.VERIFIED,
                valid_from=now,
                valid_to=None
            )
        )
        chain.append(fact_cell)

        return Engine(chain), fact_cell.cell_id

    def test_simulate_rfa_returns_delta_report(self, engine_with_facts):
        """simulate_rfa() should return SimulationResult with delta_report."""
        engine, _ = engine_with_facts
        result = engine.simulate_rfa(
            rfa_dict={"namespace": "test.ns", "requester_namespace": "test.ns",
                      "requester_id": "tester"},
            simulation_spec={},
            at_valid_time="2025-01-15T00:00:00Z",
            as_of_system_time="2025-01-15T00:00:00Z"
        )
        assert result.delta_report is not None
        assert isinstance(result.delta_report, DeltaReport)

    def test_simulate_rfa_returns_proof_bundle_with_tagged_bundles(self, engine_with_facts):
        """simulate_rfa() should return proof_bundle with BASE and SHADOW tags."""
        engine, _ = engine_with_facts
        result = engine.simulate_rfa(
            rfa_dict={"namespace": "test.ns", "requester_namespace": "test.ns",
                      "requester_id": "tester"},
            simulation_spec={},
            at_valid_time="2025-01-15T00:00:00Z",
            as_of_system_time="2025-01-15T00:00:00Z"
        )
        assert "base" in result.proof_bundle
        assert "shadow" in result.proof_bundle
        assert result.proof_bundle["base"]["origin"] == "BASE"
        assert result.proof_bundle["shadow"]["origin"] == "SHADOW"

    def test_simulate_rfa_returns_contamination_attestation(self, engine_with_facts):
        """simulate_rfa() should include contamination_attestation in proof_bundle."""
        engine, _ = engine_with_facts
        result = engine.simulate_rfa(
            rfa_dict={"namespace": "test.ns", "requester_namespace": "test.ns",
                      "requester_id": "tester"},
            simulation_spec={},
            at_valid_time="2025-01-15T00:00:00Z",
            as_of_system_time="2025-01-15T00:00:00Z"
        )
        assert "contamination_attestation" in result.proof_bundle
        att = result.proof_bundle["contamination_attestation"]
        assert "chain_head_before" in att
        assert "chain_head_after" in att
        assert "attestation_hash" in att
        assert att["contamination_detected"] is False

    def test_simulate_rfa_anchors_is_empty_dict(self, engine_with_facts):
        """simulate_rfa() should return anchors as empty dict (Phase 10)."""
        engine, _ = engine_with_facts
        result = engine.simulate_rfa(
            rfa_dict={"namespace": "test.ns", "requester_namespace": "test.ns",
                      "requester_id": "tester"},
            simulation_spec={},
            at_valid_time="2025-01-15T00:00:00Z",
            as_of_system_time="2025-01-15T00:00:00Z"
        )
        assert result.anchors == {}

    def test_simulate_rfa_deterministic_output(self, engine_with_facts):
        """Same inputs should produce identical results (SIM-06)."""
        engine, _ = engine_with_facts
        rfa = {"namespace": "test.ns", "requester_namespace": "test.ns",
               "requester_id": "tester"}
        spec = {}
        vtime = "2025-01-15T00:00:00Z"
        stime = "2025-01-15T00:00:00Z"

        result1 = engine.simulate_rfa(rfa, spec, vtime, stime)
        result2 = engine.simulate_rfa(rfa, spec, vtime, stime)

        # Delta reports should be identical
        assert result1.delta_report == result2.delta_report
        # Base/shadow results should be identical
        assert result1.base_result == result2.base_result
        assert result1.shadow_result == result2.shadow_result

    def test_simulate_rfa_with_shadow_fact_changes_delta(self, engine_with_facts):
        """Shadow fact modification should be reflected in delta_report."""
        engine, fact_cell_id = engine_with_facts
        result = engine.simulate_rfa(
            rfa_dict={"namespace": "test.ns", "requester_namespace": "test.ns",
                      "requester_id": "tester", "subject": "user:alice"},
            simulation_spec={
                "shadow_facts": [{"base_cell_id": fact_cell_id, "object": "superadmin"}]
            },
            at_valid_time="2025-01-15T00:00:00Z",
            as_of_system_time="2025-01-15T00:00:00Z"
        )
        # Shadow has different cell_id due to modified object
        # So delta should show differences
        delta = result.delta_report
        assert delta is not None
        # Either added or removed should be non-empty (shadow cell has new ID)
        total_changes = len(delta.facts_diff["added"]) + len(delta.facts_diff["removed"])
        assert total_changes > 0, "Shadow modification should produce delta"

    def test_no_contamination_after_simulation(self, engine_with_facts):
        """Base chain should be unchanged after simulation (SHD-06)."""
        engine, fact_cell_id = engine_with_facts
        chain_head_before = engine.chain.head.cell_id
        chain_length_before = engine.chain.length

        result = engine.simulate_rfa(
            rfa_dict={"namespace": "test.ns", "requester_namespace": "test.ns",
                      "requester_id": "tester"},
            simulation_spec={
                "shadow_facts": [{"base_cell_id": fact_cell_id, "object": "modified"}]
            },
            at_valid_time="2025-01-15T00:00:00Z",
            as_of_system_time="2025-01-15T00:00:00Z"
        )

        # Chain unchanged
        assert engine.chain.head.cell_id == chain_head_before
        assert engine.chain.length == chain_length_before

        # Attestation confirms no contamination
        assert result.proof_bundle["contamination_attestation"]["contamination_detected"] is False
        assert result.proof_bundle["contamination_attestation"]["chain_head_before"] == chain_head_before
        assert result.proof_bundle["contamination_attestation"]["chain_head_after"] == chain_head_before
```

IMPORTANT:
- Import DeltaReport, ContaminationAttestation and helper functions from simulation module
- Test all SIM-04, SIM-05, SIM-06, SHD-03, SHD-06 requirements
- Verify determinism (SIM-06) with multiple runs
- Verify zero contamination (SHD-06) with attestation checks
  </action>
  <verify>
Run Phase 9 tests:
```bash
pytest tests/test_simulation.py -v --tb=short -k "Phase9 or DeltaReport or ContaminationAttestation or TagProofBundle or ComputeDelta or CreateContamination"
```

Run all simulation tests (including Phase 8):
```bash
pytest tests/test_simulation.py -v --tb=short
```

Run full test suite to check for regressions:
```bash
pytest --tb=short
```
  </verify>
  <done>Comprehensive tests added for all Phase 9 requirements: DeltaReport, ContaminationAttestation, compute_delta_report, tag_proof_bundle_origin, create_contamination_attestation, and Engine integration.</done>
</task>

</tasks>

<verification>
1. Engine.simulate_rfa() returns populated delta_report:
   `pytest tests/test_simulation.py::TestEngineSimulateRfaPhase9::test_simulate_rfa_returns_delta_report -v`

2. Proof bundle has tagged BASE and SHADOW:
   `pytest tests/test_simulation.py::TestEngineSimulateRfaPhase9::test_simulate_rfa_returns_proof_bundle_with_tagged_bundles -v`

3. Contamination attestation present:
   `pytest tests/test_simulation.py::TestEngineSimulateRfaPhase9::test_simulate_rfa_returns_contamination_attestation -v`

4. Deterministic output (SIM-06):
   `pytest tests/test_simulation.py::TestEngineSimulateRfaPhase9::test_simulate_rfa_deterministic_output -v`

5. Zero contamination verified (SHD-06):
   `pytest tests/test_simulation.py::TestEngineSimulateRfaPhase9::test_no_contamination_after_simulation -v`

6. All tests pass (no regressions):
   `pytest --tb=short`
</verification>

<success_criteria>
- [ ] Engine.simulate_rfa() returns SimulationResult with delta_report populated (SIM-04)
- [ ] proof_bundle contains tagged base and shadow bundles with origin field (SIM-05)
- [ ] proof_bundle contains contamination_attestation with all SHD-06 fields
- [ ] anchors field is empty dict (Phase 10 placeholder)
- [ ] Deterministic output verified - same inputs produce identical results (SIM-06)
- [ ] Zero contamination verified - chain head unchanged after simulation (SHD-06)
- [ ] All new tests pass (20+ Phase 9 tests)
- [ ] All existing tests pass (no regressions)
- [ ] tests/test_simulation.py has 700+ lines
</success_criteria>

<output>
After completion, create `.planning/phases/09-delta-report-proof/09-02-SUMMARY.md` using the summary template.
</output>
