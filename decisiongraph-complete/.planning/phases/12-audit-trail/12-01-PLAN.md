---
phase: 12-audit-trail
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/decisiongraph/simulation.py
  - tests/test_simulation_audit.py
autonomous: true

must_haves:
  truths:
    - "User can call simulation_result_to_audit_text(result) and receive human-readable report"
    - "Report shows BASE vs SHADOW comparison with delta analysis"
    - "RFA hash and simulation_spec hash recorded for auditability (AUD-02)"
    - "Same SimulationResult produces identical output (deterministic)"
  artifacts:
    - path: "src/decisiongraph/simulation.py"
      provides: "simulation_result_to_audit_text function"
      exports: ["simulation_result_to_audit_text"]
    - path: "tests/test_simulation_audit.py"
      provides: "Audit text tests"
      min_lines: 80
  key_links:
    - from: "simulation_result_to_audit_text"
      to: "SimulationResult"
      via: "function argument"
      pattern: "def simulation_result_to_audit_text\\(sim_result: SimulationResult\\)"
---

<objective>
Add human-readable audit report generation to SimulationResult (AUD-01, AUD-02).

Purpose: Enable compliance documentation, debugging simulations, and stakeholder reporting with deterministic human-readable output.

Output: `simulation_result_to_audit_text(sim_result)` function in simulation.py with comprehensive tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-audit-trail/12-RESEARCH.md

# Source files
@src/decisiongraph/simulation.py
@src/decisiongraph/scholar.py (lines 215-316 for to_audit_text pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add simulation_result_to_audit_text function</name>
  <files>src/decisiongraph/simulation.py</files>
  <action>
Add `simulation_result_to_audit_text(sim_result: SimulationResult) -> str` function to simulation.py.

Follow the EXACT pattern from QueryResult.to_audit_text() (scholar.py:215-316):
- Multi-line string built from `lines = []` with `lines.append()`
- Return `"\n".join(lines)`

**Report Sections (in order):**

1. **Header:**
```
SIMULATION AUDIT REPORT
==================================================
```

2. **Simulation Context:**
- Simulation ID (truncate to 16 chars + "...")
- RFA Hash: SHA-256 of canonical JSON (json.dumps with sort_keys=True, separators=(',', ':'))
- Simulation Spec Hash: SHA-256 of canonical JSON (AUD-02 requirement)
- Valid Time: sim_result.at_valid_time
- System Time: sim_result.as_of_system_time

3. **BASE Reality:**
- Facts Returned: count from base_result["results"]["fact_cell_ids"]
- Authorization: "ALLOWED" or "DENIED" from base_result["authorization_basis"]["allowed"]
- Fact Cells: list truncated cell IDs (16 chars + "...")

4. **SHADOW Reality:**
- Facts Returned: count
- Authorization: "ALLOWED" or "DENIED"
- Fact Cells: with "[SHADOW]" tag for cells not in base

5. **DELTA Analysis:**
- Verdict Changed: true/false (lowercase)
- Status Change: {status_before} -> {status_after}
- Score Delta: from delta_report
- Facts Diff: Added/Removed counts
- Rules Diff: Added/Removed counts

6. **Counterfactual Anchors:**
- Anchors Detected: count
- Minimal Changes: list of anchors
- [INCOMPLETE] banner if anchors_incomplete=True

7. **Contamination Attestation:**
- Chain Head Before: truncated
- Chain Head After: truncated
- Contamination Detected: true/false
- Attestation Hash: truncated

8. **Overlay Metadata (AUD-02):**
- Shadow Facts: count from simulation_spec
- Shadow Rules: count
- Shadow PolicyHeads: count
- Shadow Bridges: count

9. **Footer:**
- Schema Version: 1.6
- Generated: sim_result.as_of_system_time

**CRITICAL for AUD-02:** Compute and display:
- RFA hash: `hashlib.sha256(json.dumps(sim_result.rfa_dict, sort_keys=True, separators=(',', ':')).encode('utf-8')).hexdigest()`
- Simulation spec hash: `hashlib.sha256(json.dumps(sim_result.simulation_spec, sort_keys=True, separators=(',', ':')).encode('utf-8')).hexdigest()`

**Update __all__:** Add 'simulation_result_to_audit_text' to the exports list.
  </action>
  <verify>
```bash
cd /workspaces/Decisiongraph-core-v1.3/decisiongraph-complete && python -c "from decisiongraph.simulation import simulation_result_to_audit_text; print('Import OK')"
```
  </verify>
  <done>Function exists and is importable from simulation module.</done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for audit text</name>
  <files>tests/test_simulation_audit.py</files>
  <action>
Create `tests/test_simulation_audit.py` with comprehensive tests for `simulation_result_to_audit_text()`.

**Test Structure (follow test_simulation.py patterns):**

```python
"""Tests for simulation audit text generation (AUD-01, AUD-02)."""

import pytest
import json
import hashlib

from decisiongraph.simulation import (
    SimulationResult,
    DeltaReport,
    simulation_result_to_audit_text
)


# ============================================================================
# FIXTURES
# ============================================================================

@pytest.fixture
def sample_delta_report():
    """Delta report for testing."""
    return DeltaReport(
        verdict_changed=True,
        status_before="ALLOWED",
        status_after="ALLOWED",
        score_delta=0.0,
        facts_diff={"added": ["shadow_fact_123"], "removed": []},
        rules_diff={"added": [], "removed": []}
    )


@pytest.fixture
def sample_simulation_result(sample_delta_report):
    """SimulationResult for testing."""
    return SimulationResult(
        simulation_id="sim-abc123def456ghi789",
        rfa_dict={
            "namespace": "corp.hr",
            "requester_namespace": "corp.hr",
            "requester_id": "analyst:bob",
            "subject": "employee:alice"
        },
        simulation_spec={
            "shadow_facts": [
                {"base_cell_id": "base_fact_abc123", "object": "90000"}
            ],
            "shadow_rules": [],
            "shadow_policy_heads": [],
            "shadow_bridges": []
        },
        base_result={
            "results": {
                "fact_count": 2,
                "fact_cell_ids": ["fact_cell_111", "fact_cell_222"]
            },
            "authorization_basis": {"allowed": True}
        },
        shadow_result={
            "results": {
                "fact_count": 3,
                "fact_cell_ids": ["fact_cell_111", "fact_cell_222", "shadow_fact_123"]
            },
            "authorization_basis": {"allowed": True}
        },
        at_valid_time="2025-01-15T00:00:00Z",
        as_of_system_time="2025-01-15T00:00:00Z",
        delta_report=sample_delta_report,
        anchors={
            "anchors": ["shadow_fact:base_fact_abc123"],
            "anchors_incomplete": False,
            "attempts_used": 5,
            "runtime_ms": 100.0,
            "anchor_hash": "abc123"
        },
        proof_bundle={
            "base": {"origin": "BASE"},
            "shadow": {"origin": "SHADOW"},
            "contamination_attestation": {
                "chain_head_before": "chain_head_before_123456",
                "chain_head_after": "chain_head_before_123456",
                "attestation_hash": "attestation_hash_xyz789",
                "contamination_detected": False
            }
        }
    )


# ============================================================================
# TEST: AUDIT TEXT STRUCTURE (AUD-01)
# ============================================================================

class TestAuditTextStructure:
    """Tests for audit text structure and content."""

    def test_returns_string(self, sample_simulation_result):
        """to_audit_text returns string."""
        result = simulation_result_to_audit_text(sample_simulation_result)
        assert isinstance(result, str)

    def test_contains_header(self, sample_simulation_result):
        """Output contains SIMULATION AUDIT REPORT header."""
        result = simulation_result_to_audit_text(sample_simulation_result)
        assert "SIMULATION AUDIT REPORT" in result
        assert "=" * 50 in result

    def test_contains_simulation_context_section(self, sample_simulation_result):
        """Output contains Simulation Context section."""
        result = simulation_result_to_audit_text(sample_simulation_result)
        assert "Simulation Context:" in result
        assert "Simulation ID:" in result
        assert "sim-abc123def456" in result  # Truncated ID

    def test_contains_base_reality_section(self, sample_simulation_result):
        """Output contains BASE Reality section."""
        result = simulation_result_to_audit_text(sample_simulation_result)
        assert "BASE Reality:" in result
        assert "Facts Returned: 2" in result
        assert "Authorization: ALLOWED" in result

    def test_contains_shadow_reality_section(self, sample_simulation_result):
        """Output contains SHADOW Reality section."""
        result = simulation_result_to_audit_text(sample_simulation_result)
        assert "SHADOW Reality:" in result
        assert "Facts Returned: 3" in result

    def test_contains_delta_analysis_section(self, sample_simulation_result):
        """Output contains DELTA Analysis section."""
        result = simulation_result_to_audit_text(sample_simulation_result)
        assert "DELTA Analysis:" in result
        assert "Verdict Changed:" in result
        assert "Status Change:" in result

    def test_contains_anchors_section(self, sample_simulation_result):
        """Output contains Counterfactual Anchors section."""
        result = simulation_result_to_audit_text(sample_simulation_result)
        assert "Counterfactual Anchors:" in result
        assert "Anchors Detected:" in result

    def test_contains_attestation_section(self, sample_simulation_result):
        """Output contains Contamination Attestation section."""
        result = simulation_result_to_audit_text(sample_simulation_result)
        assert "Contamination Attestation:" in result
        assert "Chain Head Before:" in result
        assert "Contamination Detected:" in result

    def test_contains_overlay_metadata_section(self, sample_simulation_result):
        """Output contains Overlay Metadata section (AUD-02)."""
        result = simulation_result_to_audit_text(sample_simulation_result)
        assert "Overlay Metadata:" in result
        assert "Shadow Facts:" in result

    def test_contains_schema_version(self, sample_simulation_result):
        """Output contains Schema Version 1.6."""
        result = simulation_result_to_audit_text(sample_simulation_result)
        assert "Schema Version: 1.6" in result


# ============================================================================
# TEST: RFA AND SIMULATION SPEC HASHES (AUD-02)
# ============================================================================

class TestAuditHashes:
    """Tests for RFA hash and simulation_spec hash (AUD-02)."""

    def test_contains_rfa_hash(self, sample_simulation_result):
        """Output contains RFA Hash (AUD-02)."""
        result = simulation_result_to_audit_text(sample_simulation_result)
        assert "RFA Hash:" in result

    def test_rfa_hash_is_sha256(self, sample_simulation_result):
        """RFA hash is computed correctly using SHA-256."""
        result = simulation_result_to_audit_text(sample_simulation_result)

        # Compute expected hash
        rfa_canonical = json.dumps(
            sample_simulation_result.rfa_dict,
            sort_keys=True,
            separators=(',', ':')
        )
        expected_hash = hashlib.sha256(rfa_canonical.encode('utf-8')).hexdigest()

        # Check truncated hash appears
        assert expected_hash[:16] in result

    def test_contains_simulation_spec_hash(self, sample_simulation_result):
        """Output contains Simulation Spec Hash (AUD-02)."""
        result = simulation_result_to_audit_text(sample_simulation_result)
        assert "Simulation Spec Hash:" in result

    def test_simulation_spec_hash_is_sha256(self, sample_simulation_result):
        """Simulation spec hash is computed correctly using SHA-256."""
        result = simulation_result_to_audit_text(sample_simulation_result)

        # Compute expected hash
        spec_canonical = json.dumps(
            sample_simulation_result.simulation_spec,
            sort_keys=True,
            separators=(',', ':')
        )
        expected_hash = hashlib.sha256(spec_canonical.encode('utf-8')).hexdigest()

        # Check truncated hash appears
        assert expected_hash[:16] in result


# ============================================================================
# TEST: DETERMINISM (SIM-06)
# ============================================================================

class TestAuditTextDeterminism:
    """Tests for deterministic output."""

    def test_same_input_same_output(self, sample_simulation_result):
        """Same SimulationResult produces identical output."""
        result1 = simulation_result_to_audit_text(sample_simulation_result)
        result2 = simulation_result_to_audit_text(sample_simulation_result)
        assert result1 == result2

    def test_deterministic_across_multiple_calls(self, sample_simulation_result):
        """Output is deterministic across 10 calls."""
        results = [simulation_result_to_audit_text(sample_simulation_result) for _ in range(10)]
        assert all(r == results[0] for r in results)


# ============================================================================
# TEST: EDGE CASES
# ============================================================================

class TestAuditTextEdgeCases:
    """Tests for edge cases."""

    def test_empty_anchors(self, sample_simulation_result):
        """Handles empty anchors gracefully."""
        result = SimulationResult(
            simulation_id="sim-empty",
            rfa_dict={"namespace": "test", "requester_namespace": "test", "requester_id": "user"},
            simulation_spec={"shadow_facts": []},
            base_result={"results": {"fact_count": 0, "fact_cell_ids": []}, "authorization_basis": {"allowed": True}},
            shadow_result={"results": {"fact_count": 0, "fact_cell_ids": []}, "authorization_basis": {"allowed": True}},
            at_valid_time="2025-01-01T00:00:00Z",
            as_of_system_time="2025-01-01T00:00:00Z",
            delta_report=DeltaReport(
                verdict_changed=False,
                status_before="ALLOWED",
                status_after="ALLOWED",
                score_delta=0.0,
                facts_diff={"added": [], "removed": []},
                rules_diff={"added": [], "removed": []}
            ),
            anchors={"anchors": [], "anchors_incomplete": False},
            proof_bundle={
                "contamination_attestation": {
                    "chain_head_before": "head123",
                    "chain_head_after": "head123",
                    "attestation_hash": "hash456",
                    "contamination_detected": False
                }
            }
        )
        text = simulation_result_to_audit_text(result)
        assert "Anchors Detected: 0" in text

    def test_anchors_incomplete_shows_warning(self):
        """Shows INCOMPLETE warning when anchors_incomplete=True."""
        result = SimulationResult(
            simulation_id="sim-incomplete",
            rfa_dict={"namespace": "test", "requester_namespace": "test", "requester_id": "user"},
            simulation_spec={"shadow_facts": []},
            base_result={"results": {"fact_count": 0, "fact_cell_ids": []}, "authorization_basis": {"allowed": True}},
            shadow_result={"results": {"fact_count": 1, "fact_cell_ids": ["new"]}, "authorization_basis": {"allowed": True}},
            at_valid_time="2025-01-01T00:00:00Z",
            as_of_system_time="2025-01-01T00:00:00Z",
            delta_report=DeltaReport(
                verdict_changed=True,
                status_before="ALLOWED",
                status_after="ALLOWED",
                score_delta=0.0,
                facts_diff={"added": ["new"], "removed": []},
                rules_diff={"added": [], "removed": []}
            ),
            anchors={"anchors": ["partial"], "anchors_incomplete": True},
            proof_bundle={
                "contamination_attestation": {
                    "chain_head_before": "head123",
                    "chain_head_after": "head123",
                    "attestation_hash": "hash456",
                    "contamination_detected": False
                }
            }
        )
        text = simulation_result_to_audit_text(result)
        assert "INCOMPLETE" in text

    def test_denied_authorization(self):
        """Handles DENIED authorization correctly."""
        result = SimulationResult(
            simulation_id="sim-denied",
            rfa_dict={"namespace": "test", "requester_namespace": "test", "requester_id": "user"},
            simulation_spec={"shadow_facts": []},
            base_result={"results": {"fact_count": 0, "fact_cell_ids": []}, "authorization_basis": {"allowed": False}},
            shadow_result={"results": {"fact_count": 0, "fact_cell_ids": []}, "authorization_basis": {"allowed": False}},
            at_valid_time="2025-01-01T00:00:00Z",
            as_of_system_time="2025-01-01T00:00:00Z",
            delta_report=DeltaReport(
                verdict_changed=False,
                status_before="DENIED",
                status_after="DENIED",
                score_delta=0.0,
                facts_diff={"added": [], "removed": []},
                rules_diff={"added": [], "removed": []}
            ),
            anchors={"anchors": [], "anchors_incomplete": False},
            proof_bundle={
                "contamination_attestation": {
                    "chain_head_before": "head123",
                    "chain_head_after": "head123",
                    "attestation_hash": "hash456",
                    "contamination_detected": False
                }
            }
        )
        text = simulation_result_to_audit_text(result)
        assert "Authorization: DENIED" in text
```
  </action>
  <verify>
```bash
cd /workspaces/Decisiongraph-core-v1.3/decisiongraph-complete && python -m pytest tests/test_simulation_audit.py -v
```
  </verify>
  <done>All 17+ tests pass, covering structure, hashes, determinism, and edge cases.</done>
</task>

</tasks>

<verification>
1. Function exists: `python -c "from decisiongraph.simulation import simulation_result_to_audit_text"`
2. All tests pass: `pytest tests/test_simulation_audit.py -v`
3. No regressions: `pytest tests/ -v` (all 892+ tests pass)
4. Determinism: Same SimulationResult produces identical output
5. AUD-02 satisfied: RFA hash and simulation_spec hash displayed in report
</verification>

<success_criteria>
- [ ] simulation_result_to_audit_text() function added to simulation.py
- [ ] Function exported in __all__
- [ ] Report contains all 9 sections in correct order
- [ ] RFA hash computed via SHA-256 of canonical JSON (AUD-02)
- [ ] Simulation spec hash computed via SHA-256 of canonical JSON (AUD-02)
- [ ] Cell IDs truncated to 16 chars (matching existing pattern)
- [ ] Output is deterministic (same input = same output)
- [ ] All tests pass (17+ new tests)
- [ ] No regressions (all existing tests pass)
</success_criteria>

<output>
After completion, create `.planning/phases/12-audit-trail/12-01-SUMMARY.md`
</output>
