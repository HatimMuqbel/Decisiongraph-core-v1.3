---
phase: 02-witnessset-registry
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/decisiongraph/registry.py
  - src/decisiongraph/__init__.py
  - tests/test_registry.py
autonomous: true

must_haves:
  truths:
    - "User can query WitnessSet for a namespace via WitnessRegistry"
    - "Registry extracts initial WitnessSet from Genesis cell"
    - "Registry returns None for namespace without WitnessSet"
    - "Registry rebuilds from Chain state (stateless, no in-memory cache)"
    - "get_all_witness_sets returns all configured namespaces"
  artifacts:
    - path: "src/decisiongraph/registry.py"
      provides: "WitnessRegistry stateless query layer"
      exports: ["WitnessRegistry"]
      min_lines: 80
    - path: "tests/test_registry.py"
      provides: "WitnessRegistry tests including Genesis extraction"
      min_lines: 120
  key_links:
    - from: "src/decisiongraph/registry.py"
      to: "src/decisiongraph/witnessset.py"
      via: "WitnessSet import"
      pattern: "from \\.witnessset import WitnessSet"
    - from: "src/decisiongraph/registry.py"
      to: "src/decisiongraph/genesis.py"
      via: "parse_genesis_witness_set import"
      pattern: "from \\.genesis import.*parse_genesis_witness_set"
    - from: "src/decisiongraph/registry.py"
      to: "src/decisiongraph/chain.py"
      via: "Chain type hint"
      pattern: "TYPE_CHECKING.*Chain"
    - from: "src/decisiongraph/__init__.py"
      to: "src/decisiongraph/registry.py"
      via: "WitnessRegistry export"
      pattern: "from \\.registry import"
---

<objective>
Create WitnessRegistry as a stateless query layer for namespace to WitnessSet lookups.

Purpose: WitnessRegistry provides the runtime lookup mechanism for determining which witnesses control a namespace. It extracts the initial WitnessSet from Genesis and provides foundation for WitnessSet change tracking (WIT-04).

Output: WitnessRegistry class that queries Chain state and comprehensive test coverage including Genesis WitnessSet extraction.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-witnessset-registry/02-RESEARCH.md
@.planning/phases/02-witnessset-registry/02-01-SUMMARY.md (if exists)
@src/decisiongraph/witnessset.py (WitnessSet from Plan 01)
@src/decisiongraph/genesis.py (parse_genesis_witness_set, has_witness_set)
@src/decisiongraph/chain.py (Chain class)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WitnessRegistry stateless query layer</name>
  <files>src/decisiongraph/registry.py</files>
  <action>
Create `src/decisiongraph/registry.py` with stateless registry implementation:

1. **Imports:**
   - `typing.Optional, TYPE_CHECKING` for type hints
   - `WitnessSet` from `.witnessset`
   - `parse_genesis_witness_set, has_witness_set` from `.genesis`
   - Chain via TYPE_CHECKING to avoid circular import

2. **WitnessRegistry class:**
   ```python
   class WitnessRegistry:
       """
       Stateless registry for namespace -> WitnessSet lookups.

       Rebuilds registry from Chain state on each query.
       Chain is the source of truth - no in-memory caching.

       This ensures registry state never diverges from chain state,
       maintaining the append-only guarantee.
       """

       def __init__(self, chain: 'Chain'):
           """Bind registry to a Chain instance."""
           self.chain = chain

       def get_witness_set(self, namespace: str) -> Optional[WitnessSet]:
           """
           Get current WitnessSet for a namespace.

           Args:
               namespace: Namespace to query (e.g., "corp", "corp.hr")

           Returns:
               Current WitnessSet or None if namespace has no WitnessSet

           Example:
               >>> registry = WitnessRegistry(chain)
               >>> ws = registry.get_witness_set("corp")
               >>> if ws:
               ...     print(f"Threshold: {ws.threshold}/{len(ws.witnesses)}")
           """
           registry = self._build_registry()
           return registry.get(namespace)

       def get_all_witness_sets(self) -> dict[str, WitnessSet]:
           """
           Get all configured WitnessSets.

           Returns:
               Dict mapping namespace to WitnessSet for all namespaces
               that have a WitnessSet configured.
           """
           return self._build_registry()

       def has_witness_set(self, namespace: str) -> bool:
           """
           Check if namespace has a WitnessSet configured.

           Args:
               namespace: Namespace to check

           Returns:
               True if namespace has a WitnessSet
           """
           return self.get_witness_set(namespace) is not None

       def _build_registry(self) -> dict[str, WitnessSet]:
           """
           Build namespace -> WitnessSet mapping from Chain state.

           Process:
           1. Extract Genesis WitnessSet (initial trust anchor)
           2. Process WitnessSet update cells in temporal order (future)
           3. Latest update per namespace wins

           Returns:
               Dict mapping namespace to current WitnessSet
           """
           registry: dict[str, WitnessSet] = {}

           # 1. Extract Genesis WitnessSet (bootstrap - WIT-03)
           genesis = self.chain.genesis
           if genesis and has_witness_set(genesis):
               ws_data = parse_genesis_witness_set(genesis)
               root_ns = genesis.fact.namespace
               registry[root_ns] = WitnessSet(
                   namespace=root_ns,
                   witnesses=tuple(sorted(ws_data['witnesses'])),  # Deterministic order
                   threshold=ws_data['threshold']
               )

           # 2. WitnessSet update cells (WIT-04 foundation)
           # Future: Scan chain for CellType.WITNESS_SET_UPDATE
           # Latest update per namespace overwrites previous
           # This is the extension point for Phase 4 Promotion Workflow

           return registry
   ```

3. **Module docstring explaining:**
   - Stateless design (no caching)
   - Chain is source of truth
   - Genesis extraction for bootstrap WitnessSet
   - Extension point for WitnessSet changes

4. **`__all__` export list**

**Why stateless:** Prevents cache/chain divergence. Chain handles append-only semantics. If caching needed, caller can cache explicitly.

**Deterministic sort:** Same witnesses = same WitnessSet regardless of order in Genesis.
  </action>
  <verify>
```bash
cd /workspaces/Decisiongraph-core-v1.3/decisiongraph-complete
python -c "
from src.decisiongraph import create_chain
from src.decisiongraph.genesis import create_genesis_cell_with_witness_set
from src.decisiongraph.registry import WitnessRegistry

# Create chain with Genesis that has WitnessSet
genesis = create_genesis_cell_with_witness_set(
    graph_name='TestGraph',
    root_namespace='corp',
    witnesses=['alice', 'bob'],
    threshold=2,
    system_time='2026-01-28T00:00:00Z'
)
chain = create_chain(genesis)

# Query registry
registry = WitnessRegistry(chain)
ws = registry.get_witness_set('corp')
print(f'Found: {ws.threshold}-of-{len(ws.witnesses)} for {ws.namespace}')
"
```
Should print: "Found: 2-of-2 for corp"
  </verify>
  <done>
WitnessRegistry class exists, extracts Genesis WitnessSet, returns None for unknown namespaces.
  </done>
</task>

<task type="auto">
  <name>Task 2: Export WitnessRegistry from package</name>
  <files>src/decisiongraph/__init__.py</files>
  <action>
Update `src/decisiongraph/__init__.py` to export WitnessRegistry:

1. Add import after WitnessSet import:
   ```python
   # WitnessRegistry (v1.5)
   from .registry import WitnessRegistry
   ```

2. Add 'WitnessRegistry' to `__all__` list after WitnessSet.

Follow existing module structure - group with Phase 2 additions.
  </action>
  <verify>
```bash
cd /workspaces/Decisiongraph-core-v1.3/decisiongraph-complete
python -c "from src.decisiongraph import WitnessRegistry; print('WitnessRegistry exported')"
```
Should print "WitnessRegistry exported"
  </verify>
  <done>
WitnessRegistry importable from package root.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive WitnessRegistry tests</name>
  <files>tests/test_registry.py</files>
  <action>
Create `tests/test_registry.py` with comprehensive test coverage:

**Test Classes:**

1. **TestRegistryCreation**:
   - test_create_registry_with_chain - basic construction
   - test_registry_bound_to_chain - verify chain stored

2. **TestGenesisWitnessSetExtraction** (WIT-03):
   - test_extracts_witness_set_from_genesis - Genesis with WitnessSet
   - test_returns_none_for_legacy_genesis - Genesis without WitnessSet
   - test_extracts_correct_namespace - root namespace matches
   - test_extracts_correct_witnesses - witness list matches
   - test_extracts_correct_threshold - threshold matches
   - test_witnesses_sorted_deterministically - order preserved

3. **TestRegistryQueries**:
   - test_get_witness_set_returns_witnessset - valid namespace
   - test_get_witness_set_returns_none_for_unknown - unknown namespace
   - test_get_all_witness_sets_returns_dict - all configured
   - test_has_witness_set_returns_true - configured namespace
   - test_has_witness_set_returns_false - unconfigured namespace

4. **TestRegistryStateless**:
   - test_rebuilds_from_chain_each_query - stateless behavior
   - test_no_cached_state - no internal cache attribute

5. **TestRegistryWithEmptyChain**:
   - test_legacy_genesis_no_witnessset - returns empty dict
   - test_get_witness_set_on_empty_registry - returns None

6. **TestRegistryIntegration**:
   - test_witnessset_usable_after_extraction - can use extracted WitnessSet
   - test_multiple_queries_same_result - deterministic

**Fixtures:**
- `chain_with_witnessset` - Chain with Genesis that has WitnessSet (2-of-3)
- `chain_without_witnessset` - Chain with legacy Genesis (no WitnessSet)
- `registry` - WitnessRegistry bound to chain_with_witnessset
  </action>
  <verify>
```bash
cd /workspaces/Decisiongraph-core-v1.3/decisiongraph-complete
python -m pytest tests/test_registry.py -v --tb=short
```
All tests should pass.
  </verify>
  <done>
All WitnessRegistry tests pass. Coverage includes Genesis extraction (WIT-03), queries, stateless behavior.
  </done>
</task>

</tasks>

<verification>
1. **Registry extracts Genesis WitnessSet:**
   ```bash
   python -c "
   from src.decisiongraph import create_chain, WitnessRegistry
   from src.decisiongraph.genesis import create_genesis_cell_with_witness_set

   genesis = create_genesis_cell_with_witness_set(
       graph_name='Test', root_namespace='corp',
       witnesses=['alice', 'bob', 'charlie'], threshold=2,
       system_time='2026-01-28T00:00:00Z'
   )
   chain = create_chain(genesis)
   registry = WitnessRegistry(chain)
   ws = registry.get_witness_set('corp')
   print(f'Extracted: {ws.threshold}-of-{len(ws.witnesses)}')
   "
   ```
   Expected: "Extracted: 2-of-3"

2. **Returns None for unknown namespace:**
   ```bash
   python -c "
   from src.decisiongraph import create_chain, WitnessRegistry
   from src.decisiongraph.genesis import create_genesis_cell_with_witness_set

   genesis = create_genesis_cell_with_witness_set(
       graph_name='Test', root_namespace='corp',
       witnesses=['alice'], threshold=1,
       system_time='2026-01-28T00:00:00Z'
   )
   chain = create_chain(genesis)
   registry = WitnessRegistry(chain)
   ws = registry.get_witness_set('unknown.namespace')
   print(f'Result: {ws}')
   "
   ```
   Expected: "Result: None"

3. **All registry tests pass:**
   ```bash
   python -m pytest tests/test_registry.py -v
   ```

4. **No regressions:**
   ```bash
   python -m pytest tests/ -v --tb=short
   ```
   Expected: 640+ tests pass (618 existing + ~22 new)
</verification>

<success_criteria>
1. WitnessRegistry class exists in src/decisiongraph/registry.py
2. Registry extracts WitnessSet from Genesis (WIT-03 runtime)
3. Registry returns None for namespace without WitnessSet
4. Registry is stateless (rebuilds from Chain each query)
5. WitnessRegistry exported from package root
6. All tests pass (new + existing)
7. WIT-03 and WIT-04 foundation complete (WIT-04 promotion tracked in Phase 4)
</success_criteria>

<output>
After completion, create `.planning/phases/02-witnessset-registry/02-02-SUMMARY.md`
</output>
