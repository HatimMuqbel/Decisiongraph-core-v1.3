---
phase: 02-witnessset-registry
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/decisiongraph/witnessset.py
  - src/decisiongraph/__init__.py
  - tests/test_witnessset.py
autonomous: true

must_haves:
  truths:
    - "User can create WitnessSet with namespace, witnesses, and threshold"
    - "WitnessSet rejects invalid threshold (0, negative, > witness count)"
    - "WitnessSet rejects invalid namespace format"
    - "WitnessSet is immutable (frozen dataclass)"
    - "WitnessSet witnesses stored as tuple (not mutable list)"
  artifacts:
    - path: "src/decisiongraph/witnessset.py"
      provides: "WitnessSet frozen dataclass with validation"
      exports: ["WitnessSet"]
      min_lines: 50
    - path: "tests/test_witnessset.py"
      provides: "WitnessSet validation and immutability tests"
      min_lines: 100
  key_links:
    - from: "src/decisiongraph/witnessset.py"
      to: "src/decisiongraph/policyhead.py"
      via: "validate_threshold import"
      pattern: "from \\.policyhead import validate_threshold"
    - from: "src/decisiongraph/witnessset.py"
      to: "src/decisiongraph/exceptions.py"
      via: "InputInvalidError import"
      pattern: "from \\.exceptions import InputInvalidError"
    - from: "src/decisiongraph/__init__.py"
      to: "src/decisiongraph/witnessset.py"
      via: "WitnessSet export"
      pattern: "from \\.witnessset import"
---

<objective>
Create the WitnessSet frozen dataclass with comprehensive validation.

Purpose: WitnessSet defines the witness configuration for a namespace - who can approve promotions and how many approvals are needed. This is the core data structure for Phase 2.

Output: Immutable WitnessSet dataclass that validates on construction and comprehensive test coverage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-witnessset-registry/02-RESEARCH.md
@src/decisiongraph/policyhead.py (validate_threshold function)
@src/decisiongraph/exceptions.py (InputInvalidError)
@src/decisiongraph/cell.py (validate_namespace function)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WitnessSet frozen dataclass</name>
  <files>src/decisiongraph/witnessset.py</files>
  <action>
Create `src/decisiongraph/witnessset.py` with the following implementation:

1. **Imports:**
   - `dataclasses.dataclass` for frozen dataclass
   - `validate_threshold` from `.policyhead` (reuse existing validation)
   - `validate_namespace` from `.cell` (reuse existing validation)
   - `InputInvalidError` from `.exceptions` (standard DG_INPUT_INVALID)

2. **WitnessSet class:**
   - `@dataclass(frozen=True, kw_only=True)` decorator
   - Fields:
     - `namespace: str` - target namespace (hierarchical, e.g., "corp.hr")
     - `witnesses: tuple[str, ...]` - tuple (NOT list) of witness identifiers
     - `threshold: int` - number of approvals required
   - `__post_init__` method with explicit boolean checks:
     ```python
     def __post_init__(self):
         # Threshold validation - check boolean return explicitly
         is_valid, error_msg = validate_threshold(self.threshold, list(self.witnesses))
         if not is_valid:
             raise InputInvalidError(error_msg)

         # Namespace validation - check boolean return explicitly
         is_valid, error_msg = validate_namespace(self.namespace)
         if not is_valid:
             raise InputInvalidError(error_msg)
     ```

3. **Module docstring explaining:**
   - WitnessSet is immutable (frozen=True)
   - Witnesses as tuple ensures deep immutability
   - Validation reuses Phase 1 functions
   - Used by WitnessRegistry for namespace lookups

4. **`__all__` export list with WitnessSet**

**Why frozen=True:** Prevents accidental mutation, makes WitnessSet hashable, thread-safe by design.

**Why tuple not list:** Frozen dataclass only prevents field reassignment, not mutation of mutable field values. Tuple is immutable.
  </action>
  <verify>
```bash
cd /workspaces/Decisiongraph-core-v1.3/decisiongraph-complete
python -c "from src.decisiongraph.witnessset import WitnessSet; ws = WitnessSet(namespace='corp', witnesses=('alice', 'bob'), threshold=2); print(f'Created: {ws}')"
```
Should print WitnessSet with namespace='corp', witnesses=('alice', 'bob'), threshold=2
  </verify>
  <done>
WitnessSet class exists, is frozen, validates on construction, witnesses stored as tuple.
  </done>
</task>

<task type="auto">
  <name>Task 2: Export WitnessSet from package</name>
  <files>src/decisiongraph/__init__.py</files>
  <action>
Update `src/decisiongraph/__init__.py` to export WitnessSet:

1. Add import at appropriate location (after policyhead imports):
   ```python
   # WitnessSet (v1.5)
   from .witnessset import WitnessSet
   ```

2. Add 'WitnessSet' to `__all__` list in the appropriate section (after PolicyHead exports).

Follow existing module structure - group with Phase 2 additions.
  </action>
  <verify>
```bash
cd /workspaces/Decisiongraph-core-v1.3/decisiongraph-complete
python -c "from src.decisiongraph import WitnessSet; print('WitnessSet exported')"
```
Should print "WitnessSet exported"
  </verify>
  <done>
WitnessSet importable from package root (`from decisiongraph import WitnessSet`).
  </done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive WitnessSet tests</name>
  <files>tests/test_witnessset.py</files>
  <action>
Create `tests/test_witnessset.py` with comprehensive test coverage:

**Test Classes:**

1. **TestWitnessSetCreation** (WIT-01):
   - test_create_valid_witnessset - basic creation
   - test_create_with_single_witness - bootstrap mode (1-of-1)
   - test_create_with_multiple_witnesses - 2-of-3 scenario
   - test_witnesses_stored_as_tuple - verify tuple type
   - test_namespace_preserved - verify namespace stored

2. **TestWitnessSetValidation** (WIT-02):
   - test_rejects_threshold_zero - threshold=0 raises InputInvalidError
   - test_rejects_negative_threshold - threshold=-1 raises InputInvalidError
   - test_rejects_threshold_exceeds_witnesses - threshold=3 with 2 witnesses
   - test_rejects_empty_witnesses - [] raises InputInvalidError
   - test_rejects_invalid_namespace - "INVALID" raises InputInvalidError
   - test_rejects_namespace_with_trailing_dot - "corp." raises InputInvalidError
   - test_error_code_is_dg_input_invalid - verify error.code == "DG_INPUT_INVALID"

3. **TestWitnessSetImmutability**:
   - test_cannot_modify_namespace - FrozenInstanceError on assignment
   - test_cannot_modify_threshold - FrozenInstanceError on assignment
   - test_cannot_modify_witnesses - FrozenInstanceError on assignment
   - test_witnesses_tuple_prevents_append - AttributeError on .append()

4. **TestWitnessSetEquality**:
   - test_equal_witnesssets_are_equal - same values = equal
   - test_different_namespaces_not_equal - diff namespace = not equal
   - test_different_witnesses_not_equal - diff witnesses = not equal
   - test_different_thresholds_not_equal - diff threshold = not equal

5. **TestWitnessSetHashable**:
   - test_witnessset_is_hashable - can call hash()
   - test_can_use_in_set - can add to set
   - test_equal_witnesssets_same_hash - equal WitnessSets have same hash

**Use pytest fixtures for common test data. Import InputInvalidError from exceptions.py for error type checking.**
  </action>
  <verify>
```bash
cd /workspaces/Decisiongraph-core-v1.3/decisiongraph-complete
python -m pytest tests/test_witnessset.py -v --tb=short
```
All tests should pass.
  </verify>
  <done>
All WitnessSet tests pass. Coverage includes creation, validation (WIT-01, WIT-02), immutability, equality, and hashability.
  </done>
</task>

</tasks>

<verification>
1. **WitnessSet creation works:**
   ```bash
   python -c "from src.decisiongraph import WitnessSet; ws = WitnessSet(namespace='corp.hr', witnesses=('alice', 'bob', 'charlie'), threshold=2); print(f'{ws.threshold}-of-{len(ws.witnesses)}')"
   ```
   Expected: "2-of-3"

2. **Invalid threshold rejected:**
   ```bash
   python -c "from src.decisiongraph import WitnessSet; WitnessSet(namespace='corp', witnesses=('alice',), threshold=5)"
   ```
   Expected: InputInvalidError with DG_INPUT_INVALID

3. **Immutability enforced:**
   ```bash
   python -c "from src.decisiongraph import WitnessSet; ws = WitnessSet(namespace='corp', witnesses=('alice',), threshold=1); ws.threshold = 2"
   ```
   Expected: FrozenInstanceError

4. **All tests pass:**
   ```bash
   python -m pytest tests/test_witnessset.py -v
   ```

5. **No regressions:**
   ```bash
   python -m pytest tests/ -v --tb=short
   ```
   Expected: 618+ tests pass (existing + new)
</verification>

<success_criteria>
1. WitnessSet class exists in src/decisiongraph/witnessset.py
2. WitnessSet is frozen dataclass with tuple witnesses
3. WitnessSet validates threshold via existing validate_threshold()
4. WitnessSet validates namespace via existing validate_namespace()
5. WitnessSet raises InputInvalidError (DG_INPUT_INVALID) on invalid input
6. WitnessSet exported from package root
7. All tests pass (new + existing)
8. WIT-01 and WIT-02 requirements complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-witnessset-registry/02-01-SUMMARY.md`
</output>
